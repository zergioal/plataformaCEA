
----------------------------------------------------------------------------------------- 
// package.json
----------------------------------------------------------------------------------------- 
{
  "name": "web",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.89.0",
    "jspdf": "^4.0.0",
    "jspdf-autotable": "^5.0.7",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.11.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.23",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "supabase": "^2.70.5",
    "tailwindcss": "^3.4.17",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}


----------------------------------------------------------------------------------------- 
// vite.config.ts
----------------------------------------------------------------------------------------- 
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


----------------------------------------------------------------------------------------- 
// tsconfig.json
----------------------------------------------------------------------------------------- 
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}


----------------------------------------------------------------------------------------- 
// tsconfig.app.json
----------------------------------------------------------------------------------------- 
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}


----------------------------------------------------------------------------------------- 
// tsconfig.node.json
----------------------------------------------------------------------------------------- 
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}


----------------------------------------------------------------------------------------- 
// eslint.config.js
----------------------------------------------------------------------------------------- 
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])


----------------------------------------------------------------------------------------- 
// .env
----------------------------------------------------------------------------------------- 
VITE_SUPABASE_URL=https://fkbtmqgqwthruxuyfcor.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrYnRtcWdxd3RocnV4dXlmY29yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNTMyNTEsImV4cCI6MjA4MjYyOTI1MX0.McCoY2bKHtl3pwF528iTVvioipwi6Kvc42cLIOCYRrY

----------------------------------------------------------------------------------------- 
// index.html
----------------------------------------------------------------------------------------- 
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CEA MADRE MAR√çA OLIVA</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>


----------------------------------------------------------------------------------------- 
// postcss.config.js
----------------------------------------------------------------------------------------- 
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}


----------------------------------------------------------------------------------------- 
// tailwind.config.js
----------------------------------------------------------------------------------------- 
/** @type {import('tailwindcss').Config} */
export default {
  content: ["./index.html", "./src/**/*.{js,ts,jsx,tsx}"],
  theme: { extend: {} },
  plugins: [],
};


----------------------------------------------------------------------------------------- 
// README.md
----------------------------------------------------------------------------------------- 
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```


----------------------------------------------------------------------------------------- 
// src\App.css
----------------------------------------------------------------------------------------- 
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


----------------------------------------------------------------------------------------- 
// src\App.tsx
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/App.tsx
import { BrowserRouter, Route, Routes } from "react-router-dom";
import AppRedirect from "./components/AppRedirect";
import ProtectedRoute from "./components/ProtectedRoute";
import RequireRole from "./components/RequireRole";

import Login from "./pages/Login";
import AdminDashboard from "./pages/AdminDashboard";
import AdminContentManager from "./pages/AdminContentManager";
import TeacherDashboard from "./pages/TeacherDashboard";
import TeacherModuleGrades from "./pages/TeacherModuleGrades";
import StudentDashboard from "./pages/StudentDashboard";
import StudentModule from "./pages/StudentModule";

export default function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/login" element={<Login />} />

        <Route
          path="/app"
          element={
            <ProtectedRoute>
              <AppRedirect />
            </ProtectedRoute>
          }
        />

        {/* ADMIN */}
        <Route
          path="/admin"
          element={
            <ProtectedRoute>
              <RequireRole allow={["admin"]}>
                <AdminDashboard />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        <Route
          path="/admin/content"
          element={
            <ProtectedRoute>
              <RequireRole allow={["admin"]}>
                <AdminContentManager />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        {/* TEACHER */}
        <Route
          path="/teacher"
          element={
            <ProtectedRoute>
              <RequireRole allow={["teacher", "admin"]}>
                <TeacherDashboard />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        <Route
          path="/teacher/module/:moduleId/grades"
          element={
            <ProtectedRoute>
              <RequireRole allow={["teacher", "admin"]}>
                <TeacherModuleGrades />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        {/* STUDENT */}
        <Route
          path="/student"
          element={
            <ProtectedRoute>
              <RequireRole allow={["student"]}>
                <StudentDashboard />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        <Route
          path="/student/module/:moduleId"
          element={
            <ProtectedRoute>
              <RequireRole allow={["student"]}>
                <StudentModule />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        {/* FALLBACK */}
        <Route path="*" element={<Login />} />
      </Routes>
    </BrowserRouter>
  );
}


----------------------------------------------------------------------------------------- 
// src\index.css
----------------------------------------------------------------------------------------- 
/* cea-plataforma/web/src/index.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    /* Colores principales CEA */
    --cea-primary: #013658;
    --cea-primary-dark: #001f3d;
    --cea-primary-light: #024a7a;
    --cea-accent: #0088cc;
    --cea-accent-light: #33a3d9;

    /* Grises minimalistas */
    --cea-gray-50: #f8fafc;
    --cea-gray-100: #f1f5f9;
    --cea-gray-200: #e2e8f0;
    --cea-gray-300: #cbd5e1;
    --cea-gray-400: #94a3b8;
    --cea-gray-500: #64748b;
    --cea-gray-600: #475569;
    --cea-gray-700: #334155;
    --cea-gray-800: #1e293b;
    --cea-gray-900: #0f172a;

    /* Estados */
    --cea-success: #10b981;
    --cea-warning: #f59e0b;
    --cea-error: #ef4444;
    --cea-info: #3b82f6;

    /* Sombras minimalistas */
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
  }

  * {
    @apply border-gray-200;
  }

  body {
    @apply bg-gray-50 text-gray-900 antialiased;
    font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
      system-ui, sans-serif;
  }

  /* Scrollbar minimalista */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    @apply bg-gray-100;
  }

  ::-webkit-scrollbar-thumb {
    @apply bg-gray-300 rounded-full;
  }

  ::-webkit-scrollbar-thumb:hover {
    @apply bg-gray-400;
  }
}

@layer components {
  /* Botones CEA */
  .btn-primary {
    @apply px-4 py-2 rounded-lg font-medium text-white transition-all;
    background-color: var(--cea-primary);
  }

  .btn-primary:hover:not(:disabled) {
    background-color: var(--cea-primary-light);
  }

  .btn-primary:active:not(:disabled) {
    @apply scale-[0.98];
  }

  .btn-primary:disabled {
    @apply opacity-50 cursor-not-allowed;
  }

  .btn-secondary {
    @apply px-4 py-2 rounded-lg font-medium border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-all active:scale-[0.98];
  }

  .btn-danger {
    @apply px-4 py-2 rounded-lg font-medium bg-red-500 text-white hover:bg-red-600 transition-all active:scale-[0.98];
  }

  /* Cards CEA */
  .card {
    @apply bg-white rounded-xl border border-gray-200 shadow-sm;
  }

  .card-hover {
    @apply card hover:shadow-md transition-all cursor-pointer;
  }

  /* Inputs CEA */
  .input {
    @apply w-full px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-900 placeholder-gray-400 outline-none transition-all;
  }

  .input:focus {
    @apply ring-2 ring-blue-500/20 border-blue-500;
  }

  .input:disabled {
    @apply bg-gray-100 cursor-not-allowed;
  }

  /* Badges */
  .badge {
    @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
  }

  .badge-primary {
    @apply badge text-white;
    background-color: var(--cea-primary);
  }

  .badge-success {
    @apply badge bg-green-100 text-green-800;
  }

  .badge-warning {
    @apply badge bg-yellow-100 text-yellow-800;
  }

  .badge-error {
    @apply badge bg-red-100 text-red-800;
  }

  .badge-gray {
    @apply badge bg-gray-100 text-gray-800;
  }

  /* Progress bar CEA */
  .progress-container {
    @apply w-full h-2 bg-gray-200 rounded-full overflow-hidden;
  }

  .progress-bar {
    @apply h-full rounded-full transition-all duration-300;
    background-color: var(--cea-primary);
  }

  /* Headers */
  .page-header {
    @apply bg-white border-b border-gray-200;
  }

  .page-title {
    @apply text-2xl font-bold text-gray-900;
  }

  .page-subtitle {
    @apply text-sm text-gray-500;
  }

  /* Tables */
  .table-container {
    @apply overflow-auto rounded-xl border border-gray-200;
  }

  .table {
    @apply min-w-full text-sm;
  }

  .table thead {
    @apply bg-gray-50;
  }

  .table th {
    @apply text-left p-3 font-medium text-gray-700;
  }

  .table td {
    @apply p-3 text-gray-600;
  }

  .table tbody tr {
    @apply border-t border-gray-200 hover:bg-gray-50 transition-colors;
  }

  /* Modals */
  .modal-overlay {
    @apply fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50;
  }

  .modal {
    @apply bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-auto;
  }

  .modal-header {
    @apply sticky top-0 bg-white border-b border-gray-200 p-6;
  }

  .modal-body {
    @apply p-6;
  }

  .modal-footer {
    @apply sticky bottom-0 bg-white border-t border-gray-200 p-6 flex justify-end gap-3;
  }

  /* Alerts */
  .alert {
    @apply rounded-lg p-4 border;
  }

  .alert-success {
    @apply alert bg-green-50 border-green-200 text-green-800;
  }

  .alert-error {
    @apply alert bg-red-50 border-red-200 text-red-800;
  }

  .alert-warning {
    @apply alert bg-yellow-50 border-yellow-200 text-yellow-800;
  }

  .alert-info {
    @apply alert bg-blue-50 border-blue-200 text-blue-800;
  }

  /* Loading spinner */
  .spinner {
    @apply animate-spin rounded-full border-2 border-gray-300 border-t-blue-600;
  }

  /* Breadcrumbs */
  .breadcrumb {
    @apply flex items-center gap-2 text-sm;
  }

  .breadcrumb-item {
    @apply text-gray-500 hover:text-gray-700 transition-colors;
  }

  .breadcrumb-separator {
    @apply text-gray-300;
  }

  /* Stats cards */
  .stat-card {
    @apply card p-6;
  }

  .stat-label {
    @apply text-sm font-medium text-gray-500;
  }

  .stat-value {
    @apply text-3xl font-bold text-gray-900 mt-2;
  }

  .stat-change {
    @apply text-sm mt-2;
  }

  /* Empty states */
  .empty-state {
    @apply text-center py-12 px-6;
  }

  .empty-state-icon {
    @apply text-6xl mb-4 opacity-20;
  }

  .empty-state-title {
    @apply text-lg font-medium text-gray-900 mb-2;
  }

  .empty-state-text {
    @apply text-sm text-gray-500;
  }
}

@layer utilities {
  /* Utilidades personalizadas CEA */
  .text-cea-primary {
    color: var(--cea-primary);
  }

  .bg-cea-primary {
    background-color: var(--cea-primary);
  }

  .border-cea-primary {
    border-color: var(--cea-primary);
  }

  .ring-cea-primary {
    --tw-ring-color: var(--cea-primary);
  }

  /* Animaciones suaves */
  .transition-cea {
    @apply transition-all duration-200 ease-in-out;
  }

  /* Sombras personalizadas */
  .shadow-cea-sm {
    box-shadow: var(--shadow-sm);
  }

  .shadow-cea-md {
    box-shadow: var(--shadow-md);
  }

  .shadow-cea-lg {
    box-shadow: var(--shadow-lg);
  }
}


----------------------------------------------------------------------------------------- 
// src\main.tsx
----------------------------------------------------------------------------------------- 
import React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter, Navigate, Route, Routes } from "react-router-dom";
import "./index.css";

import Login from "./pages/Login";
import AdminDashboard from "./pages/AdminDashboard";

import StudentDashboard from "./pages/StudentDashboard";
import StudentModule from "./pages/StudentModule";

import AppRedirect from "./components/AppRedirect";
import ProtectedRoute from "./components/ProtectedRoute";
import RequireRole from "./components/RequireRole";

// Teacher pages
import TeacherDashboard from "./pages/TeacherDashboard";
import TeacherModules from "./pages/TeacherModules";
import TeacherModuleGrades from "./pages/TeacherModuleGrades";
import TeacherStudentGrades from "./pages/TeacherStudentGrades";

ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <BrowserRouter>
      <Routes>
        {/* Root: manda a /app (decide por rol si hay sesi√≥n) */}
        <Route path="/" element={<Navigate to="/app" replace />} />

        {/* Auth */}
        <Route path="/login" element={<Login />} />
        <Route path="/app" element={<AppRedirect />} />

        {/* Admin */}
        <Route
          path="/admin"
          element={
            <ProtectedRoute>
              <RequireRole allow={["admin"]}>
                <AdminDashboard />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        {/* Teacher - Dashboard principal con lista de estudiantes */}
        <Route
          path="/teacher"
          element={
            <ProtectedRoute>
              <RequireRole allow={["teacher", "admin"]}>
                <TeacherDashboard />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        {/* Teacher - Vista de 20 m√≥dulos (tarjetas) */}
        <Route
          path="/teacher/modules"
          element={
            <ProtectedRoute>
              <RequireRole allow={["teacher", "admin"]}>
                <TeacherModules />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        {/* Teacher - Calificaciones de un m√≥dulo espec√≠fico */}
        <Route
          path="/teacher/module/:moduleId/grades"
          element={
            <ProtectedRoute>
              <RequireRole allow={["teacher", "admin"]}>
                <TeacherModuleGrades />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        {/* Teacher - Resumen de notas de un estudiante */}
        <Route
          path="/teacher/student/:studentId/grades"
          element={
            <ProtectedRoute>
              <RequireRole allow={["teacher", "admin"]}>
                <TeacherStudentGrades />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        {/* Student */}
        <Route
          path="/student"
          element={
            <ProtectedRoute>
              <RequireRole allow={["student", "teacher", "admin"]}>
                <StudentDashboard />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        {/* Student Module Player */}
        <Route
          path="/student/module/:moduleId"
          element={
            <ProtectedRoute>
              <RequireRole allow={["student", "teacher", "admin"]}>
                <StudentModule />
              </RequireRole>
            </ProtectedRoute>
          }
        />

        {/* 404 */}
        <Route path="*" element={<Navigate to="/app" replace />} />
      </Routes>
    </BrowserRouter>
  </React.StrictMode>
);


----------------------------------------------------------------------------------------- 
// src\components\AppRedirect.tsx
----------------------------------------------------------------------------------------- 
import { Navigate } from "react-router-dom";
import { useRole } from "../lib/useRole";

export default function AppRedirect() {
  const { loading, session, role } = useRole();

  if (loading) return <div className="p-6">Cargando...</div>;
  if (!session) return <Navigate to="/login" replace />;

  const to =
    role === "admin" ? "/admin" : role === "teacher" ? "/teacher" : "/student";
  return <Navigate to={to} replace />;
}


----------------------------------------------------------------------------------------- 
// src\components\ProtectedRoute.tsx
----------------------------------------------------------------------------------------- 
import { Navigate } from "react-router-dom";
import { useRole } from "../lib/useRole";

export default function ProtectedRoute({
  children,
}: {
  children: React.ReactNode;
}) {
  const { loading, session } = useRole();

  if (loading) {
    return (
      <div className="min-h-screen bg-zinc-950 text-zinc-100 flex items-center justify-center">
        <div className="text-zinc-300">Cargando...</div>
      </div>
    );
  }

  if (!session) return <Navigate to="/login" replace />;

  return <>{children}</>;
}


----------------------------------------------------------------------------------------- 
// src\components\RequireRole.tsx
----------------------------------------------------------------------------------------- 
// RequireRole.tsx
import { Navigate, useLocation } from "react-router-dom";
import { useRole } from "../lib/useRole";
import type { Role } from "../lib/useRole";

export default function RequireRole({
  allow,
  children,
}: {
  allow: Role[];
  children: React.ReactNode;
}) {
  const { loading, session, role } = useRole();
  const location = useLocation();

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        Cargando...
      </div>
    );
  }

  if (!session) return <Navigate to="/login" replace />;

  // üî• CLAVE: mientras no tengas role, NO redirijas
  if (!role) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        Cargando rol...
      </div>
    );
  }

  if (!allow.includes(role)) {
    const fallback =
      role === "student" ? "/student" : role === "admin" ? "/admin" : "/app";

    // evita redirecci√≥n repetida al mismo lugar
    if (location.pathname === fallback) return null;

    return <Navigate to={fallback} replace />;
  }

  return <>{children}</>;
}


----------------------------------------------------------------------------------------- 
// src\lib\supabase.ts
----------------------------------------------------------------------------------------- 
import { createClient } from "@supabase/supabase-js";

const url = import.meta.env.VITE_SUPABASE_URL as string;
const anon = import.meta.env.VITE_SUPABASE_ANON_KEY as string;

if (!url || !anon) {
  // Esto te avisa al instante si .env est√° mal o Vite no reinici√≥
  // (No rompe build, pero lo ver√°s en consola)
  // eslint-disable-next-line no-console
  console.error("Faltan VITE_SUPABASE_URL o VITE_SUPABASE_ANON_KEY en .env");
}

export const supabase = createClient(url, anon, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
  },
});


----------------------------------------------------------------------------------------- 
// src\lib\useRole.ts
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/lib/useRole.ts
import { useEffect, useState } from "react";
import { supabase } from "./supabase";

export type Role = "student" | "teacher" | "admin";

type ProfileRow = {
  id: string;
  role: Role;
  code: string | null;
  full_name: string | null;
  first_names: string | null;
  last_name_pat: string | null;
  last_name_mat: string | null;
  phone: string | null;
  contact_email: string | null;
  likes: string | null;
  avatar_key: string | null;
  shift: string | null;
  career_id: number | null;
};

export function useRole() {
  const [loading, setLoading] = useState(true);
  const [session, setSession] = useState<
    | Awaited<ReturnType<typeof supabase.auth.getSession>>["data"]["session"]
    | null
  >(null);
  const [role, setRole] = useState<Role | null>(null);
  const [profile, setProfile] = useState<ProfileRow | null>(null);

  useEffect(() => {
    let mounted = true;

    async function load() {
      setLoading(true);

      const { data } = await supabase.auth.getSession();
      const s = data.session;

      if (!mounted) return;

      setSession(s);

      if (!s) {
        setRole(null);
        setProfile(null);
        setLoading(false);
        return;
      }

      // ‚úÖ Cargar perfil completo
      const { data: p, error } = await supabase
        .from("profiles")
        .select(
          "id,role,code,full_name,first_names,last_name_pat,last_name_mat,phone,contact_email,likes,avatar_key,shift,career_id"
        )
        .eq("id", s.user.id)
        .single();

      if (!mounted) return;

      if (error) {
        console.error("role read error:", error);
        setRole(null);
        setProfile(null);
      } else {
        setRole((p?.role ?? null) as Role | null);
        setProfile(p as ProfileRow);
      }

      setLoading(false);
    }

    load();

    const { data: sub } = supabase.auth.onAuthStateChange(() => {
      load();
    });

    return () => {
      mounted = false;
      sub.subscription.unsubscribe();
    };
  }, []);

  return { loading, session, role, profile };
}


----------------------------------------------------------------------------------------- 
// src\pages\AdminContentManager.tsx
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/pages/AdminContentManager.tsx
import { useEffect, useState } from "react";
import { Navigate } from "react-router-dom";
import { supabase } from "../lib/supabase";
import { useRole } from "../lib/useRole";

type Career = { id: number; name: string };
type Level = {
  id: number;
  career_id: number;
  name: string;
  sort_order: number;
};
type Module = {
  id: number;
  level_id: number;
  title: string;
  description: string | null;
  sort_order: number;
  is_active: boolean;
};
type Lesson = {
  id: number;
  module_id: number;
  title: string;
  sort_order: number;
  is_required: boolean;
};
type Section = {
  id: number;
  lesson_id: number;
  title: string;
  kind: string;
  content_json: any;
  sort_order: number;
  is_active: boolean;
};

export default function AdminContentManager() {
  const { loading, session, role } = useRole();
  const isAdmin = role === "admin";

  const [careers, setCareers] = useState<Career[]>([]);
  const [levels, setLevels] = useState<Level[]>([]);
  const [modules, setModules] = useState<Module[]>([]);
  const [lessons, setLessons] = useState<Lesson[]>([]);
  const [sections, setSections] = useState<Section[]>([]);

  const [selectedCareer, setSelectedCareer] = useState<number | null>(null);
  const [selectedLevel, setSelectedLevel] = useState<number | null>(null);
  const [selectedModule, setSelectedModule] = useState<number | null>(null);
  const [selectedLesson, setSelectedLesson] = useState<number | null>(null);

  const [view, setView] = useState<
    "careers" | "levels" | "modules" | "lessons" | "sections"
  >("careers");
  const [msg, setMsg] = useState<string | null>(null);

  // Formularios
  const [showCareerForm, setShowCareerForm] = useState(false);
  const [careerName, setCareerName] = useState("");
  const [careerPrefix, setCareerPrefix] = useState("");

  const [showLevelForm, setShowLevelForm] = useState(false);
  const [levelName, setLevelName] = useState("");
  const [levelOrder, setLevelOrder] = useState(1);

  const [showModuleForm, setShowModuleForm] = useState(false);
  const [moduleTitle, setModuleTitle] = useState("");
  const [moduleDesc, setModuleDesc] = useState("");
  const [moduleOrder, setModuleOrder] = useState(1);

  const [showLessonForm, setShowLessonForm] = useState(false);
  const [lessonTitle, setLessonTitle] = useState("");
  const [lessonOrder, setLessonOrder] = useState(1);

  const [showSectionForm, setShowSectionForm] = useState(false);
  const [sectionTitle, setSectionTitle] = useState("");
  const [sectionKind, setSectionKind] = useState<
    "text" | "video" | "image" | "link" | "quiz"
  >("text");
  const [sectionOrder, setSectionOrder] = useState(1);
  const [sectionContent, setSectionContent] = useState("");

  async function loadCareers() {
    const res = await supabase.from("careers").select("*").order("name");
    if (res.error) {
      setMsg("Error cargando carreras: " + res.error.message);
      return;
    }
    setCareers(res.data ?? []);
  }

  async function loadLevels() {
    if (!selectedCareer) return;
    const res = await supabase
      .from("levels")
      .select("*")
      .eq("career_id", selectedCareer)
      .order("sort_order");
    if (res.error) {
      setMsg("Error cargando niveles: " + res.error.message);
      return;
    }
    setLevels(res.data ?? []);
  }

  async function loadModules() {
    if (!selectedLevel) return;
    const res = await supabase
      .from("modules")
      .select("*")
      .eq("level_id", selectedLevel)
      .order("sort_order");
    if (res.error) {
      setMsg("Error cargando m√≥dulos: " + res.error.message);
      return;
    }
    setModules(res.data ?? []);
  }

  async function loadLessons() {
    if (!selectedModule) return;
    const res = await supabase
      .from("lessons")
      .select("*")
      .eq("module_id", selectedModule)
      .order("sort_order");
    if (res.error) {
      setMsg("Error cargando lecciones: " + res.error.message);
      return;
    }
    setLessons(res.data ?? []);
  }

  async function loadSections() {
    if (!selectedLesson) return;
    const res = await supabase
      .from("lesson_sections")
      .select("*")
      .eq("lesson_id", selectedLesson)
      .order("sort_order");
    if (res.error) {
      setMsg("Error cargando secciones: " + res.error.message);
      return;
    }
    setSections(res.data ?? []);
  }

  useEffect(() => {
    if (session && isAdmin) loadCareers();
  }, [session, isAdmin]);

  useEffect(() => {
    if (selectedCareer) loadLevels();
  }, [selectedCareer]);

  useEffect(() => {
    if (selectedLevel) loadModules();
  }, [selectedLevel]);

  useEffect(() => {
    if (selectedModule) loadLessons();
  }, [selectedModule]);

  useEffect(() => {
    if (selectedLesson) loadSections();
  }, [selectedLesson]);

  async function createCareer() {
    if (!careerName.trim() || !careerPrefix.trim()) {
      setMsg("Completa nombre y prefijo");
      return;
    }

    const res = await supabase
      .from("careers")
      .insert({ name: careerName, student_prefix: careerPrefix.toUpperCase() });

    if (res.error) {
      setMsg("Error: " + res.error.message);
      return;
    }

    setMsg("‚úÖ Carrera creada");
    setShowCareerForm(false);
    setCareerName("");
    setCareerPrefix("");
    loadCareers();
  }

  async function createLevel() {
    if (!selectedCareer || !levelName.trim()) {
      setMsg("Selecciona carrera y completa nombre");
      return;
    }

    const res = await supabase.from("levels").insert({
      career_id: selectedCareer,
      name: levelName,
      sort_order: levelOrder,
    });

    if (res.error) {
      setMsg("Error: " + res.error.message);
      return;
    }

    setMsg("‚úÖ Nivel creado");
    setShowLevelForm(false);
    setLevelName("");
    setLevelOrder(1);
    loadLevels();
  }

  async function createModule() {
    if (!selectedLevel || !moduleTitle.trim()) {
      setMsg("Selecciona nivel y completa t√≠tulo");
      return;
    }

    const res = await supabase.from("modules").insert({
      level_id: selectedLevel,
      title: moduleTitle,
      description: moduleDesc || null,
      sort_order: moduleOrder,
      is_active: true,
    });

    if (res.error) {
      setMsg("Error: " + res.error.message);
      return;
    }

    setMsg("‚úÖ M√≥dulo creado");
    setShowModuleForm(false);
    setModuleTitle("");
    setModuleDesc("");
    setModuleOrder(1);
    loadModules();
  }

  async function createLesson() {
    if (!selectedModule || !lessonTitle.trim()) {
      setMsg("Selecciona m√≥dulo y completa t√≠tulo");
      return;
    }

    const res = await supabase.from("lessons").insert({
      module_id: selectedModule,
      title: lessonTitle,
      sort_order: lessonOrder,
      is_required: true,
    });

    if (res.error) {
      setMsg("Error: " + res.error.message);
      return;
    }

    setMsg("‚úÖ Lecci√≥n creada");
    setShowLessonForm(false);
    setLessonTitle("");
    setLessonOrder(1);
    loadLessons();
  }

  async function createSection() {
    if (!selectedLesson || !sectionTitle.trim()) {
      setMsg("Selecciona lecci√≥n y completa t√≠tulo");
      return;
    }

    let content_json: any = {};

    if (sectionKind === "text") {
      content_json = { text: sectionContent };
    } else if (sectionKind === "video") {
      content_json = { url: sectionContent, title: sectionTitle };
    } else if (sectionKind === "image") {
      content_json = { url: sectionContent };
    } else if (sectionKind === "link") {
      content_json = { url: sectionContent, label: sectionTitle };
    } else if (sectionKind === "quiz") {
      try {
        content_json = JSON.parse(sectionContent);
      } catch {
        setMsg("Error: contenido quiz debe ser JSON v√°lido");
        return;
      }
    }

    const res = await supabase.from("lesson_sections").insert({
      lesson_id: selectedLesson,
      title: sectionTitle,
      kind: sectionKind,
      content_json,
      sort_order: sectionOrder,
      is_active: true,
    });

    if (res.error) {
      setMsg("Error: " + res.error.message);
      return;
    }

    setMsg("‚úÖ Secci√≥n creada");
    setShowSectionForm(false);
    setSectionTitle("");
    setSectionContent("");
    setSectionOrder(1);
    loadSections();
  }

  async function deleteCareer(id: number) {
    if (
      !confirm(
        "¬øEliminar carrera? Esto eliminar√° niveles, m√≥dulos y lecciones relacionadas."
      )
    )
      return;
    const res = await supabase.from("careers").delete().eq("id", id);
    if (res.error) {
      setMsg("Error: " + res.error.message);
      return;
    }
    setMsg("‚úÖ Carrera eliminada");
    loadCareers();
  }

  async function deleteLevel(id: number) {
    if (
      !confirm(
        "¬øEliminar nivel? Esto eliminar√° m√≥dulos y lecciones relacionadas."
      )
    )
      return;
    const res = await supabase.from("levels").delete().eq("id", id);
    if (res.error) {
      setMsg("Error: " + res.error.message);
      return;
    }
    setMsg("‚úÖ Nivel eliminado");
    loadLevels();
  }

  async function deleteModule(id: number) {
    if (!confirm("¬øEliminar m√≥dulo? Esto eliminar√° lecciones relacionadas."))
      return;
    const res = await supabase.from("modules").delete().eq("id", id);
    if (res.error) {
      setMsg("Error: " + res.error.message);
      return;
    }
    setMsg("‚úÖ M√≥dulo eliminado");
    loadModules();
  }

  async function deleteLesson(id: number) {
    if (!confirm("¬øEliminar lecci√≥n? Esto eliminar√° secciones relacionadas."))
      return;
    const res = await supabase.from("lessons").delete().eq("id", id);
    if (res.error) {
      setMsg("Error: " + res.error.message);
      return;
    }
    setMsg("‚úÖ Lecci√≥n eliminada");
    loadLessons();
  }

  async function deleteSection(id: number) {
    if (!confirm("¬øEliminar secci√≥n?")) return;
    const res = await supabase.from("lesson_sections").delete().eq("id", id);
    if (res.error) {
      setMsg("Error: " + res.error.message);
      return;
    }
    setMsg("‚úÖ Secci√≥n eliminada");
    loadSections();
  }

  if (loading) return <div className="p-6">Cargando...</div>;
  if (!session) return <Navigate to="/login" replace />;
  if (!isAdmin) return <Navigate to="/teacher" replace />;

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100">
      <header className="bg-slate-950 border-b border-slate-800">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <div className="text-sm text-slate-400">Panel Administrador</div>
          <h1 className="text-2xl font-bold">Gesti√≥n de Contenido</h1>
          <div className="text-sm text-slate-300 mt-1">
            Administra carreras, niveles, m√≥dulos, lecciones y secciones
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-6 space-y-6">
        {msg && (
          <div
            className={
              "text-sm rounded-xl p-3 " +
              (msg.includes("‚úÖ")
                ? "bg-emerald-950 border border-emerald-800 text-emerald-200"
                : "bg-rose-950 border border-rose-800 text-rose-200")
            }
          >
            {msg}
          </div>
        )}

        {/* Navegaci√≥n en breadcrumbs */}
        <div className="flex items-center gap-2 text-sm">
          <button
            className="text-slate-400 hover:text-white"
            onClick={() => {
              setView("careers");
              setSelectedCareer(null);
              setSelectedLevel(null);
              setSelectedModule(null);
              setSelectedLesson(null);
            }}
          >
            Carreras
          </button>
          {selectedCareer && (
            <>
              <span className="text-slate-600">/</span>
              <button
                className="text-slate-400 hover:text-white"
                onClick={() => {
                  setView("levels");
                  setSelectedLevel(null);
                  setSelectedModule(null);
                  setSelectedLesson(null);
                }}
              >
                Niveles
              </button>
            </>
          )}
          {selectedLevel && (
            <>
              <span className="text-slate-600">/</span>
              <button
                className="text-slate-400 hover:text-white"
                onClick={() => {
                  setView("modules");
                  setSelectedModule(null);
                  setSelectedLesson(null);
                }}
              >
                M√≥dulos
              </button>
            </>
          )}
          {selectedModule && (
            <>
              <span className="text-slate-600">/</span>
              <button
                className="text-slate-400 hover:text-white"
                onClick={() => {
                  setView("lessons");
                  setSelectedLesson(null);
                }}
              >
                Lecciones
              </button>
            </>
          )}
          {selectedLesson && (
            <>
              <span className="text-slate-600">/</span>
              <span className="text-white">Secciones</span>
            </>
          )}
        </div>

        {/* CARRERAS */}
        {view === "careers" && (
          <section className="bg-slate-950 rounded-2xl border border-slate-800 p-6 space-y-4">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-bold">Carreras</h2>
              <button
                className="rounded-xl px-3 py-2 bg-white text-black"
                onClick={() => setShowCareerForm(true)}
              >
                + Nueva Carrera
              </button>
            </div>

            {showCareerForm && (
              <div className="rounded-2xl border border-slate-700 p-4 space-y-3 bg-slate-900">
                <h3 className="font-semibold">Crear Carrera</h3>
                <input
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="Nombre (ej: Sistemas Inform√°ticos)"
                  value={careerName}
                  onChange={(e) => setCareerName(e.target.value)}
                />
                <input
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="Prefijo estudiante (ej: SI)"
                  value={careerPrefix}
                  onChange={(e) => setCareerPrefix(e.target.value)}
                />
                <div className="flex gap-2">
                  <button
                    className="rounded-xl px-3 py-2 bg-white text-black"
                    onClick={createCareer}
                  >
                    Crear
                  </button>
                  <button
                    className="rounded-xl px-3 py-2 border border-slate-800"
                    onClick={() => setShowCareerForm(false)}
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {careers.map((c) => (
                <div
                  key={c.id}
                  className="rounded-2xl border border-slate-800 p-4 hover:bg-slate-900 cursor-pointer"
                  onClick={() => {
                    setSelectedCareer(c.id);
                    setView("levels");
                  }}
                >
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-bold">{c.name}</div>
                      <div className="text-sm text-slate-400">ID: {c.id}</div>
                    </div>
                    <button
                      className="rounded-xl px-2 py-1 border border-rose-800 text-rose-400 text-sm"
                      onClick={(e) => {
                        e.stopPropagation();
                        deleteCareer(c.id);
                      }}
                    >
                      Eliminar
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {/* NIVELES */}
        {view === "levels" && selectedCareer && (
          <section className="bg-slate-950 rounded-2xl border border-slate-800 p-6 space-y-4">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-bold">
                Niveles de {careers.find((c) => c.id === selectedCareer)?.name}
              </h2>
              <button
                className="rounded-xl px-3 py-2 bg-white text-black"
                onClick={() => setShowLevelForm(true)}
              >
                + Nuevo Nivel
              </button>
            </div>

            {showLevelForm && (
              <div className="rounded-2xl border border-slate-700 p-4 space-y-3 bg-slate-900">
                <h3 className="font-semibold">Crear Nivel</h3>
                <input
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="Nombre (ej: T√©cnico B√°sico)"
                  value={levelName}
                  onChange={(e) => setLevelName(e.target.value)}
                />
                <input
                  type="number"
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="Orden (1, 2, 3...)"
                  value={levelOrder}
                  onChange={(e) => setLevelOrder(Number(e.target.value))}
                />
                <div className="flex gap-2">
                  <button
                    className="rounded-xl px-3 py-2 bg-white text-black"
                    onClick={createLevel}
                  >
                    Crear
                  </button>
                  <button
                    className="rounded-xl px-3 py-2 border border-slate-800"
                    onClick={() => setShowLevelForm(false)}
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {levels.map((l) => (
                <div
                  key={l.id}
                  className="rounded-2xl border border-slate-800 p-4 hover:bg-slate-900 cursor-pointer"
                  onClick={() => {
                    setSelectedLevel(l.id);
                    setView("modules");
                  }}
                >
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-bold">{l.name}</div>
                      <div className="text-sm text-slate-400">
                        Orden: {l.sort_order}
                      </div>
                    </div>
                    <button
                      className="rounded-xl px-2 py-1 border border-rose-800 text-rose-400 text-sm"
                      onClick={(e) => {
                        e.stopPropagation();
                        deleteLevel(l.id);
                      }}
                    >
                      Eliminar
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {/* M√ìDULOS */}
        {view === "modules" && selectedLevel && (
          <section className="bg-slate-950 rounded-2xl border border-slate-800 p-6 space-y-4">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-bold">
                M√≥dulos de {levels.find((l) => l.id === selectedLevel)?.name}
              </h2>
              <button
                className="rounded-xl px-3 py-2 bg-white text-black"
                onClick={() => setShowModuleForm(true)}
              >
                + Nuevo M√≥dulo
              </button>
            </div>

            {showModuleForm && (
              <div className="rounded-2xl border border-slate-700 p-4 space-y-3 bg-slate-900">
                <h3 className="font-semibold">Crear M√≥dulo</h3>
                <input
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="T√≠tulo"
                  value={moduleTitle}
                  onChange={(e) => setModuleTitle(e.target.value)}
                />
                <textarea
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="Descripci√≥n (opcional)"
                  rows={3}
                  value={moduleDesc}
                  onChange={(e) => setModuleDesc(e.target.value)}
                />
                <input
                  type="number"
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="Orden"
                  value={moduleOrder}
                  onChange={(e) => setModuleOrder(Number(e.target.value))}
                />
                <div className="flex gap-2">
                  <button
                    className="rounded-xl px-3 py-2 bg-white text-black"
                    onClick={createModule}
                  >
                    Crear
                  </button>
                  <button
                    className="rounded-xl px-3 py-2 border border-slate-800"
                    onClick={() => setShowModuleForm(false)}
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {modules.map((m) => (
                <div
                  key={m.id}
                  className="rounded-2xl border border-slate-800 p-4 hover:bg-slate-900 cursor-pointer"
                  onClick={() => {
                    setSelectedModule(m.id);
                    setView("lessons");
                  }}
                >
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-bold">{m.title}</div>
                      <div className="text-sm text-slate-400">
                        Orden: {m.sort_order}
                      </div>
                      {m.description && (
                        <div className="text-sm text-slate-500 mt-1">
                          {m.description}
                        </div>
                      )}
                    </div>
                    <button
                      className="rounded-xl px-2 py-1 border border-rose-800 text-rose-400 text-sm"
                      onClick={(e) => {
                        e.stopPropagation();
                        deleteModule(m.id);
                      }}
                    >
                      Eliminar
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {/* LECCIONES */}
        {view === "lessons" && selectedModule && (
          <section className="bg-slate-950 rounded-2xl border border-slate-800 p-6 space-y-4">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-bold">
                Lecciones de{" "}
                {modules.find((m) => m.id === selectedModule)?.title}
              </h2>
              <button
                className="rounded-xl px-3 py-2 bg-white text-black"
                onClick={() => setShowLessonForm(true)}
              >
                + Nueva Lecci√≥n
              </button>
            </div>

            {showLessonForm && (
              <div className="rounded-2xl border border-slate-700 p-4 space-y-3 bg-slate-900">
                <h3 className="font-semibold">Crear Lecci√≥n</h3>
                <input
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="T√≠tulo"
                  value={lessonTitle}
                  onChange={(e) => setLessonTitle(e.target.value)}
                />
                <input
                  type="number"
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="Orden"
                  value={lessonOrder}
                  onChange={(e) => setLessonOrder(Number(e.target.value))}
                />
                <div className="flex gap-2">
                  <button
                    className="rounded-xl px-3 py-2 bg-white text-black"
                    onClick={createLesson}
                  >
                    Crear
                  </button>
                  <button
                    className="rounded-xl px-3 py-2 border border-slate-800"
                    onClick={() => setShowLessonForm(false)}
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            )}

            <div className="space-y-3">
              {lessons.map((l) => (
                <div
                  key={l.id}
                  className="rounded-2xl border border-slate-800 p-4 hover:bg-slate-900 cursor-pointer"
                  onClick={() => {
                    setSelectedLesson(l.id);
                    setView("sections");
                  }}
                >
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-bold">{l.title}</div>
                      <div className="text-sm text-slate-400">
                        Orden: {l.sort_order}
                      </div>
                    </div>
                    <button
                      className="rounded-xl px-2 py-1 border border-rose-800 text-rose-400 text-sm"
                      onClick={(e) => {
                        e.stopPropagation();
                        deleteLesson(l.id);
                      }}
                    >
                      Eliminar
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {/* SECCIONES */}
        {view === "sections" && selectedLesson && (
          <section className="bg-slate-950 rounded-2xl border border-slate-800 p-6 space-y-4">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-bold">
                Secciones de{" "}
                {lessons.find((l) => l.id === selectedLesson)?.title}
              </h2>
              <button
                className="rounded-xl px-3 py-2 bg-white text-black"
                onClick={() => setShowSectionForm(true)}
              >
                + Nueva Secci√≥n
              </button>
            </div>

            {showSectionForm && (
              <div className="rounded-2xl border border-slate-700 p-4 space-y-3 bg-slate-900">
                <h3 className="font-semibold">Crear Secci√≥n</h3>
                <input
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="T√≠tulo"
                  value={sectionTitle}
                  onChange={(e) => setSectionTitle(e.target.value)}
                />
                <select
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  value={sectionKind}
                  onChange={(e) =>
                    setSectionKind(
                      e.target.value as
                        | "text"
                        | "video"
                        | "image"
                        | "link"
                        | "quiz"
                    )
                  }
                >
                  <option value="text">Texto</option>
                  <option value="video">Video (YouTube)</option>
                  <option value="image">Imagen (URL)</option>
                  <option value="link">Enlace (Google Drive, etc)</option>
                  <option value="quiz">Quiz (JSON)</option>
                </select>
                <textarea
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder={
                    sectionKind === "text"
                      ? "Contenido de texto..."
                      : sectionKind === "video"
                      ? "URL de YouTube"
                      : sectionKind === "image"
                      ? "URL de imagen"
                      : sectionKind === "link"
                      ? "URL del enlace"
                      : 'Quiz en JSON: {"question":"...", "options":["a","b"], "answer":0}'
                  }
                  rows={sectionKind === "quiz" ? 8 : 4}
                  value={sectionContent}
                  onChange={(e) => setSectionContent(e.target.value)}
                />
                <input
                  type="number"
                  className="w-full rounded-xl px-3 py-2 bg-slate-950 border border-slate-800"
                  placeholder="Orden"
                  value={sectionOrder}
                  onChange={(e) => setSectionOrder(Number(e.target.value))}
                />
                <div className="flex gap-2">
                  <button
                    className="rounded-xl px-3 py-2 bg-white text-black"
                    onClick={createSection}
                  >
                    Crear
                  </button>
                  <button
                    className="rounded-xl px-3 py-2 border border-slate-800"
                    onClick={() => setShowSectionForm(false)}
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            )}

            <div className="space-y-3">
              {sections.map((s) => (
                <div
                  key={s.id}
                  className="rounded-2xl border border-slate-800 p-4"
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <div className="font-bold">{s.title}</div>
                        <span className="text-xs px-2 py-1 rounded-full bg-slate-800 border border-slate-700">
                          {s.kind}
                        </span>
                      </div>
                      <div className="text-sm text-slate-400 mt-1">
                        Orden: {s.sort_order}
                      </div>
                      <div className="text-xs text-slate-500 mt-2">
                        {JSON.stringify(s.content_json).substring(0, 100)}...
                      </div>
                    </div>
                    <button
                      className="rounded-xl px-2 py-1 border border-rose-800 text-rose-400 text-sm"
                      onClick={() => deleteSection(s.id)}
                    >
                      Eliminar
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}
      </main>
    </div>
  );
}


----------------------------------------------------------------------------------------- 
// src\pages\AdminDashboard.tsx
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/pages/AdminDashboard.tsx
// VERSI√ìN CORREGIDA - Muestra TODOS los niveles para TODOS los estudiantes

import { FormEvent, useCallback, useEffect, useMemo, useState } from "react";
import { useNavigate } from "react-router-dom";
import { supabase } from "../lib/supabase";

type Shift = "tarde" | "noche";
type UserRole = "student" | "teacher" | "admin";

type Level = {
  id: number;
  name: string;
  sort_order: number;
  career_id: number;
};
type Career = { id: number; name: string; student_prefix: string };

type UserRow = {
  id: string;
  code: string | null;
  full_name: string | null;
  first_names: string | null;
  last_name_pat: string | null;
  last_name_mat: string | null;
  role: UserRole | null;
  phone: string | null;
  shift: string | null;
  career_id: number | null;
  contact_email: string | null;
  likes: string | null;
  avatar_key: string | null;
  created_at?: string | null;
};

type StudentWithLevel = UserRow & {
  current_level_id?: number | null;
  current_level_name?: string | null;
};

type EnrollmentRow = {
  student_id: string;
  level_id: number;
};

type ApiResponse = {
  ok?: boolean;
  code?: string;
  temp_password?: string;
  message?: string;
  error?: string;
};

function randomPass(len = 10) {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789";
  let out = "";
  for (let i = 0; i < len; i++)
    out += chars[Math.floor(Math.random() * chars.length)];
  return out;
}

export default function AdminDashboard() {
  const nav = useNavigate();
  const supabaseUrl = String(import.meta.env.VITE_SUPABASE_URL ?? "");
  const anonKey = String(import.meta.env.VITE_SUPABASE_ANON_KEY ?? "");

  const [levels, setLevels] = useState<Level[]>([]);
  const [careers, setCareers] = useState<Career[]>([]);
  const [teachers, setTeachers] = useState<UserRow[]>([]);
  const [students, setStudents] = useState<StudentWithLevel[]>([]);
  const [msg, setMsg] = useState<string | null>(null);

  // Formulario crear/editar
  const [showForm, setShowForm] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [role, setRole] = useState<"student" | "teacher">("student");
  const [careerId, setCareerId] = useState<number | "">("");
  const [shift, setShift] = useState<Shift>("tarde");
  const [firstNames, setFirstNames] = useState("");
  const [lastPat, setLastPat] = useState("");
  const [lastMat, setLastMat] = useState("");
  const [phone, setPhone] = useState("");
  const [contactEmail, setContactEmail] = useState("");
  const [likes, setLikes] = useState("");
  const [avatarKey, setAvatarKey] = useState("av1");
  const [levelId, setLevelId] = useState<number | "">("");
  const [tempPassword, setTempPassword] = useState(randomPass());

  const [creating, setCreating] = useState(false);
  const [loadingTeachers, setLoadingTeachers] = useState(false);
  const [loadingStudents, setLoadingStudents] = useState(false);

  // B√∫squeda y filtros
  const [teacherSearch, setTeacherSearch] = useState("");
  const [studentSearch, setStudentSearch] = useState("");
  const [filterCareer, setFilterCareer] = useState<number | "">("");

  // Ordenamiento
  const [teacherSort, setTeacherSort] = useState<{
    column: keyof UserRow;
    direction: "asc" | "desc";
  }>({ column: "code", direction: "asc" });

  const [studentSort, setStudentSort] = useState<{
    column: keyof StudentWithLevel | "level_name";
    direction: "asc" | "desc";
  }>({ column: "code", direction: "asc" });

  // Modal reset password
  const [showResetModal, setShowResetModal] = useState(false);
  const [resetUserId, setResetUserId] = useState("");
  const [resetUserCode, setResetUserCode] = useState("");
  const [newPassword, setNewPassword] = useState("");
  const [resetting, setResetting] = useState(false);

  const loadCatalogs = useCallback(async () => {
    const c = await supabase
      .from("careers")
      .select("id,name,student_prefix")
      .order("name");
    if (!c.error) setCareers((c.data as Career[]) ?? []);

    const l = await supabase
      .from("levels")
      .select("id,name,sort_order,career_id")
      .order("sort_order");
    if (!l.error) setLevels((l.data as Level[]) ?? []);
  }, []);

  const loadTeachers = useCallback(async () => {
    setLoadingTeachers(true);

    const { data, error } = await supabase
      .from("profiles")
      .select(
        "id,code,full_name,first_names,last_name_pat,last_name_mat,role,phone,shift,career_id,contact_email,likes,avatar_key,created_at"
      )
      .eq("role", "teacher")
      .order("created_at", { ascending: false });

    setLoadingTeachers(false);

    if (error) {
      setMsg("Error cargando docentes: " + error.message);
      return;
    }

    setTeachers((data as UserRow[]) ?? []);
  }, []);

  const loadStudents = useCallback(async () => {
    setLoadingStudents(true);

    console.log("üìä Cargando estudiantes...");
    console.log("üìö Niveles disponibles:", levels);

    const { data, error } = await supabase
      .from("profiles")
      .select(
        "id,code,full_name,first_names,last_name_pat,last_name_mat,role,phone,shift,career_id,contact_email,likes,avatar_key,created_at"
      )
      .eq("role", "student")
      .order("created_at", { ascending: false });

    if (error) {
      setLoadingStudents(false);
      setMsg("Error cargando estudiantes: " + error.message);
      return;
    }

    const studentsList = (data as UserRow[]) ?? [];
    console.log(`üë• ${studentsList.length} estudiantes encontrados`);

    // Obtener enrollments actuales de todos los estudiantes
    const studentIds = studentsList.map((s) => s.id);

    if (studentIds.length === 0) {
      setStudents([]);
      setLoadingStudents(false);
      return;
    }

    const { data: enrollments, error: enrollError } = await supabase
      .from("enrollments")
      .select("student_id, level_id")
      .in("student_id", studentIds);

    if (enrollError) {
      console.error("‚ùå Error cargando enrollments:", enrollError);
    }

    console.log("üìù Enrollments encontrados:", enrollments);

    // Crear mapa de student_id -> level_id
    const levelMap = new Map<string, number>();
    if (enrollments) {
      for (const e of enrollments as EnrollmentRow[]) {
        levelMap.set(e.student_id, e.level_id);
      }
    }

    console.log("üó∫Ô∏è Mapa de niveles:", Array.from(levelMap.entries()));

    // Combinar datos
    const studentsWithLevel: StudentWithLevel[] = studentsList.map((s) => {
      const levelIdValue = levelMap.get(s.id);
      const level = levels.find((l) => l.id === levelIdValue);

      console.log(
        `üë§ ${s.code}: level_id=${levelIdValue}, level_name=${
          level?.name ?? "NO ENCONTRADO"
        }`
      );

      return {
        ...s,
        current_level_id: levelIdValue ?? null,
        current_level_name: level?.name ?? null,
      };
    });

    console.log("‚úÖ Estudiantes con niveles:", studentsWithLevel);

    setStudents(studentsWithLevel);
    setLoadingStudents(false);
  }, [levels]);

  useEffect(() => {
    void loadCatalogs();
  }, [loadCatalogs]);

  useEffect(() => {
    if (careers.length > 0 && levels.length > 0) {
      void loadTeachers();
      void loadStudents();
    }
  }, [careers.length, levels.length, loadTeachers, loadStudents]);

  const filteredTeachers = useMemo(() => {
    const s = teacherSearch.trim().toLowerCase();
    let result = teachers;

    if (s) {
      result = result.filter((t) => {
        const a = (t.code ?? "").toLowerCase();
        const b = (t.full_name ?? "").toLowerCase();
        const c = (t.phone ?? "").toLowerCase();
        return a.includes(s) || b.includes(s) || c.includes(s);
      });
    }

    // Ordenar
    result = result.slice().sort((a, b) => {
      const aVal = a[teacherSort.column] ?? "";
      const bVal = b[teacherSort.column] ?? "";

      if (teacherSort.direction === "asc") {
        return String(aVal).localeCompare(String(bVal));
      } else {
        return String(bVal).localeCompare(String(aVal));
      }
    });

    return result;
  }, [teachers, teacherSearch, teacherSort]);

  const filteredStudents = useMemo(() => {
    const s = studentSearch.trim().toLowerCase();
    let result = students;

    if (s) {
      result = result.filter((st) => {
        const a = (st.code ?? "").toLowerCase();
        const b = (st.full_name ?? "").toLowerCase();
        const c = (st.phone ?? "").toLowerCase();
        return a.includes(s) || b.includes(s) || c.includes(s);
      });
    }

    if (filterCareer) {
      result = result.filter((st) => st.career_id === filterCareer);
    }

    // Ordenar
    result = result.slice().sort((a, b) => {
      let aVal: string | number = "";
      let bVal: string | number = "";

      if (studentSort.column === "level_name") {
        aVal = a.current_level_name ?? "";
        bVal = b.current_level_name ?? "";
      } else {
        aVal = a[studentSort.column as keyof UserRow] ?? "";
        bVal = b[studentSort.column as keyof UserRow] ?? "";
      }

      if (studentSort.direction === "asc") {
        return String(aVal).localeCompare(String(bVal));
      } else {
        return String(bVal).localeCompare(String(aVal));
      }
    });

    return result;
  }, [students, studentSearch, filterCareer, studentSort]);

  function resetForm() {
    setShowForm(false);
    setEditingId(null);
    setRole("student");
    setCareerId("");
    setShift("tarde");
    setFirstNames("");
    setLastPat("");
    setLastMat("");
    setPhone("");
    setContactEmail("");
    setLikes("");
    setAvatarKey("av1");
    setLevelId("");
    setTempPassword(randomPass());
  }

  function openEdit(user: UserRow | StudentWithLevel) {
    setEditingId(user.id);
    setRole((user.role as "student" | "teacher") ?? "student");
    setCareerId(user.career_id ?? "");
    setShift((user.shift as Shift) ?? "tarde");
    setFirstNames(user.first_names ?? "");
    setLastPat(user.last_name_pat ?? "");
    setLastMat(user.last_name_mat ?? "");
    setPhone(user.phone ?? "");
    setContactEmail(user.contact_email ?? "");
    setLikes(user.likes ?? "");
    setAvatarKey(user.avatar_key ?? "av1");

    // Si es estudiante, cargar su nivel actual
    if (user.role === "student") {
      const student = user as StudentWithLevel;
      setLevelId(student.current_level_id ?? "");
      console.log("üìù Editando estudiante:", {
        code: user.code,
        nivel_actual_id: student.current_level_id,
        nivel_actual_nombre: student.current_level_name,
      });
    }

    setShowForm(true);
  }

  async function createUser(e: FormEvent) {
    e.preventDefault();
    setMsg(null);
    setCreating(true);

    if (!supabaseUrl || !anonKey) {
      setCreating(false);
      setMsg("Faltan variables .env");
      return;
    }

    const { data: sessionData } = await supabase.auth.getSession();
    const session = sessionData.session;

    if (!session) {
      setCreating(false);
      setMsg("No hay sesi√≥n activa.");
      return;
    }

    const fn = firstNames.trim();
    const lp = lastPat.trim();
    const lm = lastMat.trim();
    const ph = phone.trim();

    if (!fn || (!lp && !lm) || !ph || !careerId) {
      setCreating(false);
      setMsg(
        "Completa campos obligatorios: nombres, apellido, celular, carrera."
      );
      return;
    }

    if (role === "student" && !levelId) {
      setCreating(false);
      setMsg("Selecciona nivel para estudiante.");
      return;
    }

    const payload = {
      role,
      temp_password: tempPassword,
      first_names: fn,
      last_name_pat: lp || undefined,
      last_name_mat: lm || undefined,
      phone: ph,
      contact_email: contactEmail.trim() || undefined,
      career_id: Number(careerId),
      shift,
      likes: likes.trim() || undefined,
      avatar_key: avatarKey,
      ...(role === "student" ? { level_id: Number(levelId) } : {}),
    };

    const url = `${supabaseUrl}/functions/v1/create-user`;

    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        apikey: anonKey,
        Authorization: `Bearer ${session.access_token}`,
      },
      body: JSON.stringify(payload),
    });

    const raw = await res.text();
    setCreating(false);

    let out: ApiResponse = {};
    try {
      out = raw ? JSON.parse(raw) : { error: "Respuesta vac√≠a" };
    } catch {
      out = { error: raw };
    }

    if (!res.ok) {
      setMsg(`Error ${res.status}: ${out.error ?? raw}`);
      return;
    }

    setMsg(`‚úÖ Usuario creado: ${out.code}\nPass: ${out.temp_password}`);
    resetForm();
    await loadTeachers();
    await loadStudents();
  }

  async function updateUser(e: FormEvent) {
    e.preventDefault();
    if (!editingId) return;

    setMsg(null);
    setCreating(true);

    if (!supabaseUrl || !anonKey) {
      setCreating(false);
      setMsg("Faltan variables .env");
      return;
    }

    const { data: sessionData } = await supabase.auth.getSession();
    const session = sessionData.session;

    if (!session) {
      setCreating(false);
      setMsg("No hay sesi√≥n activa.");
      return;
    }

    const fn = firstNames.trim();
    const lp = lastPat.trim();
    const lm = lastMat.trim();
    const ph = phone.trim();

    if (!fn || (!lp && !lm) || !ph || !careerId) {
      setCreating(false);
      setMsg("Completa campos obligatorios.");
      return;
    }

    if (role === "student" && !levelId) {
      setCreating(false);
      setMsg("Selecciona nivel para estudiante.");
      return;
    }

    const payload = {
      user_id: editingId,
      first_names: fn,
      last_name_pat: lp || undefined,
      last_name_mat: lm || undefined,
      phone: ph,
      contact_email: contactEmail.trim() || undefined,
      career_id: Number(careerId),
      shift,
      likes: likes.trim() || undefined,
      avatar_key: avatarKey,
      ...(role === "student" ? { level_id: Number(levelId) } : {}),
    };

    console.log("üöÄ Enviando actualizaci√≥n:", payload);

    const url = `${supabaseUrl}/functions/v1/update-user`;

    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        apikey: anonKey,
        Authorization: `Bearer ${session.access_token}`,
      },
      body: JSON.stringify(payload),
    });

    const raw = await res.text();
    setCreating(false);

    let out: ApiResponse = {};
    try {
      out = raw ? JSON.parse(raw) : { error: "Respuesta vac√≠a" };
    } catch {
      out = { error: raw };
    }

    if (!res.ok) {
      setMsg(`Error ${res.status}: ${out.error ?? raw}`);
      return;
    }

    console.log("‚úÖ Respuesta del servidor:", out);
    setMsg("‚úÖ Usuario actualizado");
    resetForm();
    await loadTeachers();
    await loadStudents();
  }

  async function deleteUser(userId: string, code: string) {
    if (!confirm(`¬øEliminar usuario ${code}?`)) return;

    setMsg(null);

    if (!supabaseUrl || !anonKey) {
      setMsg("Faltan variables .env");
      return;
    }

    const { data: sessionData } = await supabase.auth.getSession();
    const session = sessionData.session;

    if (!session) {
      setMsg("No hay sesi√≥n activa.");
      return;
    }

    const url = `${supabaseUrl}/functions/v1/delete-user`;

    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        apikey: anonKey,
        Authorization: `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({ user_id: userId }),
    });

    const raw = await res.text();

    let out: ApiResponse = {};
    try {
      out = raw ? JSON.parse(raw) : { error: "Respuesta vac√≠a" };
    } catch {
      out = { error: raw };
    }

    if (!res.ok) {
      setMsg(`Error ${res.status}: ${out.error ?? raw}`);
      return;
    }

    setMsg("‚úÖ Usuario eliminado correctamente");
    await loadTeachers();
    await loadStudents();
  }

  function openResetPassword(userId: string, code: string) {
    setResetUserId(userId);
    setResetUserCode(code);
    setNewPassword(randomPass());
    setShowResetModal(true);
  }

  async function resetPassword() {
    if (!newPassword.trim()) {
      alert("Ingresa una contrase√±a");
      return;
    }

    setResetting(true);
    setMsg(null);

    if (!supabaseUrl || !anonKey) {
      setResetting(false);
      setMsg("Faltan variables .env");
      return;
    }

    const { data: sessionData } = await supabase.auth.getSession();
    const session = sessionData.session;

    if (!session) {
      setResetting(false);
      setMsg("No hay sesi√≥n activa.");
      return;
    }

    const url = `${supabaseUrl}/functions/v1/reset-password`;

    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        apikey: anonKey,
        Authorization: `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({
        user_id: resetUserId,
        new_password: newPassword,
      }),
    });

    const raw = await res.text();
    setResetting(false);

    let out: ApiResponse = {};
    try {
      out = raw ? JSON.parse(raw) : { error: "Respuesta vac√≠a" };
    } catch {
      out = { error: raw };
    }

    if (!res.ok) {
      setMsg(`Error ${res.status}: ${out.error ?? raw}`);
      return;
    }

    setMsg(`‚úÖ Contrase√±a actualizada para ${resetUserCode}: ${newPassword}`);
    setShowResetModal(false);
  }

  function toggleTeacherSort(column: keyof UserRow) {
    setTeacherSort((prev) => ({
      column,
      direction:
        prev.column === column && prev.direction === "asc" ? "desc" : "asc",
    }));
  }

  function toggleStudentSort(column: keyof StudentWithLevel | "level_name") {
    setStudentSort((prev) => ({
      column,
      direction:
        prev.column === column && prev.direction === "asc" ? "desc" : "asc",
    }));
  }

  // ‚úÖ CAMBIO CR√çTICO: Mostrar TODOS los niveles sin filtrar por carrera
  const availableLevels = useMemo(() => {
    // Si no es estudiante, no mostrar niveles
    if (role !== "student") return [];

    // Para estudiantes, mostrar TODOS los niveles ordenados por sort_order
    return levels.slice().sort((a, b) => a.sort_order - b.sort_order);
  }, [levels, role]);

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="page-header">
        <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
          <div>
            <div className="page-subtitle">Panel Administrador</div>
            <h1 className="page-title">Gesti√≥n de Usuarios</h1>
          </div>
          <div className="flex gap-2">
            <button
              className="btn-secondary"
              onClick={() => nav("/admin/content")}
            >
              üìö Gesti√≥n de Contenido
            </button>
            <button
              className="btn-primary"
              onClick={() => supabase.auth.signOut()}
            >
              Cerrar sesi√≥n
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-6 space-y-6">
        {msg && (
          <div className={msg.includes("‚úÖ") ? "alert-success" : "alert-error"}>
            <pre className="whitespace-pre-wrap">{msg}</pre>
          </div>
        )}

        {/* Formulario */}
        {showForm && (
          <form
            onSubmit={editingId ? updateUser : createUser}
            className="card p-6 space-y-4"
          >
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold">
                {editingId ? "Editar Usuario" : "Crear Usuario"}
              </h2>
              <button
                type="button"
                className="btn-secondary"
                onClick={resetForm}
              >
                Cancelar
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">Rol</label>
                <select
                  className="input"
                  value={role}
                  onChange={(e) =>
                    setRole(e.target.value as "student" | "teacher")
                  }
                  disabled={!!editingId}
                >
                  <option value="student">Estudiante</option>
                  <option value="teacher">Docente</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">
                  Carrera *
                </label>
                <select
                  className="input"
                  value={careerId}
                  onChange={(e) => {
                    setCareerId(e.target.value ? Number(e.target.value) : "");
                  }}
                >
                  <option value="">Selecciona...</option>
                  {careers.map((c) => (
                    <option key={c.id} value={c.id}>
                      {c.name}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">
                  Turno *
                </label>
                <select
                  className="input"
                  value={shift}
                  onChange={(e) => setShift(e.target.value as Shift)}
                >
                  <option value="tarde">Tarde</option>
                  <option value="noche">Noche</option>
                </select>
              </div>
            </div>

            {/* ‚úÖ CAMBIO: Selector de nivel siempre visible para estudiantes */}
            {role === "student" && (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">
                    Nivel * (Aplica para todas las carreras)
                  </label>
                  <select
                    className="input"
                    value={levelId}
                    onChange={(e) => {
                      const newLevelId = e.target.value
                        ? Number(e.target.value)
                        : "";
                      setLevelId(newLevelId);
                      console.log("üìù Nivel seleccionado:", newLevelId);
                    }}
                  >
                    <option value="">Selecciona un nivel...</option>
                    {availableLevels.map((l) => (
                      <option key={l.id} value={l.id}>
                        {l.name}
                      </option>
                    ))}
                  </select>
                  {availableLevels.length === 0 && (
                    <p className="text-xs text-red-600 mt-1">
                      ‚ö†Ô∏è No hay niveles configurados en la base de datos
                    </p>
                  )}
                  {availableLevels.length > 0 && (
                    <p className="text-xs text-gray-500 mt-1">
                      {availableLevels.length} niveles disponibles
                    </p>
                  )}
                </div>
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">
                  Nombres *
                </label>
                <input
                  className="input"
                  value={firstNames}
                  onChange={(e) => setFirstNames(e.target.value)}
                  placeholder="Juan Carlos"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">
                  Apellido Paterno
                </label>
                <input
                  className="input"
                  value={lastPat}
                  onChange={(e) => setLastPat(e.target.value)}
                  placeholder="P√©rez"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">
                  Apellido Materno
                </label>
                <input
                  className="input"
                  value={lastMat}
                  onChange={(e) => setLastMat(e.target.value)}
                  placeholder="G√≥mez"
                />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">
                  Celular *
                </label>
                <input
                  className="input"
                  value={phone}
                  onChange={(e) => setPhone(e.target.value)}
                  placeholder="70707070"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">
                  Correo (opcional)
                </label>
                <input
                  className="input"
                  value={contactEmail}
                  onChange={(e) => setContactEmail(e.target.value)}
                  placeholder="correo@gmail.com"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">
                Gustos (opcional)
              </label>
              <textarea
                className="input"
                rows={2}
                value={likes}
                onChange={(e) => setLikes(e.target.value)}
                placeholder="M√∫sica, deportes, etc."
              />
            </div>

            {!editingId && (
              <div>
                <label className="block text-sm font-medium mb-1">
                  Contrase√±a temporal
                </label>
                <div className="flex gap-2">
                  <input
                    className="input"
                    value={tempPassword}
                    onChange={(e) => setTempPassword(e.target.value)}
                  />
                  <button
                    type="button"
                    className="btn-secondary"
                    onClick={() => setTempPassword(randomPass())}
                  >
                    Generar
                  </button>
                </div>
              </div>
            )}

            <button disabled={creating} className="btn-primary w-full">
              {creating ? "Guardando..." : editingId ? "Actualizar" : "Crear"}
            </button>
          </form>
        )}

        {/* TABLA DOCENTES */}
        <section className="card p-6 space-y-4">
          <div className="flex items-center justify-between gap-3 flex-wrap">
            <h2 className="text-lg font-semibold">Docentes</h2>

            <div className="flex gap-2">
              <input
                className="input w-64"
                placeholder="Buscar docente..."
                value={teacherSearch}
                onChange={(e) => setTeacherSearch(e.target.value)}
              />
              <button className="btn-secondary" onClick={loadTeachers}>
                {loadingTeachers ? "Cargando..." : "Actualizar"}
              </button>
              {!showForm && (
                <button
                  className="btn-primary"
                  onClick={() => {
                    setRole("teacher");
                    setShowForm(true);
                  }}
                >
                  + Nuevo Docente
                </button>
              )}
            </div>
          </div>

          <div className="table-container">
            <table className="table">
              <thead>
                <tr>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleTeacherSort("code")}
                  >
                    C√≥digo{" "}
                    {teacherSort.column === "code" &&
                      (teacherSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleTeacherSort("full_name")}
                  >
                    Nombre{" "}
                    {teacherSort.column === "full_name" &&
                      (teacherSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleTeacherSort("career_id")}
                  >
                    Carrera{" "}
                    {teacherSort.column === "career_id" &&
                      (teacherSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleTeacherSort("shift")}
                  >
                    Turno{" "}
                    {teacherSort.column === "shift" &&
                      (teacherSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleTeacherSort("phone")}
                  >
                    Celular{" "}
                    {teacherSort.column === "phone" &&
                      (teacherSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {filteredTeachers.map((t) => (
                  <tr key={t.id}>
                    <td className="font-mono font-medium">{t.code ?? "-"}</td>
                    <td>{t.full_name ?? "-"}</td>
                    <td className="text-sm">
                      {careers.find((c) => c.id === t.career_id)?.name ?? "-"}
                    </td>
                    <td className="text-sm">{t.shift ?? "-"}</td>
                    <td className="text-sm">{t.phone ?? "-"}</td>
                    <td>
                      <div className="flex gap-2">
                        <button
                          className="btn-secondary text-sm px-2 py-1"
                          onClick={() => openEdit(t)}
                        >
                          Editar
                        </button>
                        <button
                          className="btn-secondary text-sm px-2 py-1"
                          onClick={() =>
                            openResetPassword(t.id, t.code ?? t.id)
                          }
                        >
                          Reset Pass
                        </button>
                        <button
                          className="btn-danger text-sm px-2 py-1"
                          onClick={() => deleteUser(t.id, t.code ?? t.id)}
                        >
                          Eliminar
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
                {filteredTeachers.length === 0 && (
                  <tr>
                    <td className="text-center text-gray-500 py-8" colSpan={6}>
                      {loadingTeachers ? "Cargando..." : "Sin resultados"}
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>

        {/* TABLA ESTUDIANTES */}
        <section className="card p-6 space-y-4">
          <div className="flex items-center justify-between gap-3 flex-wrap">
            <h2 className="text-lg font-semibold">Estudiantes</h2>

            <div className="flex gap-2 flex-wrap">
              <select
                className="input w-48"
                value={filterCareer}
                onChange={(e) =>
                  setFilterCareer(e.target.value ? Number(e.target.value) : "")
                }
              >
                <option value="">Todas las carreras</option>
                {careers.map((c) => (
                  <option key={c.id} value={c.id}>
                    {c.name}
                  </option>
                ))}
              </select>

              <input
                className="input w-64"
                placeholder="Buscar estudiante..."
                value={studentSearch}
                onChange={(e) => setStudentSearch(e.target.value)}
              />
              <button className="btn-secondary" onClick={loadStudents}>
                {loadingStudents ? "Cargando..." : "Actualizar"}
              </button>
              {!showForm && (
                <button
                  className="btn-primary"
                  onClick={() => {
                    setRole("student");
                    setShowForm(true);
                  }}
                >
                  + Nuevo Estudiante
                </button>
              )}
            </div>
          </div>

          <div className="table-container">
            <table className="table">
              <thead>
                <tr>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleStudentSort("code")}
                  >
                    C√≥digo{" "}
                    {studentSort.column === "code" &&
                      (studentSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleStudentSort("full_name")}
                  >
                    Nombre{" "}
                    {studentSort.column === "full_name" &&
                      (studentSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleStudentSort("career_id")}
                  >
                    Carrera{" "}
                    {studentSort.column === "career_id" &&
                      (studentSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleStudentSort("level_name")}
                  >
                    Nivel{" "}
                    {studentSort.column === "level_name" &&
                      (studentSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleStudentSort("shift")}
                  >
                    Turno{" "}
                    {studentSort.column === "shift" &&
                      (studentSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th
                    className="cursor-pointer hover:bg-gray-100"
                    onClick={() => toggleStudentSort("phone")}
                  >
                    Celular{" "}
                    {studentSort.column === "phone" &&
                      (studentSort.direction === "asc" ? "‚Üë" : "‚Üì")}
                  </th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {filteredStudents.map((s) => (
                  <tr key={s.id}>
                    <td className="font-mono font-medium">{s.code ?? "-"}</td>
                    <td>{s.full_name ?? "-"}</td>
                    <td className="text-sm">
                      {careers.find((c) => c.id === s.career_id)?.name ?? "-"}
                    </td>
                    <td className="text-sm">
                      <span className="badge-primary">
                        {s.current_level_name ?? "Sin nivel"}
                      </span>
                    </td>
                    <td className="text-sm">{s.shift ?? "-"}</td>
                    <td className="text-sm">{s.phone ?? "-"}</td>
                    <td>
                      <div className="flex gap-2">
                        <button
                          className="btn-secondary text-sm px-2 py-1"
                          onClick={() => openEdit(s)}
                        >
                          Editar
                        </button>
                        <button
                          className="btn-secondary text-sm px-2 py-1"
                          onClick={() =>
                            openResetPassword(s.id, s.code ?? s.id)
                          }
                        >
                          Reset Pass
                        </button>
                        <button
                          className="btn-danger text-sm px-2 py-1"
                          onClick={() => deleteUser(s.id, s.code ?? s.id)}
                        >
                          Eliminar
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
                {filteredStudents.length === 0 && (
                  <tr>
                    <td className="text-center text-gray-500 py-8" colSpan={7}>
                      {loadingStudents ? "Cargando..." : "Sin resultados"}
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </main>

      {/* MODAL RESET PASSWORD */}
      {showResetModal && (
        <div className="modal-overlay" onClick={() => setShowResetModal(false)}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3 className="text-lg font-semibold">
                Resetear Contrase√±a - {resetUserCode}
              </h3>
            </div>

            <div className="modal-body space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">
                  Nueva Contrase√±a
                </label>
                <div className="flex gap-2">
                  <input
                    className="input flex-1"
                    value={newPassword}
                    onChange={(e) => setNewPassword(e.target.value)}
                    placeholder="Ingresa la nueva contrase√±a"
                  />
                  <button
                    type="button"
                    className="btn-secondary"
                    onClick={() => setNewPassword(randomPass())}
                  >
                    Generar
                  </button>
                </div>
              </div>
            </div>

            <div className="modal-footer">
              <button
                className="btn-secondary"
                onClick={() => setShowResetModal(false)}
              >
                Cancelar
              </button>
              <button
                className="btn-primary"
                onClick={resetPassword}
                disabled={resetting}
              >
                {resetting ? "Reseteando..." : "Resetear Contrase√±a"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


----------------------------------------------------------------------------------------- 
// src\pages\Login.tsx
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/pages/Login.tsx
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { supabase } from "../lib/supabase";
import { useRole } from "../lib/useRole";

function toEmail(userOrEmail: string) {
  const u = userOrEmail.trim().toLowerCase();
  if (!u) return "";
  if (u.includes("@")) return u;
  return `${u}@cea.local`;
}

export default function Login() {
  const nav = useNavigate();
  const { loading, session } = useRole();

  const [user, setUser] = useState("");
  const [pass, setPass] = useState("");
  const [msg, setMsg] = useState<string | null>(null);
  const [sending, setSending] = useState(false);

  useEffect(() => {
    if (!loading && session) nav("/app", { replace: true });
  }, [loading, session, nav]);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setMsg(null);
    setSending(true);

    const email = toEmail(user);
    if (!email || !pass) {
      setSending(false);
      setMsg("Completa usuario/c√≥digo y contrase√±a.");
      return;
    }

    const { error } = await supabase.auth.signInWithPassword({
      email,
      password: pass,
    });

    setSending(false);

    if (error) {
      setMsg("Credenciales incorrectas. Verifica tu c√≥digo y contrase√±a.");
      return;
    }

    nav("/app", { replace: true });
  }

  if (loading)
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="spinner w-8 h-8"></div>
      </div>
    );

  return (
    <div className="min-h-screen flex items-center justify-center p-6 bg-gray-50">
      <div className="w-full max-w-md">
        {/* Logo y t√≠tulo */}
        <div className="text-center mb-8">
          <img
            src="src/assets/logo-cea.png"
            alt="Logo CEA"
            className="mx-auto mb-4 h-48 w-auto object-contain"
          />

          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            Plataforma CEA
          </h1>
          <p className="text-gray-500">
            Centro de Educaci√≥n Alternativa Madre Mar√≠a Oliva
          </p>
        </div>

        {/* Formulario */}
        <form onSubmit={onSubmit} className="card p-6 space-y-5">
          <div className="space-y-2">
            <label className="block text-sm font-medium text-gray-700">
              C√≥digo de usuario
            </label>
            <input
              type="text"
              className="input"
              value={user}
              onChange={(e) => setUser(e.target.value)}
              placeholder="Ej: ADMIN, SI0001"
              autoComplete="username"
              autoFocus
            />
            <p className="text-xs text-gray-500">
              Ingresa solo tu c√≥digo (sin @cea.local)
            </p>
          </div>

          <div className="space-y-2">
            <label className="block text-sm font-medium text-gray-700">
              Contrase√±a
            </label>
            <input
              type="password"
              className="input"
              value={pass}
              onChange={(e) => setPass(e.target.value)}
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              autoComplete="current-password"
            />
          </div>

          {msg && (
            <div className="alert-error">
              <div className="flex items-start gap-2">
                <svg
                  className="w-5 h-5 flex-shrink-0 mt-0.5"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fillRule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                    clipRule="evenodd"
                  />
                </svg>
                <div className="text-sm">{msg}</div>
              </div>
            </div>
          )}

          <button
            type="submit"
            disabled={sending}
            className="btn-primary w-full"
          >
            {sending ? (
              <span className="flex items-center justify-center gap-2">
                <span className="spinner w-4 h-4"></span>
                Ingresando...
              </span>
            ) : (
              "Ingresar"
            )}
          </button>

          <div className="text-center pt-2">
            <p className="text-xs text-gray-500">
              ¬øOlvidaste tu contrase√±a?{" "}
              <span className="text-cea-primary font-medium">
                Contacta al administrador
              </span>
            </p>
          </div>
        </form>

        {/* Footer */}
        <div className="mt-6 text-center">
          <p className="text-xs text-gray-400">
            Ing. Sergio M. Alcocer Valenzuela - Cochabamba, Bolivia
          </p>
        </div>
      </div>
    </div>
  );
}


----------------------------------------------------------------------------------------- 
// src\pages\ModulePlayer.tsx
----------------------------------------------------------------------------------------- 
import { useEffect, useMemo, useState } from "react";
import { Navigate, useNavigate, useParams } from "react-router-dom";
import { supabase } from "../lib/supabase";
import { useRole } from "../lib/useRole";

type Lesson = { id: number; title: string; sort_order: number };
type Section = {
  id: number;
  lesson_id: number;
  title: string;
  sort_order: number;
  kind: "text" | "video" | "image" | string;
  payload: any;
};

function clampPct(x: number) {
  return Math.max(0, Math.min(100, Math.round(x)));
}

function ProgressBar({ value }: { value: number }) {
  const v = clampPct(value);
  return (
    <div className="w-full">
      <div className="flex justify-between text-sm mb-1">
        <span className="font-medium">Progreso del m√≥dulo</span>
        <span>{v}%</span>
      </div>
      <div className="h-3 rounded-full bg-gray-200 overflow-hidden">
        <div className="h-3 bg-black rounded-full" style={{ width: `${v}%` }} />
      </div>
    </div>
  );
}

function renderSection(section: Section) {
  const p = section.payload ?? {};
  if (section.kind === "text") {
    return (
      <div
        className="prose max-w-none"
        dangerouslySetInnerHTML={{ __html: String(p.html ?? "") }}
      />
    );
  }

  if (section.kind === "video") {
    const url = String(p.url ?? "");
    return (
      <div className="space-y-3">
        <div className="font-semibold">{p.title ?? "Video"}</div>
        <div className="aspect-video w-full overflow-hidden rounded-2xl border bg-black">
          <iframe
            className="w-full h-full"
            src={url}
            title="video"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowFullScreen
          />
        </div>
      </div>
    );
  }

  if (section.kind === "image") {
    const url = String(p.url ?? "");
    return (
      <div className="space-y-3">
        <div className="font-semibold">{p.title ?? "Imagen"}</div>
        <img src={url} className="w-full rounded-2xl border" />
      </div>
    );
  }

  return (
    <div className="text-sm text-gray-600">
      Tipo no soportado todav√≠a: <b>{section.kind}</b>
    </div>
  );
}

export default function ModulePlayer() {
  const nav = useNavigate();
  const { moduleId } = useParams();
  const { loading, session, profile } = useRole();

  const [moduleName, setModuleName] = useState<string>("M√≥dulo");
  const [lessons, setLessons] = useState<Lesson[]>([]);
  const [sections, setSections] = useState<Section[]>([]);
  const [doneIds, setDoneIds] = useState<Set<number>>(new Set());
  const [activeLessonId, setActiveLessonId] = useState<number | null>(null);
  const [activeSectionId, setActiveSectionId] = useState<number | null>(null);
  const [msg, setMsg] = useState<string | null>(null);

  const mid = Number(moduleId);

  useEffect(() => {
    if (!session || !Number.isFinite(mid)) return;

    async function load() {
      setMsg(null);

      // m√≥dulo
      const modRes = await supabase
        .from("modules")
        .select("id,name")
        .eq("id", mid)
        .single();

      if (modRes.error) {
        setMsg("No se pudo cargar el m√≥dulo: " + modRes.error.message);
        return;
      }
      setModuleName(String(modRes.data?.name ?? "M√≥dulo"));

      // lecciones
      const lesRes = await supabase
        .from("lessons")
        .select("id,title,sort_order")
        .eq("module_id", mid)
        .order("sort_order");

      if (lesRes.error) {
        setMsg("No se pudo cargar lecciones: " + lesRes.error.message);
        return;
      }

      const ls = (lesRes.data ?? []) as Lesson[];
      setLessons(ls);

      const firstLesson = ls[0]?.id ?? null;
      setActiveLessonId(firstLesson);

      if (!firstLesson) {
        setSections([]);
        setActiveSectionId(null);
        return;
      }

      // secciones (todas las lecciones del m√≥dulo)
      const ids = ls.map((x) => x.id);
      const secRes = await supabase
        .from("lesson_sections")
        .select("id,lesson_id,title,sort_order,kind,payload")
        .in("lesson_id", ids)
        .order("lesson_id")
        .order("sort_order");

      if (secRes.error) {
        setMsg("No se pudo cargar secciones: " + secRes.error.message);
        return;
      }

      const ss = (secRes.data ?? []) as Section[];
      setSections(ss);

      // progreso completado
      const progRes = await supabase
        .from("student_section_progress")
        .select("section_id")
        .eq("student_id", session.user.id);

      if (progRes.error) {
        setMsg("No se pudo cargar progreso: " + progRes.error.message);
        return;
      }

      const set = new Set<number>(
        (progRes.data ?? []).map((r: any) => r.section_id)
      );
      setDoneIds(set);

      // secci√≥n inicial
      const firstSection =
        ss.find((s) => s.lesson_id === firstLesson)?.id ?? null;
      setActiveSectionId(firstSection);
    }

    load();
  }, [session, mid]);

  const sectionsByLesson = useMemo(() => {
    const map = new Map<number, Section[]>();
    for (const s of sections) {
      const arr = map.get(s.lesson_id) ?? [];
      arr.push(s);
      map.set(s.lesson_id, arr);
    }
    return map;
  }, [sections]);

  const activeSections = useMemo(() => {
    if (!activeLessonId) return [];
    return sectionsByLesson.get(activeLessonId) ?? [];
  }, [sectionsByLesson, activeLessonId]);

  const activeSection = useMemo(() => {
    return sections.find((s) => s.id === activeSectionId) ?? null;
  }, [sections, activeSectionId]);

  const totalSections = sections.length;
  const completedCount = doneIds.size;
  const progress = totalSections ? (completedCount / totalSections) * 100 : 0;
  const canFinal = clampPct(progress) >= 100;

  async function markDone() {
    if (!session || !activeSectionId) return;

    const { error } = await supabase.from("student_section_progress").insert({
      student_id: session.user.id,
      section_id: activeSectionId,
      completed: true,
    });

    // si ya existe (PK), lo ignoramos en UI
    if (!error) {
      setDoneIds((prev) => new Set(prev).add(activeSectionId));
    }
  }

  function gotoPrevNext(dir: -1 | 1) {
    if (!activeLessonId || !activeSectionId) return;

    const flat = sections
      .slice()
      .sort((a, b) => a.lesson_id - b.lesson_id || a.sort_order - b.sort_order);

    const idx = flat.findIndex((s) => s.id === activeSectionId);
    const next = flat[idx + dir];
    if (!next) return;

    setActiveLessonId(next.lesson_id);
    setActiveSectionId(next.id);
  }

  if (loading) return <div className="p-6">Cargando...</div>;
  if (!session) return <Navigate to="/login" replace />;

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
          <div>
            <div className="text-sm text-gray-500">CEA Madre Mar√≠a Oliva</div>
            <h1 className="text-xl font-bold">{moduleName}</h1>
          </div>
          <div className="flex gap-2">
            <button
              className="rounded-xl px-3 py-2 border"
              onClick={() => nav("/student", { replace: true })}
            >
              Volver
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-6 grid grid-cols-1 md:grid-cols-[300px_1fr] gap-4">
        {/* Sidebar */}
        <aside className="bg-white rounded-2xl shadow p-4 space-y-4 h-fit">
          <div className="space-y-2">
            <div className="text-sm text-gray-500">Alumno</div>
            <div className="font-semibold">
              {profile?.full_name ?? profile?.code ?? "Estudiante"}
            </div>
          </div>

          <ProgressBar value={progress} />

          <div className="text-sm text-gray-600">
            Evaluaci√≥n final:{" "}
            <b className={canFinal ? "text-green-600" : "text-gray-500"}>
              {canFinal ? "Habilitada ‚úÖ" : "Bloqueada üîí (100%)"}
            </b>
          </div>

          <div className="border-t pt-3 space-y-2">
            <div className="text-sm font-semibold">√çndice</div>
            {lessons.map((l) => (
              <button
                key={l.id}
                className={
                  "w-full text-left rounded-xl px-3 py-2 border " +
                  (activeLessonId === l.id ? "bg-gray-50" : "bg-white")
                }
                onClick={() => {
                  setActiveLessonId(l.id);
                  const first = (sectionsByLesson.get(l.id) ?? [])[0];
                  setActiveSectionId(first?.id ?? null);
                }}
              >
                <div className="font-medium">{l.title}</div>
                <div className="text-xs text-gray-500">
                  {(sectionsByLesson.get(l.id) ?? []).length} secciones
                </div>
              </button>
            ))}
          </div>

          {/* Secciones de la lecci√≥n activa */}
          {activeLessonId && (
            <div className="border-t pt-3 space-y-2">
              <div className="text-sm font-semibold">Secciones</div>
              {activeSections.map((s) => {
                const done = doneIds.has(s.id);
                return (
                  <button
                    key={s.id}
                    className={
                      "w-full text-left rounded-xl px-3 py-2 border " +
                      (activeSectionId === s.id ? "bg-gray-50" : "bg-white")
                    }
                    onClick={() => setActiveSectionId(s.id)}
                  >
                    <div className="flex items-center justify-between">
                      <span className="text-sm">{s.title}</span>
                      <span className="text-xs">{done ? "‚úÖ" : ""}</span>
                    </div>
                    <div className="text-xs text-gray-500">{s.kind}</div>
                  </button>
                );
              })}
            </div>
          )}
        </aside>

        {/* Contenido */}
        <section className="bg-white rounded-2xl shadow p-6 space-y-4">
          {msg && (
            <pre className="text-sm bg-gray-50 border rounded-xl p-3 whitespace-pre-wrap">
              {msg}
            </pre>
          )}

          {!activeSection ? (
            <div className="text-gray-600">No hay secciones a√∫n.</div>
          ) : (
            <>
              <div className="flex items-start justify-between gap-3">
                <div>
                  <div className="text-sm text-gray-500">
                    {activeSection.kind.toUpperCase()}
                  </div>
                  <h2 className="text-xl font-bold">{activeSection.title}</h2>
                </div>

                <button
                  className="rounded-xl px-3 py-2 border"
                  onClick={markDone}
                  disabled={doneIds.has(activeSection.id)}
                  title={
                    doneIds.has(activeSection.id)
                      ? "Ya completado"
                      : "Marcar como completado"
                  }
                >
                  {doneIds.has(activeSection.id)
                    ? "Completado ‚úÖ"
                    : "Marcar completado"}
                </button>
              </div>

              <div className="border-t pt-4">
                {renderSection(activeSection)}
              </div>

              <div className="flex gap-2 pt-2">
                <button
                  className="rounded-xl px-3 py-2 border w-full"
                  onClick={() => gotoPrevNext(-1)}
                >
                  ‚Üê Anterior
                </button>
                <button
                  className="rounded-xl px-3 py-2 border w-full"
                  onClick={() => gotoPrevNext(1)}
                >
                  Siguiente ‚Üí
                </button>
              </div>

              <button
                className="rounded-xl px-3 py-2 bg-black text-white w-full disabled:opacity-50"
                disabled={!canFinal}
                onClick={() =>
                  alert(
                    "Luego: evaluaci√≥n final del m√≥dulo (docente califica manualmente)"
                  )
                }
              >
                Evaluaci√≥n Final del M√≥dulo
              </button>
            </>
          )}
        </section>
      </main>
    </div>
  );
}


----------------------------------------------------------------------------------------- 
// src\pages\StudentDashboard.tsx
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/pages/StudentDashboard.tsx
import { useEffect, useMemo, useState } from "react";
import { Navigate, useNavigate } from "react-router-dom";
import { supabase } from "../lib/supabase";
import { useRole } from "../lib/useRole";

type LevelRow = { id: number; name: string };

type ModuleRow = {
  id: number;
  level_id: number;
  title: string;
  sort_order: number;
  is_active: boolean | null;
};

type ModuleProgress = {
  module_id: number;
  progress_percent: number;
  is_unlocked_final: boolean;
};

type CareerRow = { id: number; name: string };

type ModuleGradeRow = {
  student_id: string;
  module_id: number;
  ser: number | null;
  saber: number | null;
  hacer_proceso: number | null;
  hacer_producto: number | null;
  decidir: number | null;
  auto_ser: number | null;
  auto_decidir: number | null;
};

type GradeHistoryRow = {
  module_id: number;
  module_name: string;
  module_order: number;
  level_id: number;
  level_name: string;
  level_order: number;
  ser: number;
  saber: number;
  hacer_proceso: number;
  hacer_producto: number;
  decidir: number;
  auto_ser: number;
  auto_decidir: number;
  total: number;
  observation: string;
};

function clampPct(x: number) {
  return Math.max(0, Math.min(100, Math.round(x)));
}

function ProgressBar({ value }: { value: number }) {
  const v = clampPct(value);
  return (
    <div className="w-full">
      <div className="flex justify-between text-sm mb-1 text-slate-300">
        <span className="font-medium">Progreso del m√≥dulo</span>
        <span>{v}%</span>
      </div>
      <div className="h-3 rounded-full bg-slate-800 overflow-hidden">
        <div className="h-3 bg-white rounded-full" style={{ width: `${v}%` }} />
      </div>
    </div>
  );
}

const AVATARS = Array.from({ length: 20 }, (_, i) => {
  const key = `av${i + 1}`;
  return {
    key,
    label: `Avatar ${i + 1}`,
    url: `https://api.dicebear.com/9.x/thumbs/svg?seed=${key}-cea`,
  };
});

export default function StudentDashboard() {
  const nav = useNavigate();
  const { loading, session, profile } = useRole();

  const [careerName, setCareerName] = useState<string>("(sin carrera)");
  const [level, setLevel] = useState<LevelRow | null>(null);

  const [modules, setModules] = useState<ModuleRow[]>([]);
  const [progressByModule, setProgressByModule] = useState<
    Record<number, ModuleProgress>
  >({});
  const [msg, setMsg] = useState<string | null>(null);

  const [avatarOpen, setAvatarOpen] = useState(false);
  const [savingAvatar, setSavingAvatar] = useState(false);

  const [gradesOpen, setGradesOpen] = useState<Set<number>>(new Set());
  const [gradesByModule, setGradesByModule] = useState<
    Record<number, ModuleGradeRow | null | undefined>
  >({});
  const [gradesLoadingByModule, setGradesLoadingByModule] = useState<
    Record<number, boolean>
  >({});

  // ‚úÖ NOTAS HIST√ìRICAS
  const [historyOpen, setHistoryOpen] = useState(false);
  const [historyData, setHistoryData] = useState<GradeHistoryRow[]>([]);
  const [historyLoading, setHistoryLoading] = useState(false);

  function num0(x: number | null | undefined) {
    return typeof x === "number" && Number.isFinite(x) ? x : 0;
  }

  function calcTotal(g: ModuleGradeRow, pct: number) {
    const hpSuggested = Math.round((clampPct(pct) / 100) * 20);
    const hpFinal =
      g.hacer_proceso === null || g.hacer_proceso === undefined
        ? hpSuggested
        : num0(g.hacer_proceso);

    return (
      num0(g.ser) +
      num0(g.saber) +
      hpFinal +
      num0(g.hacer_producto) +
      num0(g.decidir) +
      num0(g.auto_ser) +
      num0(g.auto_decidir)
    );
  }

  function getObservation(total: number) {
    if (total >= 76) return "Promovido Excelente";
    if (total >= 51) return "Promovido";
    if (total >= 20) return "Postergado";
    return "Retirado";
  }

  async function loadGrades(moduleId: number) {
    if (!session) return;

    setGradesLoadingByModule((p) => ({ ...p, [moduleId]: true }));

    const res = await supabase
      .from("module_grades")
      .select(
        "student_id,module_id,ser,saber,hacer_proceso,hacer_producto,decidir,auto_ser,auto_decidir"
      )
      .eq("student_id", session.user.id)
      .eq("module_id", moduleId)
      .maybeSingle();

    setGradesLoadingByModule((p) => ({ ...p, [moduleId]: false }));

    if (res.error) {
      setMsg("No se pudo cargar calificaciones: " + res.error.message);
      setGradesByModule((p) => ({ ...p, [moduleId]: null }));
      return;
    }

    setGradesByModule((p) => ({
      ...p,
      [moduleId]: (res.data as ModuleGradeRow | null) ?? null,
    }));
  }

  async function loadHistory() {
    if (!session) return;

    setHistoryLoading(true);

    const res = await supabase
      .from("v_student_grade_history")
      .select(
        "module_id,module_name,module_order,level_id,level_name,level_order,ser,saber,hacer_proceso,hacer_producto,decidir,auto_ser,auto_decidir,total,observation"
      )
      .eq("student_id", session.user.id)
      .order("level_order", { ascending: true })
      .order("module_order", { ascending: true });

    setHistoryLoading(false);

    if (res.error) {
      setMsg("No se pudo cargar historial: " + res.error.message);
      return;
    }

    setHistoryData((res.data ?? []) as GradeHistoryRow[]);
  }

  function toggleGrades(moduleId: number) {
    setGradesOpen((prev) => {
      const n = new Set(prev);
      if (n.has(moduleId)) n.delete(moduleId);
      else n.add(moduleId);
      return n;
    });

    if (gradesByModule[moduleId] === undefined) {
      void loadGrades(moduleId);
    }
  }

  function openHistory() {
    setHistoryOpen(true);
    loadHistory();
  }

  async function logout() {
    await supabase.auth.signOut();
    nav("/login", { replace: true });
  }

  const displayName = useMemo(() => {
    if (!profile) return "Estudiante";
    const parts = [
      profile.first_names?.trim(),
      profile.last_name_pat?.trim(),
      profile.last_name_mat?.trim(),
    ].filter(Boolean) as string[];
    if (parts.length) return parts.join(" ");
    return profile.full_name?.trim() || profile.code || "Estudiante";
  }, [profile]);

  const avatar = useMemo(() => {
    const key = profile?.avatar_key?.trim() || "av1";
    return AVATARS.find((a) => a.key === key) ?? AVATARS[0];
  }, [profile?.avatar_key]);

  useEffect(() => {
    if (!session) return;

    async function loadAll() {
      setMsg(null);

      if (profile?.career_id) {
        const c = await supabase
          .from("careers")
          .select("id,name")
          .eq("id", profile.career_id)
          .single();

        if (!c.error && c.data) setCareerName((c.data as CareerRow).name);
      }

      const enr = await supabase
        .from("enrollments")
        .select("level_id")
        .eq("student_id", session.user.id)
        .order("created_at", { ascending: false })
        .limit(1)
        .maybeSingle();

      if (enr.error) {
        setMsg("No se pudo leer tu nivel: " + enr.error.message);
        return;
      }

      const levelId = enr.data?.level_id;
      if (!levelId) {
        setMsg("No tienes nivel asignado.");
        return;
      }

      const lv = await supabase
        .from("levels")
        .select("id,name")
        .eq("id", levelId)
        .single();
      if (!lv.error && lv.data) setLevel(lv.data as LevelRow);

      const mods = await supabase
        .from("modules")
        .select("id,level_id,title,sort_order,is_active")
        .eq("level_id", levelId)
        .order("sort_order");

      if (mods.error) {
        setMsg("No se pudo cargar m√≥dulos: " + mods.error.message);
        return;
      }

      const modList = ((mods.data ?? []) as ModuleRow[]).filter(
        (m) => m.is_active !== false
      );
      setModules(modList);

      if (modList.length === 0) {
        setMsg("Este nivel no tiene m√≥dulos.");
        return;
      }

      const moduleIds = modList.map((m) => m.id);

      // ‚úÖ Cargar progreso usando la vista corregida
      const progRes = await supabase
        .from("v_module_progress")
        .select(
          "module_id,completed_sections,total_sections,progress_percent,is_unlocked_final"
        )
        .eq("student_id", session.user.id)
        .in("module_id", moduleIds);

      if (progRes.error) {
        console.error("Error cargando progreso:", progRes.error);
        setMsg("No se pudo cargar progreso: " + progRes.error.message);
        return;
      }

      console.log("Progreso raw:", progRes.data);

      const pbm: Record<number, ModuleProgress> = {};
      for (const r of (progRes.data ?? []) as any[]) {
        const pct = Number(r.progress_percent ?? 0);
        pbm[r.module_id] = {
          module_id: r.module_id,
          progress_percent: clampPct(pct),
          is_unlocked_final: Boolean(r.is_unlocked_final),
        };
        console.log(
          `M√≥dulo ${r.module_id}: ${pct}% (${r.completed_sections}/${r.total_sections})`
        );
      }

      // Inicializar m√≥dulos sin progreso en 0%
      for (const m of modList) {
        if (!pbm[m.id]) {
          pbm[m.id] = {
            module_id: m.id,
            progress_percent: 0,
            is_unlocked_final: false,
          };
          console.log(`M√≥dulo ${m.id}: 0% (sin progreso)`);
        }
      }

      setProgressByModule(pbm);
    }

    loadAll();
  }, [session, profile]);

  const unlockedMap = useMemo(() => {
    const map: Record<number, boolean> = {};
    let okPrev = true;
    const ordered = modules.slice().sort((a, b) => a.sort_order - b.sort_order);

    for (const m of ordered) {
      map[m.id] = okPrev;
      const pct = progressByModule[m.id]?.progress_percent ?? 0;
      if (pct < 70) okPrev = false;
    }
    return map;
  }, [modules, progressByModule]);

  async function setAvatarKey(newKey: string) {
    if (!session) return;
    setSavingAvatar(true);
    setMsg(null);

    const upd = await supabase
      .from("profiles")
      .update({ avatar_key: newKey })
      .eq("id", session.user.id);

    setSavingAvatar(false);

    if (upd.error) {
      setMsg("No se pudo actualizar avatar: " + upd.error.message);
      return;
    }

    setAvatarOpen(false);
    window.location.reload();
  }

  if (loading) return <div className="p-6">Cargando...</div>;
  if (!session) return <Navigate to="/login" replace />;

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100">
      <header className="bg-slate-950 border-b border-slate-800">
        <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
          <div>
            <div className="text-sm text-slate-400">CEA Madre Mar√≠a Oliva</div>
            <h1 className="text-xl font-bold">Panel del Estudiante</h1>
          </div>

          <div className="flex gap-2">
            <button
              onClick={openHistory}
              className="rounded-xl px-3 py-2 border border-slate-800 hover:bg-slate-900"
            >
              üìä Notas Hist√≥ricas
            </button>
            <button
              onClick={logout}
              className="rounded-xl px-3 py-2 bg-white text-black"
            >
              Cerrar sesi√≥n
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-6 py-6 space-y-6">
        <section className="bg-slate-950 rounded-2xl border border-slate-800 p-6 space-y-4">
          <div className="flex flex-col md:flex-row md:items-center gap-4 justify-between">
            <div className="flex items-center gap-4">
              <div className="h-16 w-16 rounded-2xl border border-slate-800 bg-slate-900 overflow-hidden flex items-center justify-center">
                <img
                  src={avatar.url}
                  alt={avatar.label}
                  className="h-full w-full"
                />
              </div>

              <div>
                <div className="text-sm text-slate-400">
                  {profile?.code ?? ""}
                </div>
                <div className="text-xl font-bold">{displayName}</div>
                <div className="text-sm text-slate-300">
                  {careerName} ¬∑ {level?.name ?? "(sin nivel)"} ¬∑{" "}
                  {profile?.shift ?? "(sin turno)"}
                </div>
              </div>
            </div>

            <button
              className="rounded-xl px-3 py-2 border border-slate-800 hover:bg-slate-900"
              onClick={() => setAvatarOpen(true)}
            >
              Cambiar avatar
            </button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div className="rounded-2xl border border-slate-800 p-4 bg-slate-950">
              <div className="text-xs text-slate-400">Nombres</div>
              <div className="font-semibold">{profile?.first_names ?? "-"}</div>
            </div>
            <div className="rounded-2xl border border-slate-800 p-4 bg-slate-950">
              <div className="text-xs text-slate-400">Apellido(s)</div>
              <div className="font-semibold">
                {[profile?.last_name_pat, profile?.last_name_mat]
                  .filter(Boolean)
                  .join(" ") || "-"}
              </div>
            </div>
            <div className="rounded-2xl border border-slate-800 p-4 bg-slate-950">
              <div className="text-xs text-slate-400">Celular</div>
              <div className="font-semibold">{profile?.phone ?? "-"}</div>
            </div>
            <div className="rounded-2xl border border-slate-800 p-4 bg-slate-950">
              <div className="text-xs text-slate-400">Correo (opcional)</div>
              <div className="font-semibold">
                {profile?.contact_email ?? "-"}
              </div>
            </div>
            <div className="rounded-2xl border border-slate-800 p-4 md:col-span-2 bg-slate-950">
              <div className="text-xs text-slate-400">Gustos</div>
              <div className="font-semibold">{profile?.likes ?? "-"}</div>
            </div>
          </div>

          {msg && (
            <pre className="text-sm bg-slate-900 border border-slate-800 rounded-xl p-3 whitespace-pre-wrap">
              {msg}
            </pre>
          )}
        </section>

        <section className="bg-slate-950 rounded-2xl border border-slate-800 p-6 space-y-4">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold">M√≥dulos (secuenciales)</h2>
            <div className="text-sm text-slate-400">
              Completa 70% para desbloquear el siguiente.
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {modules
              .slice()
              .sort((a, b) => a.sort_order - b.sort_order)
              .map((m) => {
                const prog = progressByModule[m.id];
                const pct = prog?.progress_percent ?? 0;
                const unlocked = unlockedMap[m.id] ?? false;
                const canFinal = prog?.is_unlocked_final ?? false;

                const isGradesOpen = gradesOpen.has(m.id);
                const isGradesLoading = gradesLoadingByModule[m.id] ?? false;
                const grade = gradesByModule[m.id];

                return (
                  <div
                    key={m.id}
                    className="rounded-2xl border border-slate-800 p-4 space-y-3 bg-slate-950"
                  >
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className="text-sm text-slate-400">
                          M√≥dulo {m.sort_order}
                        </div>
                        <div className="text-lg font-semibold">{m.title}</div>
                      </div>

                      <span className="text-xs px-2 py-1 rounded-full bg-slate-900 border border-slate-800">
                        {pct}%
                      </span>
                    </div>

                    <ProgressBar value={pct} />

                    <div className="text-sm text-slate-300">
                      Evaluaci√≥n final:{" "}
                      <b
                        className={
                          canFinal ? "text-emerald-400" : "text-slate-400"
                        }
                      >
                        {canFinal
                          ? "Habilitada ‚úÖ (70%)"
                          : "Bloqueada üîí (70%)"}
                      </b>
                    </div>

                    <button
                      className="rounded-xl px-3 py-2 bg-white text-black disabled:opacity-50 w-full"
                      disabled={!unlocked}
                      onClick={() => nav(`/student/module/${m.id}`)}
                      title={
                        !unlocked
                          ? "Completa el m√≥dulo anterior al 70% para desbloquear"
                          : "Entrar"
                      }
                    >
                      {unlocked ? "Entrar" : "Bloqueado"}
                    </button>

                    <button
                      type="button"
                      className="rounded-xl px-3 py-2 border border-slate-800 hover:bg-slate-900 w-full"
                      onClick={() => toggleGrades(m.id)}
                    >
                      {isGradesOpen
                        ? "Ocultar calificaciones"
                        : "Calificaciones"}
                    </button>

                    {isGradesOpen && (
                      <div className="rounded-2xl border border-slate-800 bg-slate-900 p-3 overflow-auto">
                        {isGradesLoading ? (
                          <div className="text-sm text-slate-300">
                            Cargando calificaciones...
                          </div>
                        ) : grade ? (
                          (() => {
                            const g = grade as ModuleGradeRow;
                            const total = calcTotal(g, pct);
                            const obs = getObservation(total);

                            return (
                              <div className="space-y-3">
                                <table className="min-w-full text-xs">
                                  <thead>
                                    <tr className="text-left text-slate-200">
                                      <th className="py-1 pr-2">Ser</th>
                                      <th className="py-1 pr-2">Saber</th>
                                      <th className="py-1 pr-2">H-Pro</th>
                                      <th className="py-1 pr-2">H-Prod</th>
                                      <th className="py-1 pr-2">Dec</th>
                                      <th className="py-1 pr-2">A-Ser</th>
                                      <th className="py-1 pr-2">A-Dec</th>
                                      <th className="py-1 pr-2 font-semibold">
                                        Total
                                      </th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <tr className="border-t border-slate-800 text-slate-100">
                                      <td className="py-1 pr-2">
                                        {num0(g.ser)}
                                      </td>
                                      <td className="py-1 pr-2">
                                        {num0(g.saber)}
                                      </td>
                                      <td className="py-1 pr-2">
                                        {g.hacer_proceso === null ||
                                        g.hacer_proceso === undefined
                                          ? `${Math.round((pct / 100) * 20)}`
                                          : num0(g.hacer_proceso)}
                                      </td>
                                      <td className="py-1 pr-2">
                                        {num0(g.hacer_producto)}
                                      </td>
                                      <td className="py-1 pr-2">
                                        {num0(g.decidir)}
                                      </td>
                                      <td className="py-1 pr-2">
                                        {num0(g.auto_ser)}
                                      </td>
                                      <td className="py-1 pr-2">
                                        {num0(g.auto_decidir)}
                                      </td>
                                      <td className="py-1 pr-2 font-semibold">
                                        {total}
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                                <div className="text-sm">
                                  <span className="text-slate-400">
                                    Observaci√≥n:
                                  </span>{" "}
                                  <span
                                    className={
                                      obs.includes("Excelente")
                                        ? "text-emerald-400 font-semibold"
                                        : obs.includes("Promovido")
                                        ? "text-emerald-400"
                                        : obs.includes("Postergado")
                                        ? "text-amber-400"
                                        : "text-rose-400"
                                    }
                                  >
                                    {obs}
                                  </span>
                                </div>
                              </div>
                            );
                          })()
                        ) : (
                          <div className="text-sm text-slate-300">
                            Sin calificaciones a√∫n.
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
          </div>
        </section>
      </main>

      {/* MODAL AVATAR */}
      {avatarOpen && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
          <div className="bg-slate-950 rounded-2xl border border-slate-800 shadow max-w-xl w-full p-5 space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-sm text-slate-400">
                  Selecciona tu avatar
                </div>
                <div className="text-lg font-bold">Avatares</div>
              </div>
              <button
                className="rounded-xl px-3 py-2 border border-slate-800 hover:bg-slate-900"
                onClick={() => setAvatarOpen(false)}
              >
                Cerrar
              </button>
            </div>

            <div className="grid grid-cols-5 gap-3">
              {AVATARS.map((a) => (
                <button
                  key={a.key}
                  className={
                    "rounded-2xl border border-slate-800 p-2 hover:bg-slate-900 " +
                    (avatar.key === a.key ? "ring-2 ring-white" : "")
                  }
                  onClick={() => setAvatarKey(a.key)}
                  disabled={savingAvatar}
                  title={a.label}
                  type="button"
                >
                  <img src={a.url} alt={a.label} className="w-full h-auto" />
                </button>
              ))}
            </div>

            {savingAvatar && (
              <div className="text-sm text-slate-300">Guardando...</div>
            )}
          </div>
        </div>
      )}

      {/* ‚úÖ MODAL NOTAS HIST√ìRICAS */}
      {historyOpen && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
          <div className="bg-slate-950 rounded-2xl border border-slate-800 shadow max-w-6xl w-full max-h-[90vh] overflow-auto p-5 space-y-4">
            <div className="flex items-center justify-between sticky top-0 bg-slate-950 pb-3 border-b border-slate-800">
              <div>
                <div className="text-lg font-bold">üìä Notas Hist√≥ricas</div>
                <div className="text-sm text-slate-400">
                  Historial completo de calificaciones por m√≥dulo
                </div>
              </div>
              <button
                className="rounded-xl px-3 py-2 border border-slate-800 hover:bg-slate-900"
                onClick={() => setHistoryOpen(false)}
              >
                Cerrar
              </button>
            </div>

            {historyLoading ? (
              <div className="text-center py-8 text-slate-400">
                Cargando historial...
              </div>
            ) : historyData.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                No tienes calificaciones registradas a√∫n.
              </div>
            ) : (
              <div className="overflow-auto">
                <table className="min-w-full text-sm">
                  <thead className="bg-slate-900 sticky top-0">
                    <tr className="text-left border-b border-slate-800">
                      <th className="p-3">Nivel</th>
                      <th className="p-3">M√≥dulo</th>
                      <th className="p-3">Ser</th>
                      <th className="p-3">Saber</th>
                      <th className="p-3">H-Pro</th>
                      <th className="p-3">H-Prod</th>
                      <th className="p-3">Dec</th>
                      <th className="p-3">A-Ser</th>
                      <th className="p-3">A-Dec</th>
                      <th className="p-3 font-semibold">Total</th>
                      <th className="p-3">Observaci√≥n</th>
                    </tr>
                  </thead>
                  <tbody>
                    {historyData.map((row) => (
                      <tr
                        key={row.module_id}
                        className="border-b border-slate-800"
                      >
                        <td className="p-3 text-slate-300">{row.level_name}</td>
                        <td className="p-3 font-semibold">{row.module_name}</td>
                        <td className="p-3">{row.ser}</td>
                        <td className="p-3">{row.saber}</td>
                        <td className="p-3">{row.hacer_proceso}</td>
                        <td className="p-3">{row.hacer_producto}</td>
                        <td className="p-3">{row.decidir}</td>
                        <td className="p-3">{row.auto_ser}</td>
                        <td className="p-3">{row.auto_decidir}</td>
                        <td className="p-3 font-semibold">{row.total}</td>
                        <td
                          className={
                            "p-3 " +
                            (row.observation.includes("Excelente")
                              ? "text-emerald-400 font-semibold"
                              : row.observation.includes("Promovido")
                              ? "text-emerald-400"
                              : row.observation.includes("Postergado")
                              ? "text-amber-400"
                              : "text-rose-400")
                          }
                        >
                          {row.observation}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}


----------------------------------------------------------------------------------------- 
// src\pages\StudentModule.tsx
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/pages/StudentModule.tsx
import { useEffect, useMemo, useState } from "react";
import { Navigate, useNavigate, useParams } from "react-router-dom";
import { supabase } from "../lib/supabase";
import { useRole } from "../lib/useRole";

type ModuleRow = {
  id: number;
  level_id: number;
  title: string;
  description: string | null;
  sort_order: number;
  is_active: boolean | null;
};

type LessonRow = {
  id: number;
  module_id: number;
  title: string;
  sort_order: number;
};

type SectionRow = {
  id: number;
  lesson_id: number;
  title: string;
  kind: string;
  content_json: unknown;
  sort_order: number;
  is_active: boolean | null;
};

type ProgressRow = { section_id: number };

function clampPct(x: number) {
  return Math.max(0, Math.min(100, Math.round(x)));
}

function ProgressBar({ value }: { value: number }) {
  const v = clampPct(value);
  return (
    <div className="w-full">
      <div className="flex justify-between text-sm mb-1 text-slate-300">
        <span className="font-medium">Progreso del m√≥dulo</span>
        <span>{v}%</span>
      </div>
      <div className="h-3 rounded-full bg-slate-800 overflow-hidden">
        <div className="h-3 bg-white rounded-full" style={{ width: `${v}%` }} />
      </div>
    </div>
  );
}

function asObj(x: unknown): Record<string, unknown> {
  if (x && typeof x === "object") return x as Record<string, unknown>;
  return {};
}

function getText(obj: Record<string, unknown>, key: string) {
  const v = obj[key];
  return typeof v === "string" ? v : "";
}

function getNum(obj: Record<string, unknown>, key: string) {
  const v = obj[key];
  return typeof v === "number" ? v : NaN;
}

export default function StudentModule() {
  const nav = useNavigate();
  const { moduleId } = useParams();
  const { loading, session } = useRole();

  const mid = Number(moduleId);
  const invalidMid = !Number.isFinite(mid);

  const [msg, setMsg] = useState<string | null>(null);

  const [modules, setModules] = useState<ModuleRow[]>([]);
  const [moduleRow, setModuleRow] = useState<ModuleRow | null>(null);

  const [lessons, setLessons] = useState<LessonRow[]>([]);
  const [sections, setSections] = useState<SectionRow[]>([]);
  const [completedSet, setCompletedSet] = useState<Set<number>>(new Set());

  const [openLessonIds, setOpenLessonIds] = useState<Set<number>>(new Set());
  const [currentSectionId, setCurrentSectionId] = useState<number | null>(null);

  // estado local para quiz (MVP)
  const [quizSelected, setQuizSelected] = useState<number | null>(null);
  const [quizFeedback, setQuizFeedback] = useState<string | null>(null);

  const [marking, setMarking] = useState(false);

  // -------- Carga principal --------
  useEffect(() => {
    if (!session) return;
    if (invalidMid) return;

    async function load() {
      setMsg(null);

      // 1) enrollment -> level_id
      const enr = await supabase
        .from("enrollments")
        .select("level_id")
        .eq("student_id", session.user.id)
        .maybeSingle();

      if (enr.error) {
        setMsg("No se pudo leer tu nivel (enrollments): " + enr.error.message);
        return;
      }

      const lvId = enr.data?.level_id ? Number(enr.data.level_id) : null;
      if (!lvId) {
        setMsg(
          "No tienes nivel asignado. Pide al admin/docente que te asigne un nivel."
        );
        return;
      }

      // 2) m√≥dulos del nivel
      const modsRes = await supabase
        .from("modules")
        .select("id,level_id,title,description,sort_order,is_active")
        .eq("level_id", lvId)
        .order("sort_order");

      if (modsRes.error) {
        setMsg("No se pudo cargar m√≥dulos: " + modsRes.error.message);
        return;
      }

      const modList = ((modsRes.data ?? []) as ModuleRow[]).filter(
        (m) => m.is_active !== false
      );
      setModules(modList);

      const currentMod = modList.find((m) => m.id === mid) ?? null;
      if (!currentMod) {
        setMsg("Este m√≥dulo no pertenece a tu nivel o no existe.");
        return;
      }
      setModuleRow(currentMod);

      // 3) lessons del m√≥dulo (sin is_active)
      const lessonsRes = await supabase
        .from("lessons")
        .select("id,module_id,title,sort_order")
        .eq("module_id", mid)
        .order("sort_order");

      if (lessonsRes.error) {
        setMsg("No se pudo cargar lecciones: " + lessonsRes.error.message);
        return;
      }

      const lessonList = (lessonsRes.data ?? []) as LessonRow[];
      setLessons(lessonList);

      // abrir todas por defecto
      setOpenLessonIds(new Set(lessonList.map((l) => l.id)));

      const lessonIds = lessonList.map((l) => l.id);
      if (lessonIds.length === 0) {
        setSections([]);
        setCurrentSectionId(null);
        return;
      }

      // 4) sections de esas lessons
      const secRes = await supabase
        .from("lesson_sections")
        .select("id,lesson_id,title,kind,content_json,sort_order,is_active")
        .in("lesson_id", lessonIds)
        .order("lesson_id", { ascending: true })
        .order("sort_order", { ascending: true });

      if (secRes.error) {
        setMsg("No se pudo cargar secciones: " + secRes.error.message);
        return;
      }

      const secList = ((secRes.data ?? []) as SectionRow[]).filter(
        (s) => s.is_active !== false
      );
      setSections(secList);

      // 5) progreso del estudiante
      const progRes = await supabase
        .from("student_section_progress")
        .select("section_id")
        .eq("student_id", session.user.id);

      if (progRes.error) {
        setMsg("No se pudo cargar progreso: " + progRes.error.message);
        return;
      }

      const rows = (progRes.data ?? []) as ProgressRow[];
      const done = new Set<number>(rows.map((r) => Number(r.section_id)));
      setCompletedSet(done);

      // secci√≥n inicial
      setCurrentSectionId(secList[0]?.id ?? null);

      // reset quiz ui
      setQuizSelected(null);
      setQuizFeedback(null);
    }

    load();
  }, [session, mid, invalidMid]);

  // -------- Estructura: lesson -> sections --------
  const sectionsByLesson = useMemo(() => {
    const map = new Map<number, SectionRow[]>();
    for (const s of sections) {
      const arr = map.get(s.lesson_id) ?? [];
      arr.push(s);
      map.set(s.lesson_id, arr);
    }
    for (const [k, arr] of map.entries()) {
      arr.sort((a, b) => a.sort_order - b.sort_order);
      map.set(k, arr);
    }
    return map;
  }, [sections]);

  // lista lineal para navegaci√≥n prev/next
  const linearSections = useMemo(() => {
    const orderedLessons = lessons
      .slice()
      .sort((a, b) => a.sort_order - b.sort_order);
    const out: SectionRow[] = [];
    for (const l of orderedLessons) {
      const arr = sectionsByLesson.get(l.id) ?? [];
      for (const s of arr) out.push(s);
    }
    return out;
  }, [lessons, sectionsByLesson]);

  const currentIndex = useMemo(() => {
    if (!currentSectionId) return -1;
    return linearSections.findIndex((s) => s.id === currentSectionId);
  }, [linearSections, currentSectionId]);

  const currentSection = useMemo(() => {
    if (currentIndex < 0) return null;
    return linearSections[currentIndex] ?? null;
  }, [linearSections, currentIndex]);

  const progress = useMemo(() => {
    const total = linearSections.length;
    if (total === 0) return { total: 0, done: 0, pct: 0 };
    let done = 0;
    for (const s of linearSections) if (completedSet.has(s.id)) done++;
    const pct = total > 0 ? (done / total) * 100 : 0;
    return { total, done, pct: clampPct(pct) };
  }, [linearSections, completedSet]);

  const canFinal = progress.pct >= 70; // ‚úÖ cambio: 70%

  async function toggleCompleted(sectionId: number) {
    if (!session) return;

    setMarking(true);
    setMsg(null);

    const isDone = completedSet.has(sectionId);

    if (isDone) {
      // ‚úÖ desmarcar = delete
      const del = await supabase
        .from("student_section_progress")
        .delete()
        .eq("student_id", session.user.id)
        .eq("section_id", sectionId);

      setMarking(false);

      if (del.error) {
        setMsg("No se pudo desmarcar: " + del.error.message);
        return;
      }

      setCompletedSet((prev) => {
        const n = new Set(prev);
        n.delete(sectionId);
        return n;
      });
      return;
    }

    // ‚úÖ marcar = upsert
    const up = await supabase
      .from("student_section_progress")
      .upsert(
        { student_id: session.user.id, section_id: sectionId },
        { onConflict: "student_id,section_id" }
      );

    setMarking(false);

    if (up.error) {
      setMsg("No se pudo marcar como completado: " + up.error.message);
      return;
    }

    setCompletedSet((prev) => new Set(prev).add(sectionId));
  }

  function goPrev() {
    if (currentIndex <= 0) return;
    const prev = linearSections[currentIndex - 1];
    setCurrentSectionId(prev.id);
    setQuizSelected(null);
    setQuizFeedback(null);
  }

  function goNext() {
    if (currentIndex < 0 || currentIndex >= linearSections.length - 1) return;
    const next = linearSections[currentIndex + 1];
    setCurrentSectionId(next.id);
    setQuizSelected(null);
    setQuizFeedback(null);
  }

  function toggleLesson(id: number) {
    setOpenLessonIds((prev) => {
      const n = new Set(prev);
      if (n.has(id)) n.delete(id);
      else n.add(id);
      return n;
    });
  }

  function renderSectionContent(s: SectionRow) {
    const obj = asObj(s.content_json);

    if (s.kind === "text") {
      const text = getText(obj, "text");
      return (
        <div className="text-slate-200 leading-relaxed whitespace-pre-wrap">
          {text || "(sin contenido)"}
        </div>
      );
    }

    if (s.kind === "video") {
      const url = getText(obj, "url");
      return (
        <div className="space-y-2">
          <div className="text-sm text-slate-400">Video</div>
          {url ? (
            <div className="aspect-video w-full overflow-hidden rounded-2xl border border-slate-800 bg-black">
              <iframe
                className="w-full h-full"
                src={url.replace("watch?v=", "embed/")}
                title="Video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowFullScreen
              />
            </div>
          ) : (
            <div className="text-slate-400">(falta url)</div>
          )}
        </div>
      );
    }

    if (s.kind === "image") {
      const url = getText(obj, "url");
      return url ? (
        <img
          src={url}
          alt={s.title}
          className="w-full rounded-2xl border border-slate-800"
        />
      ) : (
        <div className="text-slate-400">(falta url)</div>
      );
    }

    if (s.kind === "link") {
      const url = getText(obj, "url");
      const label = getText(obj, "label") || url;
      return url ? (
        <a
          className="text-sky-400 underline"
          href={url}
          target="_blank"
          rel="noreferrer"
        >
          {label}
        </a>
      ) : (
        <div className="text-slate-400">(falta url)</div>
      );
    }

    if (s.kind === "quiz") {
      const question = getText(obj, "question");
      const options = Array.isArray(obj.options)
        ? (obj.options as unknown[])
        : [];
      const ans = getNum(obj, "answer");
      const answer = Number.isFinite(ans) ? ans : null;

      return (
        <div className="space-y-3">
          <div className="text-sm text-slate-400">Quiz (demo)</div>
          <div className="font-semibold text-slate-100">
            {question || "Pregunta"}
          </div>

          <div className="space-y-2">
            {options.map((opt, i) => {
              const text = typeof opt === "string" ? opt : JSON.stringify(opt);
              const checked = quizSelected === i;
              return (
                <button
                  key={i}
                  type="button"
                  className={
                    "w-full text-left rounded-xl border border-slate-800 px-3 py-2 hover:bg-slate-900 " +
                    (checked ? "ring-2 ring-white" : "")
                  }
                  onClick={() => {
                    setQuizSelected(i);
                    setQuizFeedback(null);
                  }}
                >
                  <span className="text-slate-200">
                    {String.fromCharCode(65 + i)}. {text}
                  </span>
                </button>
              );
            })}
          </div>

          <div className="flex gap-2">
            <button
              type="button"
              className="rounded-xl px-3 py-2 bg-white text-black disabled:opacity-50"
              disabled={quizSelected === null}
              onClick={() => {
                if (answer === null) {
                  setQuizFeedback(
                    "Este quiz no tiene respuesta configurada (demo)."
                  );
                } else if (quizSelected === answer) {
                  setQuizFeedback("‚úÖ Correcto");
                } else {
                  setQuizFeedback("‚ùå Incorrecto");
                }
              }}
            >
              Revisar
            </button>

            <div className="text-sm text-slate-300 flex items-center">
              {quizFeedback ?? ""}
            </div>
          </div>
        </div>
      );
    }

    return <div className="text-slate-400">(tipo desconocido: {s.kind})</div>;
  }

  async function logout() {
    await supabase.auth.signOut();
    nav("/login", { replace: true });
  }

  if (loading) return <div className="p-6">Cargando...</div>;
  if (!session) return <Navigate to="/login" replace />;
  if (invalidMid) return <Navigate to="/student" replace />;

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100">
      <header className="bg-slate-950 border-b border-slate-800">
        <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
          <div>
            <div className="text-sm text-slate-400">CEA Madre Mar√≠a Oliva</div>
            <div className="text-xl font-bold">
              {moduleRow?.title ?? "M√≥dulo"}
            </div>
            <div className="text-sm text-slate-300">
              {progress.done}/{progress.total} completadas ¬∑ {progress.pct}% ¬∑{" "}
              <span
                className={canFinal ? "text-emerald-400" : "text-slate-400"}
              >
                Evaluaci√≥n final{" "}
                {canFinal ? "habilitada ‚úÖ" : "bloqueada üîí (70%)"}
              </span>
            </div>
          </div>

          <div className="flex gap-2">
            <button
              className="rounded-xl px-3 py-2 border border-slate-800 hover:bg-slate-900"
              onClick={() => nav("/student", { replace: true })}
            >
              Volver al panel
            </button>
            <button
              className="rounded-xl px-3 py-2 bg-white text-black"
              onClick={logout}
            >
              Cerrar sesi√≥n
            </button>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-6 py-6 grid grid-cols-1 lg:grid-cols-[320px_1fr] gap-4">
        <aside className="bg-slate-950 rounded-2xl border border-slate-800 p-4 space-y-3 h-fit lg:sticky lg:top-6">
          <ProgressBar value={progress.pct} />

          <div className="pt-2 border-t border-slate-800">
            <div className="text-sm font-semibold mb-2">√çndice</div>

            <div className="space-y-2">
              {lessons
                .slice()
                .sort((a, b) => a.sort_order - b.sort_order)
                .map((l) => {
                  const isOpen = openLessonIds.has(l.id);
                  const sec = sectionsByLesson.get(l.id) ?? [];

                  return (
                    <div
                      key={l.id}
                      className="rounded-xl border border-slate-800"
                    >
                      <button
                        type="button"
                        className="w-full flex items-center justify-between px-3 py-2 text-left hover:bg-slate-900 rounded-xl"
                        onClick={() => toggleLesson(l.id)}
                      >
                        <span className="font-semibold">{l.title}</span>
                        <span className="text-xs text-slate-400">
                          {isOpen ? "‚àí" : "+"}
                        </span>
                      </button>

                      {isOpen && (
                        <div className="px-2 pb-2 space-y-1">
                          {sec.map((s) => {
                            const active = s.id === currentSectionId;
                            const done = completedSet.has(s.id);

                            return (
                              <button
                                key={s.id}
                                type="button"
                                className={
                                  "w-full flex items-center justify-between rounded-lg px-2 py-2 text-left text-sm hover:bg-slate-900 " +
                                  (active ? "bg-slate-900" : "")
                                }
                                onClick={() => {
                                  setCurrentSectionId(s.id);
                                  setQuizSelected(null);
                                  setQuizFeedback(null);
                                }}
                              >
                                <span className="truncate text-slate-200">
                                  {s.title}{" "}
                                  <span className="ml-2 text-xs text-slate-500">
                                    ({s.kind})
                                  </span>
                                </span>
                                <span className="text-xs">
                                  {done ? "‚úÖ" : ""}
                                </span>
                              </button>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  );
                })}
            </div>
          </div>
        </aside>

        <section className="bg-slate-950 rounded-2xl border border-slate-800 p-6 space-y-4">
          {msg && (
            <pre className="text-sm bg-slate-900 border border-slate-800 rounded-xl p-3 whitespace-pre-wrap">
              {msg}
            </pre>
          )}

          {!currentSection ? (
            <div className="text-slate-400">
              Este m√≥dulo a√∫n no tiene secciones.
            </div>
          ) : (
            <>
              <div className="flex items-start justify-between gap-3">
                <div>
                  <div className="text-sm text-slate-400">
                    Secci√≥n {currentIndex + 1} / {linearSections.length}
                  </div>
                  <h2 className="text-xl font-bold">{currentSection.title}</h2>
                </div>

                <div className="flex items-center gap-2">
                  <span className="text-xs px-2 py-1 rounded-full bg-slate-900 border border-slate-800">
                    {currentSection.kind}
                  </span>
                  <span className="text-xs px-2 py-1 rounded-full bg-slate-900 border border-slate-800">
                    {completedSet.has(currentSection.id)
                      ? "Completada ‚úÖ"
                      : "Pendiente"}
                  </span>
                </div>
              </div>

              <div className="border-t border-slate-800 pt-4">
                {renderSectionContent(currentSection)}
              </div>

              <div className="flex flex-col md:flex-row gap-2 md:items-center md:justify-between pt-4 border-t border-slate-800">
                <div className="flex gap-2">
                  <button
                    type="button"
                    className="rounded-xl px-3 py-2 border border-slate-800 hover:bg-slate-900 disabled:opacity-50"
                    disabled={currentIndex <= 0}
                    onClick={goPrev}
                  >
                    ‚Üê Anterior
                  </button>
                  <button
                    type="button"
                    className="rounded-xl px-3 py-2 border border-slate-800 hover:bg-slate-900 disabled:opacity-50"
                    disabled={
                      currentIndex < 0 ||
                      currentIndex >= linearSections.length - 1
                    }
                    onClick={goNext}
                  >
                    Siguiente ‚Üí
                  </button>
                </div>

                <div className="flex gap-2">
                  <button
                    type="button"
                    className="rounded-xl px-3 py-2 bg-white text-black disabled:opacity-50"
                    disabled={marking || !currentSection}
                    onClick={() => toggleCompleted(currentSection.id)}
                  >
                    {marking
                      ? "Guardando..."
                      : completedSet.has(currentSection.id)
                      ? "Desmarcar completado"
                      : "Marcar como completado"}
                  </button>

                  <button
                    type="button"
                    className="rounded-xl px-3 py-2 border border-slate-800 hover:bg-slate-900 disabled:opacity-50"
                    disabled={!canFinal}
                    onClick={() =>
                      alert(
                        "Siguiente hito: Evaluaci√≥n Final del m√≥dulo (manual por docente)."
                      )
                    }
                    title={
                      !canFinal
                        ? "Completa al menos 70% para habilitar"
                        : "Entrar"
                    }
                  >
                    Evaluaci√≥n Final
                  </button>
                </div>
              </div>
            </>
          )}
        </section>
      </div>
    </div>
  );
}


----------------------------------------------------------------------------------------- 
// src\pages\TeacherDashboard.tsx
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/pages/TeacherDashboard.tsx
// üé® PARTE 1: Dashboard oscuro + Modales funcionando + Nueva estructura de tabla

import { useEffect, useState } from "react";
import { Navigate, useNavigate } from "react-router-dom";
import { supabase } from "../lib/supabase";
import { useRole } from "../lib/useRole";

type ProfileData = {
  id: string;
  code: string | null;
  full_name: string | null;
  first_names: string | null;
  last_name_pat: string | null;
  last_name_mat: string | null;
  phone: string | null;
  contact_email: string | null;
  likes: string | null;
  avatar_key: string | null;
  career_id: number | null;
  shift: string | null;
};

type Career = { id: number; name: string };
type Level = { id: number; name: string; sort_order: number };

type Student = {
  id: string;
  code: string | null;
  full_name: string | null;
  first_names: string | null;
  last_name_pat: string | null;
  last_name_mat: string | null;
  phone: string | null;
  contact_email: string | null;
  career_id: number | null;
  shift: string | null;
  level_id: number | null;
  level_name: string | null;
  level_sort_order: number | null;
  can_ascend: boolean;
};

const AVATARS = Array.from({ length: 20 }, (_, i) => ({
  key: `av${i + 1}`,
  label: `Avatar ${i + 1}`,
  url: `https://api.dicebear.com/9.x/thumbs/svg?seed=av${i + 1}-cea`,
}));

export default function TeacherDashboard() {
  const nav = useNavigate();
  const { loading, session, role } = useRole();

  const [profileData, setProfileData] = useState<ProfileData | null>(null);
  const [careerName, setCareerName] = useState("");
  const [levels, setLevels] = useState<Level[]>([]);
  const [students, setStudents] = useState<Student[]>([]);
  const [filteredStudents, setFilteredStudents] = useState<Student[]>([]);
  const [selectedLevelFilter, setSelectedLevelFilter] = useState<number | null>(
    null
  );
  const [sortOrder, setSortOrder] = useState<"asc" | "desc">("asc");

  const [msg, setMsg] = useState<string | null>(null);
  const [loadingStudents, setLoadingStudents] = useState(false);

  const [editMode, setEditMode] = useState(false);
  const [editPhone, setEditPhone] = useState("");
  const [editEmail, setEditEmail] = useState("");
  const [editLikes, setEditLikes] = useState("");
  const [saving, setSaving] = useState(false);

  const [showAvatarModal, setShowAvatarModal] = useState(false);
  const [selectedAvatar, setSelectedAvatar] = useState("av1");

  const [showAddStudent, setShowAddStudent] = useState(false);
  const [addFirstNames, setAddFirstNames] = useState("");
  const [addLastNamePat, setAddLastNamePat] = useState("");
  const [addLastNameMat, setAddLastNameMat] = useState("");
  const [addPhone, setAddPhone] = useState("");
  const [addEmail, setAddEmail] = useState("");
  const [addPassword, setAddPassword] = useState("");
  const [addLevelId, setAddLevelId] = useState<number | null>(null);
  const [addingStudent, setAddingStudent] = useState(false);

  const [showEditStudent, setShowEditStudent] = useState(false);
  const [editingStudentId, setEditingStudentId] = useState<string | null>(null);
  const [editStudentFirstNames, setEditStudentFirstNames] = useState("");
  const [editStudentLastNamePat, setEditStudentLastNamePat] = useState("");
  const [editStudentLastNameMat, setEditStudentLastNameMat] = useState("");
  const [editStudentPhone, setEditStudentPhone] = useState("");
  const [editStudentEmail, setEditStudentEmail] = useState("");
  const [editStudentLevelId, setEditStudentLevelId] = useState<number | null>(
    null
  );
  const [editingStudentData, setEditingStudentData] = useState(false);

  const [showResetPassword, setShowResetPassword] = useState(false);
  const [resetPasswordStudentId, setResetPasswordStudentId] = useState<
    string | null
  >(null);
  const [resetPasswordStudentName, setResetPasswordStudentName] = useState("");
  const [newPassword, setNewPassword] = useState("");
  const [resettingPassword, setResettingPassword] = useState(false);

  const isTeacherish = role === "teacher" || role === "admin";

  useEffect(() => {
    if (!session || !isTeacherish) return;

    async function load() {
      setMsg(null);

      const { data: prof, error: profErr } = await supabase
        .from("profiles")
        .select(
          "id,code,full_name,first_names,last_name_pat,last_name_mat,phone,contact_email,likes,avatar_key,career_id,shift"
        )
        .eq("id", session.user.id)
        .single();

      if (profErr) {
        setMsg("Error cargando perfil: " + profErr.message);
        return;
      }

      setProfileData(prof as ProfileData);
      setEditPhone(prof.phone ?? "");
      setEditEmail(prof.contact_email ?? "");
      setEditLikes(prof.likes ?? "");
      setSelectedAvatar(prof.avatar_key ?? "av1");

      if (prof.career_id) {
        const { data: careerData } = await supabase
          .from("careers")
          .select("id,name")
          .eq("id", prof.career_id)
          .single();

        if (careerData) {
          setCareerName((careerData as Career).name);
        }

        const { data: levelsData } = await supabase
          .from("levels")
          .select("id,name,sort_order")
          .eq("career_id", prof.career_id)
          .order("sort_order");

        const loadedLevels = (levelsData as Level[]) ?? [];
        setLevels(loadedLevels);
        await loadStudents(prof.career_id, prof.shift, loadedLevels);
      }
    }

    load();
  }, [session, isTeacherish]);

  async function loadStudents(
    careerId: number | null,
    shift: string | null,
    levelsList: Level[]
  ) {
    if (!careerId || !shift) return;

    setLoadingStudents(true);

    const { data: studentsData, error: studentsError } = await supabase
      .from("profiles")
      .select(
        "id,code,full_name,first_names,last_name_pat,last_name_mat,phone,contact_email,career_id,shift"
      )
      .eq("role", "student")
      .eq("career_id", careerId)
      .eq("shift", shift)
      .order("code");

    if (studentsError) {
      setMsg("Error cargando estudiantes: " + studentsError.message);
      setLoadingStudents(false);
      return;
    }

    const studentsList = (studentsData ?? []) as Student[];
    const studentIds = studentsList.map((s) => s.id);

    if (studentIds.length === 0) {
      setStudents([]);
      setFilteredStudents([]);
      setLoadingStudents(false);
      return;
    }

    const { data: enrollments, error: enrollError } = await supabase
      .from("enrollments")
      .select("student_id,level_id")
      .in("student_id", studentIds);

    if (enrollError) {
      console.error("Error cargando enrollments:", enrollError);
    }

    const enrollmentMap = new Map<string, number>();
    for (const e of enrollments ?? []) {
      enrollmentMap.set(e.student_id, e.level_id);
    }

    const levelMap = new Map<number, { name: string; sort_order: number }>();
    for (const l of levelsList) {
      levelMap.set(l.id, { name: l.name, sort_order: l.sort_order });
    }

    const studentsWithLevel: Student[] = [];

    for (const s of studentsList) {
      const levelId = enrollmentMap.get(s.id) ?? null;
      const levelInfo = levelId ? levelMap.get(levelId) : null;

      // Verificar si puede ascender: debe completar TODOS los 5 m√≥dulos del nivel
      let canAscend = false;
      if (levelId && levelInfo && levelInfo.sort_order < 4) {
        const { data: modulesInLevel } = await supabase
          .from("modules")
          .select("id")
          .eq("level_id", levelId);

        const moduleIds = (modulesInLevel ?? []).map((m: any) => m.id);

        if (moduleIds.length > 0) {
          const { data: grades } = await supabase
            .from("module_grades")
            .select(
              "module_id,ser,saber,hacer_proceso,hacer_producto,decidir,auto_ser,auto_decidir"
            )
            .eq("student_id", s.id)
            .in("module_id", moduleIds);

          // Verificar que tenga TODAS las notas completadas Y aprobadas (>= 51)
          const completedAndPassedModules = (grades ?? []).filter((g: any) => {
            const allFieldsFilled =
              g.ser !== null &&
              g.saber !== null &&
              g.hacer_proceso !== null &&
              g.hacer_producto !== null &&
              g.decidir !== null &&
              g.auto_ser !== null &&
              g.auto_decidir !== null;

            if (!allFieldsFilled) return false;

            const total =
              (g.ser || 0) +
              (g.saber || 0) +
              (g.hacer_proceso || 0) +
              (g.hacer_producto || 0) +
              (g.decidir || 0) +
              (g.auto_ser || 0) +
              (g.auto_decidir || 0);

            return total >= 51;
          }).length;

          // Solo puede ascender si complet√≥ Y aprob√≥ TODOS los m√≥dulos (normalmente 5)
          canAscend = completedAndPassedModules >= moduleIds.length;
        }
      }

      studentsWithLevel.push({
        ...s,
        level_id: levelId,
        level_name: levelInfo?.name ?? null,
        level_sort_order: levelInfo?.sort_order ?? null,
        can_ascend: canAscend,
      });
    }

    setStudents(studentsWithLevel);
    setFilteredStudents(studentsWithLevel);
    setLoadingStudents(false);
  }

  // Aplicar filtros y ordenamiento
  useEffect(() => {
    let filtered = students;

    // Filtro por nivel
    if (selectedLevelFilter !== null) {
      filtered = filtered.filter((s) => s.level_id === selectedLevelFilter);
    }

    // Ordenamiento alfab√©tico por apellido paterno
    const sorted = [...filtered].sort((a, b) => {
      const aLastName = (a.last_name_pat || "").toLowerCase();
      const bLastName = (b.last_name_pat || "").toLowerCase();

      if (sortOrder === "asc") {
        return aLastName.localeCompare(bLastName);
      } else {
        return bLastName.localeCompare(aLastName);
      }
    });

    setFilteredStudents(sorted);
  }, [selectedLevelFilter, sortOrder, students]);

  async function saveProfile() {
    if (!session) return;
    setSaving(true);
    setMsg(null);

    const upd = await supabase
      .from("profiles")
      .update({
        phone: editPhone.trim() || null,
        contact_email: editEmail.trim() || null,
        likes: editLikes.trim() || null,
      })
      .eq("id", session.user.id);

    setSaving(false);

    if (upd.error) {
      setMsg("Error: " + upd.error.message);
      return;
    }

    setMsg("‚úÖ Perfil actualizado");
    setEditMode(false);

    const { data: prof } = await supabase
      .from("profiles")
      .select(
        "id,code,full_name,first_names,last_name_pat,last_name_mat,phone,contact_email,likes,avatar_key,career_id,shift"
      )
      .eq("id", session.user.id)
      .single();

    if (prof) setProfileData(prof as ProfileData);
  }

  async function saveAvatar() {
    if (!session) return;

    const upd = await supabase
      .from("profiles")
      .update({ avatar_key: selectedAvatar })
      .eq("id", session.user.id);

    if (upd.error) {
      setMsg("Error: " + upd.error.message);
      return;
    }

    setMsg("‚úÖ Avatar actualizado");
    setShowAvatarModal(false);

    const { data: prof } = await supabase
      .from("profiles")
      .select("avatar_key")
      .eq("id", session.user.id)
      .single();

    if (prof && profileData) {
      setProfileData({ ...profileData, avatar_key: prof.avatar_key });
    }
  }

  async function handleAddStudent() {
    if (!profileData?.career_id || !profileData?.shift || !addLevelId) {
      setMsg("Error: Selecciona un nivel");
      return;
    }

    if (!addFirstNames.trim() || !addPhone.trim() || !addPassword.trim()) {
      setMsg("Error: Nombres, celular y contrase√±a son obligatorios");
      return;
    }

    if (!addLastNamePat.trim() && !addLastNameMat.trim()) {
      setMsg("Error: Debes llenar al menos un apellido");
      return;
    }

    setAddingStudent(true);
    setMsg(null);

    try {
      const {
        data: { session: currentSession },
      } = await supabase.auth.getSession();
      if (!currentSession) {
        setMsg("Error: Sesi√≥n no v√°lida");
        setAddingStudent(false);
        return;
      }

      const response = await fetch(
        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/create-user`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${currentSession.access_token}`,
          },
          body: JSON.stringify({
            role: "student",
            temp_password: addPassword,
            first_names: addFirstNames,
            last_name_pat: addLastNamePat || undefined,
            last_name_mat: addLastNameMat || undefined,
            phone: addPhone,
            contact_email: addEmail || undefined,
            career_id: profileData.career_id,
            shift: profileData.shift,
            level_id: addLevelId,
          }),
        }
      );

      const result = await response.json();

      if (!response.ok) {
        setMsg(
          `Error creando estudiante: ${result.error || "Error desconocido"}`
        );
        setAddingStudent(false);
        return;
      }

      setMsg("‚úÖ Estudiante creado exitosamente");
      setShowAddStudent(false);

      // Reset form
      setAddFirstNames("");
      setAddLastNamePat("");
      setAddLastNameMat("");
      setAddPhone("");
      setAddEmail("");
      setAddPassword("");
      setAddLevelId(null);
      setAddingStudent(false);

      await loadStudents(profileData.career_id, profileData.shift, levels);
    } catch (error) {
      setMsg(`Error: ${error}`);
      setAddingStudent(false);
    }
  }

  function openEditStudent(student: Student) {
    setEditingStudentId(student.id);
    setEditStudentFirstNames(student.first_names ?? "");
    setEditStudentLastNamePat(student.last_name_pat ?? "");
    setEditStudentLastNameMat(student.last_name_mat ?? "");
    setEditStudentPhone(student.phone ?? "");
    setEditStudentEmail(student.contact_email ?? "");
    setEditStudentLevelId(student.level_id);
    setShowEditStudent(true);
  }

  async function handleEditStudent() {
    if (!editingStudentId) return;

    if (!editStudentFirstNames.trim()) {
      setMsg("Error: Nombres son obligatorios");
      return;
    }

    if (!editStudentLastNamePat.trim() && !editStudentLastNameMat.trim()) {
      setMsg("Error: Debes llenar al menos un apellido");
      return;
    }

    if (!profileData?.career_id || !profileData?.shift) {
      setMsg("Error: No se pudo obtener datos del docente");
      return;
    }

    setEditingStudentData(true);
    setMsg(null);

    try {
      // Construir el full_name
      const lastNamePat = editStudentLastNamePat.trim();
      const lastNameMat = editStudentLastNameMat.trim();
      const firstNames = editStudentFirstNames.trim();

      let fullName = "";
      if (lastNamePat && lastNameMat) {
        fullName = `${lastNamePat} ${lastNameMat}, ${firstNames}`;
      } else if (lastNamePat) {
        fullName = `${lastNamePat}, ${firstNames}`;
      } else if (lastNameMat) {
        fullName = `${lastNameMat}, ${firstNames}`;
      } else {
        fullName = firstNames;
      }

      const dataToUpdate = {
        first_names: firstNames,
        last_name_pat: lastNamePat || null,
        last_name_mat: lastNameMat || null,
        full_name: fullName,
        phone: editStudentPhone.trim() || null,
        contact_email: editStudentEmail.trim() || null,
      };

      console.log("üîç DEBUG - ID del estudiante:", editingStudentId);
      console.log("üîç DEBUG - Datos a actualizar:", dataToUpdate);

      // Actualizar datos del estudiante
      const { data: updateData, error: updateError } = await supabase
        .from("profiles")
        .update(dataToUpdate)
        .eq("id", editingStudentId)
        .select();

      console.log("üîç DEBUG - Respuesta del update:", {
        updateData,
        updateError,
      });

      if (updateError) {
        console.error("‚ùå ERROR en update:", updateError);
        setMsg(`Error actualizando: ${updateError.message}`);
        setEditingStudentData(false);
        return;
      }

      if (!updateData || updateData.length === 0) {
        console.warn(
          "‚ö†Ô∏è WARNING: El update no retorn√≥ datos. Puede ser un problema de permisos RLS."
        );
        setMsg(
          "‚ö†Ô∏è No se pudo actualizar. Verifica los permisos en la base de datos."
        );
        setEditingStudentData(false);
        return;
      }

      console.log("‚úÖ Update exitoso:", updateData);

      // Actualizar nivel si cambi√≥
      if (editStudentLevelId) {
        console.log("üîç DEBUG - Actualizando nivel a:", editStudentLevelId);

        const { data: enrollData, error: enrollError } = await supabase
          .from("enrollments")
          .update({ level_id: editStudentLevelId })
          .eq("student_id", editingStudentId)
          .select();

        console.log("üîç DEBUG - Respuesta del update de enrollment:", {
          enrollData,
          enrollError,
        });

        if (enrollError) {
          console.error("‚ùå ERROR en enrollment:", enrollError);
          setMsg(`Error actualizando nivel: ${enrollError.message}`);
          setEditingStudentData(false);
          return;
        }
      }

      setMsg("‚úÖ Estudiante actualizado correctamente");
      setShowEditStudent(false);
      setEditingStudentData(false);

      console.log("üîÑ Recargando lista de estudiantes...");
      // Recargar la lista de estudiantes
      await loadStudents(profileData.career_id, profileData.shift, levels);
      console.log("‚úÖ Lista recargada");
    } catch (error) {
      console.error("‚ùå ERROR CATCH:", error);
      setMsg(`Error: ${error}`);
      setEditingStudentData(false);
    }
  }

  function openResetPassword(studentId: string, studentName: string) {
    setResetPasswordStudentId(studentId);
    setResetPasswordStudentName(studentName);
    setNewPassword("");
    setShowResetPassword(true);
  }

  async function handleResetPassword() {
    if (!resetPasswordStudentId || !newPassword.trim()) {
      setMsg("Error: Ingresa una nueva contrase√±a");
      return;
    }

    setResettingPassword(true);
    setMsg(null);

    try {
      const {
        data: { session: currentSession },
      } = await supabase.auth.getSession();
      if (!currentSession) {
        setMsg("Error: Sesi√≥n no v√°lida");
        setResettingPassword(false);
        return;
      }

      const response = await fetch(
        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/reset-password`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${currentSession.access_token}`,
          },
          body: JSON.stringify({
            user_id: resetPasswordStudentId,
            new_password: newPassword,
          }),
        }
      );

      const result = await response.json();

      if (!response.ok) {
        setMsg(`Error: ${result.error || "Error desconocido"}`);
        setResettingPassword(false);
        return;
      }

      setMsg("‚úÖ Contrase√±a actualizada");
      setShowResetPassword(false);
      setResettingPassword(false);
    } catch (error) {
      setMsg(`Error: ${error}`);
      setResettingPassword(false);
    }
  }

  async function handleDeleteStudent(studentId: string, studentCode: string) {
    if (
      !confirm(`¬øEliminar a ${studentCode}? Esta acci√≥n no se puede deshacer.`)
    ) {
      return;
    }

    if (!profileData?.career_id || !profileData?.shift) {
      setMsg("Error: No se pudo obtener datos del docente");
      return;
    }

    try {
      const {
        data: { session: currentSession },
      } = await supabase.auth.getSession();
      if (!currentSession) {
        setMsg("Error: Sesi√≥n no v√°lida");
        return;
      }

      const response = await fetch(
        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/delete-user`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${currentSession.access_token}`,
          },
          body: JSON.stringify({
            user_id: studentId,
          }),
        }
      );

      const result = await response.json();

      if (!response.ok) {
        setMsg(`Error: ${result.error || "Error desconocido"}`);
        return;
      }

      setMsg("‚úÖ Estudiante eliminado");
      await loadStudents(profileData.career_id, profileData.shift, levels);
    } catch (error) {
      setMsg(`Error: ${error}`);
    }
  }

  async function handleAscend(
    studentId: string,
    currentLevelSortOrder: number | null
  ) {
    if (currentLevelSortOrder === null) {
      setMsg("Error: El estudiante no tiene nivel asignado");
      return;
    }

    if (currentLevelSortOrder >= 4) {
      setMsg("El estudiante ya est√° en el nivel m√°ximo (T√©cnico Medio 2)");
      return;
    }

    const nextLevelSortOrder = currentLevelSortOrder + 1;
    const nextLevel = levels.find((l) => l.sort_order === nextLevelSortOrder);

    if (!nextLevel) {
      setMsg("Error: No se encontr√≥ el siguiente nivel");
      return;
    }

    if (!confirm(`¬øAscender al estudiante a ${nextLevel.name}?`)) {
      return;
    }

    if (!profileData?.career_id || !profileData?.shift) {
      setMsg("Error: No se pudo obtener datos del docente");
      return;
    }

    try {
      const { error } = await supabase
        .from("enrollments")
        .update({ level_id: nextLevel.id })
        .eq("student_id", studentId);

      if (error) {
        setMsg(`Error: ${error.message}`);
        return;
      }

      setMsg("‚úÖ Estudiante ascendido exitosamente");
      await loadStudents(profileData.career_id, profileData.shift, levels);
    } catch (error) {
      setMsg(`Error: ${error}`);
    }
  }

  async function logout() {
    await supabase.auth.signOut();
    nav("/login", { replace: true });
  }

  if (loading)
    return (
      <div className="min-h-screen bg-slate-950 flex items-center justify-center">
        <div className="text-slate-300">Cargando...</div>
      </div>
    );
  if (!session) return <Navigate to="/login" replace />;
  if (!isTeacherish) return <Navigate to="/student" replace />;

  const avatar =
    AVATARS.find((a) => a.key === (profileData?.avatar_key ?? "av1")) ??
    AVATARS[0];

  return (
    <div className="min-h-screen bg-slate-950">
      {/* Header */}
      <header className="bg-gradient-to-r from-slate-900 via-slate-900 to-slate-800 border-b border-slate-800/50 shadow-xl">
        <div className="max-w-7xl mx-auto px-6 py-6">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-slate-400 text-sm font-medium mb-1">
                CEA Madre Mar√≠a Oliva
              </div>
              <h1 className="text-3xl font-bold text-white">Panel Docente</h1>
            </div>
            <button
              className="px-6 py-3 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white rounded-xl font-medium transition-all duration-200 shadow-lg shadow-red-900/30"
              onClick={logout}
            >
              Cerrar sesi√≥n
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-8 space-y-6">
        {msg && (
          <div
            className={`px-6 py-4 rounded-xl font-medium animate-in fade-in slide-in-from-top-2 duration-300 ${
              msg.includes("‚úÖ")
                ? "bg-emerald-500/10 border border-emerald-500/20 text-emerald-400"
                : "bg-red-500/10 border border-red-500/20 text-red-400"
            }`}
          >
            {msg}
          </div>
        )}

        {/* Perfil del docente */}
        <section className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl border border-slate-700/50 p-8 shadow-2xl">
          <div className="flex items-start gap-8">
            <div className="flex-shrink-0">
              <div className="relative group">
                <div className="w-32 h-32 rounded-2xl overflow-hidden border-4 border-slate-700/50 shadow-xl">
                  <img
                    src={avatar.url}
                    alt={avatar.label}
                    className="w-full h-full object-cover"
                  />
                </div>
                <button
                  className="absolute -bottom-3 -right-3 w-12 h-12 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white flex items-center justify-center hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-lg shadow-blue-900/50 group-hover:scale-110"
                  onClick={() => setShowAvatarModal(true)}
                >
                  <svg
                    className="w-5 h-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                    />
                  </svg>
                </button>
              </div>
            </div>

            <div className="flex-1">
              <div className="flex items-start justify-between mb-6">
                <div>
                  <div className="text-sm text-slate-400 mb-1">
                    {profileData?.code ?? ""}
                  </div>
                  <h2 className="text-3xl font-bold text-white mb-2">
                    {profileData?.full_name ?? "Docente"}
                  </h2>
                  <div className="flex items-center gap-3 text-slate-300">
                    <span className="px-3 py-1 bg-slate-800/50 rounded-lg text-sm">
                      {careerName}
                    </span>
                    <span className="px-3 py-1 bg-slate-800/50 rounded-lg text-sm capitalize">
                      {profileData?.shift ?? ""}
                    </span>
                  </div>
                </div>

                <div className="flex gap-3">
                  <button
                    className="px-5 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl font-medium transition-all duration-200 shadow-lg shadow-blue-900/30"
                    onClick={() => nav("/teacher/modules")}
                  >
                    üìö Ver M√≥dulos
                  </button>
                  <button
                    className="px-5 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-medium transition-all duration-200 border border-slate-700/50"
                    onClick={() => setEditMode(!editMode)}
                  >
                    {editMode ? "Cancelar" : "Editar Perfil"}
                  </button>
                </div>
              </div>

              {editMode ? (
                <div className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-300 mb-2">
                        Celular
                      </label>
                      <input
                        className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                        value={editPhone}
                        onChange={(e) => setEditPhone(e.target.value)}
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-slate-300 mb-2">
                        Correo (opcional)
                      </label>
                      <input
                        className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                        value={editEmail}
                        onChange={(e) => setEditEmail(e.target.value)}
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">
                      Gustos (opcional)
                    </label>
                    <textarea
                      className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                      rows={2}
                      value={editLikes}
                      onChange={(e) => setEditLikes(e.target.value)}
                    />
                  </div>

                  <button
                    className="px-6 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white rounded-xl font-medium transition-all duration-200 shadow-lg shadow-emerald-900/30 disabled:opacity-50"
                    onClick={saveProfile}
                    disabled={saving}
                  >
                    {saving ? "Guardando..." : "Guardar Cambios"}
                  </button>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-4 bg-slate-800/30 rounded-xl border border-slate-700/30">
                    <div className="text-sm text-slate-400 mb-1">Celular</div>
                    <div className="text-white font-medium">
                      {profileData?.phone ?? "-"}
                    </div>
                  </div>
                  <div className="p-4 bg-slate-800/30 rounded-xl border border-slate-700/30">
                    <div className="text-sm text-slate-400 mb-1">Correo</div>
                    <div className="text-white font-medium">
                      {profileData?.contact_email ?? "-"}
                    </div>
                  </div>
                  <div className="md:col-span-2 p-4 bg-slate-800/30 rounded-xl border border-slate-700/30">
                    <div className="text-sm text-slate-400 mb-1">Gustos</div>
                    <div className="text-white font-medium">
                      {profileData?.likes ?? "-"}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </section>

        {/* Lista de estudiantes */}
        <section className="space-y-4">
          <div className="flex items-center justify-between">
            <h2 className="text-2xl font-bold text-white">Mis Estudiantes</h2>
            <div className="flex gap-3 items-center">
              <select
                className="px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                value={selectedLevelFilter ?? ""}
                onChange={(e) =>
                  setSelectedLevelFilter(
                    e.target.value ? Number(e.target.value) : null
                  )
                }
              >
                <option value="">Todos los niveles</option>
                {levels.map((l) => (
                  <option key={l.id} value={l.id}>
                    {l.name}
                  </option>
                ))}
              </select>
              <select
                className="px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                value={sortOrder}
                onChange={(e) => setSortOrder(e.target.value as "asc" | "desc")}
              >
                <option value="asc">A ‚Üí Z (Apellido)</option>
                <option value="desc">Z ‚Üí A (Apellido)</option>
              </select>
              <button
                className="px-5 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white rounded-xl font-medium transition-all duration-200 shadow-lg shadow-emerald-900/30"
                onClick={() => setShowAddStudent(true)}
              >
                + A√±adir Estudiante
              </button>
            </div>
          </div>

          {loadingStudents ? (
            <div className="bg-slate-900 rounded-2xl border border-slate-700/50 p-12 text-center">
              <div className="text-slate-300 text-lg">
                Cargando estudiantes...
              </div>
            </div>
          ) : filteredStudents.length === 0 ? (
            <div className="bg-slate-900 rounded-2xl border border-slate-700/50 p-12 text-center">
              <div className="text-6xl mb-4 opacity-20">üë•</div>
              <div className="text-xl font-semibold text-white mb-2">
                No hay estudiantes
              </div>
              <div className="text-slate-400">
                {selectedLevelFilter
                  ? "No hay estudiantes en este nivel"
                  : "Agrega estudiantes con el bot√≥n '+ A√±adir Estudiante'"}
              </div>
            </div>
          ) : (
            <div className="bg-slate-900 rounded-2xl border border-slate-700/50 overflow-hidden shadow-xl">
              <div className="overflow-x-auto">
                <table className="min-w-full">
                  <thead className="bg-slate-800/50">
                    <tr>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">
                        C√≥digo
                      </th>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">
                        Apellido Paterno
                      </th>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">
                        Apellido Materno
                      </th>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">
                        Nombres
                      </th>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">
                        Nivel
                      </th>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">
                        Celular
                      </th>
                      <th className="px-6 py-4 text-right text-xs font-semibold text-slate-300 uppercase tracking-wider">
                        Acciones
                      </th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-800/50">
                    {filteredStudents.map((s) => (
                      <tr
                        key={s.id}
                        className="hover:bg-slate-800/30 transition-colors"
                      >
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">
                          {s.code}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-200">
                          {s.last_name_pat || "-"}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-200">
                          {s.last_name_mat || "-"}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-200">
                          {s.first_names || "-"}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className="px-3 py-1 bg-blue-500/10 text-blue-400 text-xs font-medium rounded-lg border border-blue-500/20">
                            {s.level_name ?? "Sin nivel"}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
                          {s.phone}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm">
                          <div className="flex justify-end gap-2">
                            <button
                              className="px-3 py-1.5 text-blue-400 hover:bg-blue-500/10 rounded-lg transition-colors"
                              onClick={() => openEditStudent(s)}
                            >
                              Editar
                            </button>
                            <button
                              className="px-3 py-1.5 text-purple-400 hover:bg-purple-500/10 rounded-lg transition-colors"
                              onClick={() =>
                                openResetPassword(s.id, s.full_name ?? "")
                              }
                            >
                              Reset
                            </button>
                            <button
                              className="px-3 py-1.5 text-emerald-400 hover:bg-emerald-500/10 rounded-lg transition-colors"
                              onClick={() =>
                                nav(`/teacher/student/${s.id}/grades`)
                              }
                            >
                              Notas
                            </button>
                            <button
                              className={`px-3 py-1.5 rounded-lg transition-colors ${
                                !s.can_ascend
                                  ? "text-slate-600 cursor-not-allowed"
                                  : "text-teal-400 hover:bg-teal-500/10"
                              }`}
                              onClick={() =>
                                s.can_ascend &&
                                handleAscend(s.id, s.level_sort_order)
                              }
                              disabled={!s.can_ascend}
                              title={
                                s.can_ascend
                                  ? "Ascender al siguiente nivel"
                                  : "Debe completar y aprobar todos los m√≥dulos del nivel"
                              }
                            >
                              Ascender
                            </button>
                            <button
                              className="px-3 py-1.5 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors"
                              onClick={() =>
                                handleDeleteStudent(s.id, s.code ?? "")
                              }
                            >
                              Eliminar
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </section>
      </main>

      {/* Modal Avatar */}
      {showAvatarModal && (
        <div
          className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"
          onClick={() => setShowAvatarModal(false)}
        >
          <div
            className="bg-slate-900 rounded-2xl border border-slate-700/50 shadow-2xl max-w-xl w-full p-6"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-xl font-bold text-white">
                Selecciona tu avatar
              </h3>
              <button
                className="text-slate-400 hover:text-white transition-colors"
                onClick={() => setShowAvatarModal(false)}
              >
                <svg
                  className="w-6 h-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <div className="grid grid-cols-5 gap-3 mb-6">
              {AVATARS.map((a) => (
                <button
                  key={a.key}
                  className={`p-2 rounded-xl border-2 transition-all ${
                    selectedAvatar === a.key
                      ? "border-blue-500 ring-2 ring-blue-500/20 scale-110"
                      : "border-slate-700/50 hover:border-slate-600"
                  }`}
                  onClick={() => setSelectedAvatar(a.key)}
                >
                  <img src={a.url} alt={a.label} className="w-full" />
                </button>
              ))}
            </div>

            <div className="flex gap-3">
              <button
                className="flex-1 px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-medium transition-all"
                onClick={() => setShowAvatarModal(false)}
              >
                Cancelar
              </button>
              <button
                className="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl font-medium transition-all shadow-lg shadow-blue-900/30"
                onClick={saveAvatar}
              >
                Guardar Avatar
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal A√±adir Estudiante */}
      {showAddStudent && (
        <div
          className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"
          onClick={() => setShowAddStudent(false)}
        >
          <div
            className="bg-slate-900 rounded-2xl border border-slate-700/50 shadow-2xl max-w-lg w-full p-6"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-xl font-bold text-white">
                A√±adir Estudiante
              </h3>
              <button
                className="text-slate-400 hover:text-white transition-colors"
                onClick={() => setShowAddStudent(false)}
              >
                <svg
                  className="w-6 h-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <div className="space-y-4 mb-6">
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  Nombres *
                </label>
                <input
                  className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                  value={addFirstNames}
                  onChange={(e) => setAddFirstNames(e.target.value)}
                  placeholder="Ej: Juan Carlos"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    Apellido Paterno
                  </label>
                  <input
                    className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                    value={addLastNamePat}
                    onChange={(e) => setAddLastNamePat(e.target.value)}
                    placeholder="Ej: Garc√≠a"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    Apellido Materno
                  </label>
                  <input
                    className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                    value={addLastNameMat}
                    onChange={(e) => setAddLastNameMat(e.target.value)}
                    placeholder="Ej: L√≥pez"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  Celular *
                </label>
                <input
                  className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                  value={addPhone}
                  onChange={(e) => setAddPhone(e.target.value)}
                  placeholder="Ej: 72345678"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  Email (opcional)
                </label>
                <input
                  className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                  value={addEmail}
                  onChange={(e) => setAddEmail(e.target.value)}
                  placeholder="Ej: estudiante@correo.com"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  Nivel *
                </label>
                <select
                  className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                  value={addLevelId ?? ""}
                  onChange={(e) =>
                    setAddLevelId(
                      e.target.value ? Number(e.target.value) : null
                    )
                  }
                >
                  <option value="">Selecciona un nivel</option>
                  {levels.map((l) => (
                    <option key={l.id} value={l.id}>
                      {l.name}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  Contrase√±a Temporal *
                </label>
                <input
                  type="password"
                  className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                  value={addPassword}
                  onChange={(e) => setAddPassword(e.target.value)}
                  placeholder="Ej: 2025"
                />
              </div>
            </div>

            <div className="flex gap-3">
              <button
                className="flex-1 px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-medium transition-all"
                onClick={() => setShowAddStudent(false)}
              >
                Cancelar
              </button>
              <button
                className="flex-1 px-4 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white rounded-xl font-medium transition-all shadow-lg shadow-emerald-900/30 disabled:opacity-50"
                onClick={handleAddStudent}
                disabled={addingStudent}
              >
                {addingStudent ? "Creando..." : "Crear Estudiante"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal Editar Estudiante */}
      {showEditStudent && (
        <div
          className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"
          onClick={() => setShowEditStudent(false)}
        >
          <div
            className="bg-slate-900 rounded-2xl border border-slate-700/50 shadow-2xl max-w-lg w-full p-6"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-xl font-bold text-white">
                Editar Estudiante
              </h3>
              <button
                className="text-slate-400 hover:text-white transition-colors"
                onClick={() => setShowEditStudent(false)}
              >
                <svg
                  className="w-6 h-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <div className="space-y-4 mb-6">
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  Nombres *
                </label>
                <input
                  className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                  value={editStudentFirstNames}
                  onChange={(e) => setEditStudentFirstNames(e.target.value)}
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    Apellido Paterno
                  </label>
                  <input
                    className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                    value={editStudentLastNamePat}
                    onChange={(e) => setEditStudentLastNamePat(e.target.value)}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    Apellido Materno
                  </label>
                  <input
                    className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                    value={editStudentLastNameMat}
                    onChange={(e) => setEditStudentLastNameMat(e.target.value)}
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  Celular
                </label>
                <input
                  className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                  value={editStudentPhone}
                  onChange={(e) => setEditStudentPhone(e.target.value)}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  Email
                </label>
                <input
                  className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                  value={editStudentEmail}
                  onChange={(e) => setEditStudentEmail(e.target.value)}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  Nivel *
                </label>
                <select
                  className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                  value={editStudentLevelId ?? ""}
                  onChange={(e) =>
                    setEditStudentLevelId(
                      e.target.value ? Number(e.target.value) : null
                    )
                  }
                >
                  <option value="">Selecciona un nivel</option>
                  {levels.map((l) => (
                    <option key={l.id} value={l.id}>
                      {l.name}
                    </option>
                  ))}
                </select>
                <p className="text-xs text-slate-400 mt-2">
                  Puedes cambiar al nivel que desees. Para ascender
                  autom√°ticamente, usa el bot√≥n "Ascender".
                </p>
              </div>
            </div>

            <div className="flex gap-3">
              <button
                className="flex-1 px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-medium transition-all"
                onClick={() => setShowEditStudent(false)}
              >
                Cancelar
              </button>
              <button
                className="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl font-medium transition-all shadow-lg shadow-blue-900/30 disabled:opacity-50"
                onClick={handleEditStudent}
                disabled={editingStudentData}
              >
                {editingStudentData ? "Guardando..." : "Guardar Cambios"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal Reset Password */}
      {showResetPassword && (
        <div
          className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"
          onClick={() => setShowResetPassword(false)}
        >
          <div
            className="bg-slate-900 rounded-2xl border border-slate-700/50 shadow-2xl max-w-md w-full p-6"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-xl font-bold text-white">
                Resetear Contrase√±a
              </h3>
              <button
                className="text-slate-400 hover:text-white transition-colors"
                onClick={() => setShowResetPassword(false)}
              >
                <svg
                  className="w-6 h-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <div className="mb-4 p-4 bg-purple-500/10 border border-purple-500/20 rounded-xl">
              <p className="text-purple-400 text-sm">
                <strong className="block mb-1">
                  {resetPasswordStudentName}
                </strong>
                Se cambiar√° la contrase√±a de acceso
              </p>
            </div>

            <div className="space-y-4 mb-6">
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  Nueva Contrase√±a *
                </label>
                <input
                  type="password"
                  className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-transparent transition-all"
                  value={newPassword}
                  onChange={(e) => setNewPassword(e.target.value)}
                  placeholder="Ingresa la nueva contrase√±a"
                />
              </div>

              <div className="text-xs text-slate-400 bg-slate-800/30 p-3 rounded-lg">
                üí° Tip: Usa una contrase√±a que el estudiante pueda recordar
                f√°cilmente, como su fecha de nacimiento o el a√±o actual.
              </div>
            </div>

            <div className="flex gap-3">
              <button
                className="flex-1 px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-medium transition-all"
                onClick={() => setShowResetPassword(false)}
              >
                Cancelar
              </button>
              <button
                className="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-xl font-medium transition-all shadow-lg shadow-purple-900/30 disabled:opacity-50"
                onClick={handleResetPassword}
                disabled={resettingPassword}
              >
                {resettingPassword
                  ? "Actualizando..."
                  : "Actualizar Contrase√±a"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


----------------------------------------------------------------------------------------- 
// src\pages\TeacherModuleGrades.tsx
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/pages/TeacherModuleGrades.tsx
// üé® VERSI√ìN FINAL: Mejoras UX + Colores din√°micos + Mensajes amigables

import { useEffect, useState } from "react";
import { Navigate, useNavigate, useParams } from "react-router-dom";
import { supabase } from "../lib/supabase";
import { useRole } from "../lib/useRole";

type ModuleRow = {
  id: number;
  level_id: number;
  title: string;
  sort_order: number;
};

type LevelRow = {
  id: number;
  name: string;
  sort_order: number;
  career_id: number;
};

type StudentProfile = {
  id: string;
  code: string | null;
  full_name: string | null;
};

type ModuleGrade = {
  student_id: string;
  module_id: number;
  ser: number | null;
  saber: number | null;
  hacer_proceso: number | null;
  hacer_producto: number | null;
  decidir: number | null;
  auto_ser: number | null;
  auto_decidir: number | null;
};

type StudentRow = {
  student: StudentProfile;
  grade: ModuleGrade;
  progress: number;
  suggestedHP: number;
  total: number;
  saving: boolean;
};

export default function TeacherModuleGrades() {
  const nav = useNavigate();
  const { loading, session, role } = useRole();
  const { moduleId } = useParams();

  const [moduleRow, setModuleRow] = useState<ModuleRow | null>(null);
  const [levelRow, setLevelRow] = useState<LevelRow | null>(null);
  const [careerName, setCareerName] = useState<string>("");
  const [teacherShift, setTeacherShift] = useState<string>("");
  const [rows, setRows] = useState<StudentRow[]>([]);
  const [loadingData, setLoadingData] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);

  const isTeacherish = role === "teacher" || role === "admin";
  const mid = parseInt(moduleId ?? "", 10);
  const invalidMid = isNaN(mid) || mid <= 0;

  useEffect(() => {
    if (!session || !isTeacherish || invalidMid) return;
    loadAll();
  }, [session, isTeacherish, mid]);

  async function loadAll() {
    setLoadingData(true);
    setMsg(null);

    try {
      const { data: teacherProfile, error: profError } = await supabase
        .from("profiles")
        .select("career_id, shift")
        .eq("id", session!.user.id)
        .single();

      if (profError || !teacherProfile) {
        setMsg("Error cargando perfil del docente");
        setLoadingData(false);
        return;
      }

      setTeacherShift(teacherProfile.shift || "");

      // Cargar nombre de la carrera
      if (teacherProfile.career_id) {
        const { data: career } = await supabase
          .from("careers")
          .select("name")
          .eq("id", teacherProfile.career_id)
          .single();

        if (career) {
          setCareerName(career.name);
        }
      }

      const { data: module, error: moduleError } = await supabase
        .from("modules")
        .select("id,level_id,title,sort_order")
        .eq("id", mid)
        .single();

      if (moduleError || !module) {
        setMsg("M√≥dulo no encontrado");
        setLoadingData(false);
        return;
      }

      setModuleRow(module as ModuleRow);

      const { data: level, error: levelError } = await supabase
        .from("levels")
        .select("id,name,sort_order,career_id")
        .eq("id", module.level_id)
        .single();

      if (levelError || !level) {
        setMsg("Nivel no encontrado");
        setLoadingData(false);
        return;
      }

      setLevelRow(level as LevelRow);

      const { data: enrollments, error: enrollError } = await supabase
        .from("enrollments")
        .select("student_id,level_id")
        .eq("level_id", module.level_id);

      if (enrollError) {
        setMsg("Error cargando enrollments");
        setLoadingData(false);
        return;
      }

      const studentIds = (enrollments ?? []).map((e: any) => e.student_id);

      if (studentIds.length === 0) {
        setRows([]);
        setLoadingData(false);
        setMsg("No hay estudiantes en este nivel");
        return;
      }

      const { data: profiles, error: profilesError } = await supabase
        .from("profiles")
        .select("id,code,full_name")
        .in("id", studentIds)
        .eq("career_id", teacherProfile.career_id)
        .eq("shift", teacherProfile.shift)
        .order("code");

      if (profilesError) {
        setMsg("Error cargando estudiantes");
        setLoadingData(false);
        return;
      }

      const students = (profiles ?? []) as StudentProfile[];

      if (students.length === 0) {
        setRows([]);
        setLoadingData(false);
        setMsg("No hay estudiantes de tu carrera y turno en este nivel");
        return;
      }

      const { data: progressData } = await supabase
        .from("v_module_progress")
        .select("student_id,progress_percent")
        .eq("module_id", mid)
        .in(
          "student_id",
          students.map((s) => s.id)
        );

      const progressMap = new Map<string, number>();
      if (progressData) {
        for (const p of progressData) {
          progressMap.set(p.student_id, p.progress_percent || 0);
        }
      }

      const { data: grades } = await supabase
        .from("module_grades")
        .select(
          "student_id,module_id,ser,saber,hacer_proceso,hacer_producto,decidir,auto_ser,auto_decidir"
        )
        .eq("module_id", mid)
        .in(
          "student_id",
          students.map((s) => s.id)
        );

      const gradesMap = new Map<string, ModuleGrade>();
      if (grades) {
        for (const g of grades) {
          gradesMap.set(g.student_id, g as ModuleGrade);
        }
      }

      const studentRows: StudentRow[] = students.map((student) => {
        const existingGrade = gradesMap.get(student.id);
        const progress = progressMap.get(student.id) || 0;
        const suggestedHP = Math.round((progress / 100) * 20);

        const grade: ModuleGrade = existingGrade || {
          student_id: student.id,
          module_id: mid,
          ser: null,
          saber: null,
          hacer_proceso: null,
          hacer_producto: null,
          decidir: null,
          auto_ser: null,
          auto_decidir: null,
        };

        return {
          student,
          grade,
          progress,
          suggestedHP,
          total: calculateTotal(grade, suggestedHP),
          saving: false,
        };
      });

      setRows(studentRows);
      setLoadingData(false);
    } catch (error) {
      console.error("Error:", error);
      setMsg("Error cargando datos");
      setLoadingData(false);
    }
  }

  function calculateTotal(grade: ModuleGrade, suggestedHP: number): number {
    const ser = grade.ser ?? 0;
    const saber = grade.saber ?? 0;
    const hacerProceso = grade.hacer_proceso ?? suggestedHP;
    const hacerProducto = grade.hacer_producto ?? 0;
    const decidir = grade.decidir ?? 0;
    const autoSer = grade.auto_ser ?? 0;
    const autoDecidir = grade.auto_decidir ?? 0;

    return (
      ser +
      saber +
      hacerProceso +
      hacerProducto +
      decidir +
      autoSer +
      autoDecidir
    );
  }

  function updateGradeField(
    studentId: string,
    field: keyof ModuleGrade,
    value: string
  ) {
    const numValue = value.trim() === "" ? null : Number(value);

    setRows((prev) =>
      prev.map((row) => {
        if (row.student.id !== studentId) return row;

        const updatedGrade = { ...row.grade, [field]: numValue };
        return {
          ...row,
          grade: updatedGrade,
          total: calculateTotal(updatedGrade, row.suggestedHP),
        };
      })
    );
  }

  function getProgressColor(progress: number): string {
    if (progress >= 70) return "from-emerald-500 to-emerald-600";
    if (progress >= 51) return "from-amber-500 to-amber-600";
    return "from-red-500 to-red-600";
  }

  function getProgressTextColor(progress: number): string {
    if (progress >= 70) return "text-emerald-400";
    if (progress >= 51) return "text-amber-400";
    return "text-red-400";
  }

  function parseErrorMessage(error: string): string {
    // Mensajes amigables para constraints
    if (error.includes("check_ser_range")) {
      return "‚ùå Error: SER debe estar entre 0 y 10 puntos";
    }
    if (error.includes("check_saber_range")) {
      return "‚ùå Error: SABER debe estar entre 0 y 30 puntos";
    }
    if (error.includes("check_hacer_proceso_range")) {
      return "‚ùå Error: HACER PROCESO debe estar entre 0 y 20 puntos";
    }
    if (error.includes("check_hacer_producto_range")) {
      return "‚ùå Error: HACER PRODUCTO debe estar entre 0 y 20 puntos";
    }
    if (error.includes("check_decidir_range")) {
      return "‚ùå Error: DECIDIR debe estar entre 0 y 10 puntos";
    }
    if (error.includes("check_auto_ser_range")) {
      return "‚ùå Error: AUTO SER debe estar entre 0 y 5 puntos";
    }
    if (error.includes("check_auto_decidir_range")) {
      return "‚ùå Error: AUTO DECIDIR debe estar entre 0 y 5 puntos";
    }

    // Mensaje gen√©rico para otros errores
    return `‚ùå Error: ${error}`;
  }

  async function saveGrade(studentId: string) {
    const row = rows.find((r) => r.student.id === studentId);
    if (!row) return;

    setRows((prev) =>
      prev.map((r) => (r.student.id === studentId ? { ...r, saving: true } : r))
    );

    try {
      const hacerProcesoFinal = row.grade.hacer_proceso ?? row.suggestedHP;

      const { error } = await supabase.from("module_grades").upsert(
        {
          student_id: row.student.id,
          module_id: mid,
          ser: row.grade.ser,
          saber: row.grade.saber,
          hacer_proceso: hacerProcesoFinal,
          hacer_producto: row.grade.hacer_producto,
          decidir: row.grade.decidir,
          auto_ser: row.grade.auto_ser,
          auto_decidir: row.grade.auto_decidir,
        },
        { onConflict: "student_id,module_id" }
      );

      if (error) {
        setMsg(parseErrorMessage(error.message));
      } else {
        setMsg("‚úÖ Calificaci√≥n guardada correctamente");
      }
    } catch (error) {
      setMsg(`‚ùå Error: ${error}`);
    } finally {
      setRows((prev) =>
        prev.map((r) =>
          r.student.id === studentId ? { ...r, saving: false } : r
        )
      );
    }
  }

  if (loading)
    return (
      <div className="min-h-screen bg-slate-950 flex items-center justify-center">
        <div className="text-slate-300">Cargando...</div>
      </div>
    );
  if (!session) return <Navigate to="/login" replace />;
  if (!isTeacherish) return <Navigate to="/student" replace />;
  if (invalidMid) return <Navigate to="/teacher/modules" replace />;

  return (
    <div className="min-h-screen bg-slate-950">
      <header className="bg-gradient-to-r from-slate-900 via-slate-900 to-slate-800 border-b border-slate-800/50 shadow-xl">
        <div className="max-w-[1600px] mx-auto px-6 py-6">
          <button
            className="flex items-center gap-2 text-slate-300 hover:text-white mb-4 transition-colors group"
            onClick={() => nav("/teacher/modules")}
          >
            <svg
              className="w-5 h-5 transition-transform group-hover:-translate-x-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M15 19l-7-7 7-7"
              />
            </svg>
            <span className="font-medium">Volver a M√≥dulos</span>
          </button>
          <div className="text-slate-400 text-sm font-medium mb-1">
            {levelRow?.name ?? "Cargando..."}
          </div>
          <h1 className="text-3xl font-bold text-white">
            {moduleRow?.title ?? "Cargando m√≥dulo..."}
          </h1>
          <p className="text-slate-400 mt-1">
            {careerName} ¬∑ Turno {teacherShift}
          </p>
        </div>
      </header>

      <main className="max-w-[1600px] mx-auto px-6 py-8 space-y-6">
        {msg && (
          <div
            className={`px-6 py-4 rounded-xl font-medium animate-in fade-in slide-in-from-top-2 duration-300 ${
              msg.includes("‚úÖ")
                ? "bg-emerald-500/10 border border-emerald-500/20 text-emerald-400"
                : "bg-red-500/10 border border-red-500/20 text-red-400"
            }`}
          >
            {msg}
          </div>
        )}

        {loadingData ? (
          <div className="bg-slate-900 rounded-2xl border border-slate-700/50 p-12 text-center">
            <div className="text-slate-300 text-lg">
              Cargando estudiantes...
            </div>
          </div>
        ) : rows.length === 0 ? (
          <div className="bg-slate-900 rounded-2xl border border-slate-700/50 p-12 text-center">
            <div className="text-6xl mb-4 opacity-20">üë•</div>
            <div className="text-xl font-semibold text-white mb-2">
              No hay estudiantes
            </div>
            <div className="text-slate-400">
              No hay estudiantes de tu carrera y turno en este nivel
            </div>
          </div>
        ) : (
          <div className="bg-slate-900 rounded-2xl border border-slate-700/50 overflow-hidden shadow-2xl">
            <div className="overflow-x-auto">
              <table className="min-w-full">
                <thead className="bg-slate-800/50">
                  <tr>
                    <th className="px-3 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      C√≥digo
                    </th>
                    <th className="px-3 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      Estudiante
                    </th>
                    <th className="px-3 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      Progreso
                    </th>
                    <th className="px-3 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      SER
                      <br />
                      <span className="text-xs font-normal text-slate-400">
                        (10)
                      </span>
                    </th>
                    <th className="px-3 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      SABER
                      <br />
                      <span className="text-xs font-normal text-slate-400">
                        (30)
                      </span>
                    </th>
                    <th className="px-3 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      HACER
                      <br />
                      Proceso
                      <br />
                      <span className="text-xs font-normal text-slate-400">
                        (20)
                      </span>
                    </th>
                    <th className="px-3 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      HACER
                      <br />
                      Producto
                      <br />
                      <span className="text-xs font-normal text-slate-400">
                        (20)
                      </span>
                    </th>
                    <th className="px-3 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      DECIDIR
                      <br />
                      <span className="text-xs font-normal text-slate-400">
                        (10)
                      </span>
                    </th>
                    <th className="px-3 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      AUTO
                      <br />
                      SER
                      <br />
                      <span className="text-xs font-normal text-slate-400">
                        (5)
                      </span>
                    </th>
                    <th className="px-3 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      AUTO
                      <br />
                      DECIDIR
                      <br />
                      <span className="text-xs font-normal text-slate-400">
                        (5)
                      </span>
                    </th>
                    <th className="px-3 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      TOTAL
                      <br />
                      <span className="text-xs font-normal text-slate-400">
                        (100)
                      </span>
                    </th>
                    <th className="px-3 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-800/50">
                  {rows.map((row) => (
                    <tr
                      key={row.student.id}
                      className="hover:bg-slate-800/30 transition-colors"
                    >
                      <td className="px-3 py-4 whitespace-nowrap text-sm font-medium text-white">
                        {row.student.code}
                      </td>
                      <td className="px-3 py-4 whitespace-nowrap text-sm text-slate-200">
                        {row.student.full_name}
                      </td>
                      <td className="px-3 py-4 text-center">
                        <div className="flex flex-col items-center gap-1">
                          <span
                            className={`text-sm font-semibold ${getProgressTextColor(
                              row.progress
                            )}`}
                          >
                            {row.progress}%
                          </span>
                          <div className="w-16 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                            <div
                              className={`h-full bg-gradient-to-r ${getProgressColor(
                                row.progress
                              )} rounded-full transition-all duration-500`}
                              style={{ width: `${row.progress}%` }}
                            />
                          </div>
                        </div>
                      </td>

                      {/* SER (10) */}
                      <td className="px-3 py-4">
                        <input
                          type="number"
                          className="w-16 px-2 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white text-center text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                          min="0"
                          max="10"
                          value={row.grade.ser ?? ""}
                          onChange={(e) =>
                            updateGradeField(
                              row.student.id,
                              "ser",
                              e.target.value
                            )
                          }
                          placeholder="0"
                        />
                      </td>

                      {/* SABER (30) */}
                      <td className="px-3 py-4">
                        <input
                          type="number"
                          className="w-16 px-2 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white text-center text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                          min="0"
                          max="30"
                          value={row.grade.saber ?? ""}
                          onChange={(e) =>
                            updateGradeField(
                              row.student.id,
                              "saber",
                              e.target.value
                            )
                          }
                          placeholder="0"
                        />
                      </td>

                      {/* HACER Proceso (20) con sugerencia */}
                      <td className="px-3 py-4">
                        <div className="flex flex-col items-center gap-1">
                          <input
                            type="number"
                            className="w-16 px-2 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white text-center text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/50 focus:border-transparent transition-all"
                            min="0"
                            max="20"
                            value={row.grade.hacer_proceso ?? ""}
                            onChange={(e) =>
                              updateGradeField(
                                row.student.id,
                                "hacer_proceso",
                                e.target.value
                              )
                            }
                            placeholder={String(row.suggestedHP)}
                          />
                          <span className="text-xs text-amber-400 font-medium">
                            {row.suggestedHP}/20
                          </span>
                        </div>
                      </td>

                      {/* HACER Producto (20) */}
                      <td className="px-3 py-4">
                        <input
                          type="number"
                          className="w-16 px-2 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white text-center text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                          min="0"
                          max="20"
                          value={row.grade.hacer_producto ?? ""}
                          onChange={(e) =>
                            updateGradeField(
                              row.student.id,
                              "hacer_producto",
                              e.target.value
                            )
                          }
                          placeholder="0"
                        />
                      </td>

                      {/* DECIDIR (10) */}
                      <td className="px-3 py-4">
                        <input
                          type="number"
                          className="w-16 px-2 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white text-center text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                          min="0"
                          max="10"
                          value={row.grade.decidir ?? ""}
                          onChange={(e) =>
                            updateGradeField(
                              row.student.id,
                              "decidir",
                              e.target.value
                            )
                          }
                          placeholder="0"
                        />
                      </td>

                      {/* AUTO SER (5) */}
                      <td className="px-3 py-4">
                        <input
                          type="number"
                          className="w-16 px-2 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white text-center text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                          min="0"
                          max="5"
                          value={row.grade.auto_ser ?? ""}
                          onChange={(e) =>
                            updateGradeField(
                              row.student.id,
                              "auto_ser",
                              e.target.value
                            )
                          }
                          placeholder="0"
                        />
                      </td>

                      {/* AUTO DECIDIR (5) */}
                      <td className="px-3 py-4">
                        <input
                          type="number"
                          className="w-16 px-2 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg text-white text-center text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                          min="0"
                          max="5"
                          value={row.grade.auto_decidir ?? ""}
                          onChange={(e) =>
                            updateGradeField(
                              row.student.id,
                              "auto_decidir",
                              e.target.value
                            )
                          }
                          placeholder="0"
                        />
                      </td>

                      {/* TOTAL */}
                      <td className="px-3 py-4 text-center">
                        <div
                          className={`text-xl font-bold ${
                            row.total >= 51
                              ? "text-emerald-400"
                              : "text-red-400"
                          }`}
                        >
                          {row.total}
                        </div>
                      </td>

                      {/* Acciones */}
                      <td className="px-3 py-4 text-center">
                        <button
                          className="px-4 py-2 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white text-sm rounded-lg font-medium transition-all duration-200 shadow-lg shadow-emerald-900/30 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
                          onClick={() => saveGrade(row.student.id)}
                          disabled={row.saving}
                        >
                          {row.saving ? "Guardando..." : "Guardar"}
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Leyenda compacta en una l√≠nea */}
        <div className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl border border-slate-700/50 p-6 shadow-xl">
          <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <span className="text-2xl">üìä</span>
            Ponderaci√≥n de Calificaciones
          </h3>
          <div className="flex flex-wrap items-center gap-3">
            <div className="px-4 py-2 bg-slate-800/30 rounded-xl border border-slate-700/30">
              <span className="text-slate-400 text-sm">SER:</span>
              <span className="text-white text-sm font-bold ml-2">10 pts</span>
            </div>
            <div className="px-4 py-2 bg-slate-800/30 rounded-xl border border-slate-700/30">
              <span className="text-slate-400 text-sm">SABER:</span>
              <span className="text-white text-sm font-bold ml-2">30 pts</span>
            </div>
            <div className="px-4 py-2 bg-slate-800/30 rounded-xl border border-slate-700/30">
              <span className="text-slate-400 text-sm">HACER Proceso:</span>
              <span className="text-white text-sm font-bold ml-2">20 pts</span>
            </div>
            <div className="px-4 py-2 bg-slate-800/30 rounded-xl border border-slate-700/30">
              <span className="text-slate-400 text-sm">HACER Producto:</span>
              <span className="text-white text-sm font-bold ml-2">20 pts</span>
            </div>
            <div className="px-4 py-2 bg-slate-800/30 rounded-xl border border-slate-700/30">
              <span className="text-slate-400 text-sm">DECIDIR:</span>
              <span className="text-white text-sm font-bold ml-2">10 pts</span>
            </div>
            <div className="px-4 py-2 bg-slate-800/30 rounded-xl border border-slate-700/30">
              <span className="text-slate-400 text-sm">AUTO SER:</span>
              <span className="text-white text-sm font-bold ml-2">5 pts</span>
            </div>
            <div className="px-4 py-2 bg-slate-800/30 rounded-xl border border-slate-700/30">
              <span className="text-slate-400 text-sm">AUTO DECIDIR:</span>
              <span className="text-white text-sm font-bold ml-2">5 pts</span>
            </div>
            <div className="px-4 py-2 bg-gradient-to-br from-blue-600/20 to-blue-700/20 rounded-xl border border-blue-500/30">
              <span className="text-blue-300 text-sm">TOTAL:</span>
              <span className="text-white text-sm font-bold ml-2">100 pts</span>
            </div>
          </div>

          <div className="mt-4 p-3 bg-slate-800/30 rounded-xl border border-slate-700/30">
            <span className="text-slate-300 text-sm">
              <strong className="text-white">Nota m√≠nima de aprobaci√≥n:</strong>{" "}
              51 puntos
            </span>
          </div>
        </div>
      </main>
    </div>
  );
}


----------------------------------------------------------------------------------------- 
// src\pages\TeacherModules.tsx
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/pages/TeacherModules.tsx
// üé® Lista de m√≥dulos en tema oscuro

import { useEffect, useState } from "react";
import { Navigate, useNavigate } from "react-router-dom";
import { supabase } from "../lib/supabase";
import { useRole } from "../lib/useRole";

type Level = {
  id: number;
  name: string;
  sort_order: number;
  career_id: number;
};

type Module = {
  id: number;
  level_id: number;
  title: string;
  description: string | null;
  sort_order: number;
  is_active: boolean | null;
};

type LevelWithModules = {
  level: Level;
  modules: Module[];
};

export default function TeacherModules() {
  const nav = useNavigate();
  const { loading, session, role } = useRole();

  const [data, setData] = useState<LevelWithModules[]>([]);
  const [loadingData, setLoadingData] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);

  const isTeacherish = role === "teacher" || role === "admin";

  useEffect(() => {
    if (!session || !isTeacherish) return;

    async function load() {
      setLoadingData(true);
      setMsg(null);

      try {
        const { data: teacherProfile, error: profError } = await supabase
          .from("profiles")
          .select("career_id")
          .eq("id", session.user.id)
          .single();

        if (profError || !teacherProfile?.career_id) {
          setMsg("Error: No se pudo cargar tu carrera");
          setLoadingData(false);
          return;
        }

        const { data: levels, error: levelsError } = await supabase
          .from("levels")
          .select("id,name,sort_order,career_id")
          .eq("career_id", teacherProfile.career_id)
          .order("sort_order");

        if (levelsError) {
          setMsg("Error cargando niveles: " + levelsError.message);
          setLoadingData(false);
          return;
        }

        const levelsList = (levels ?? []) as Level[];
        const levelsWithModules: LevelWithModules[] = [];

        for (const level of levelsList) {
          const { data: modules, error: modulesError } = await supabase
            .from("modules")
            .select("id,level_id,title,description,sort_order,is_active")
            .eq("level_id", level.id)
            .order("sort_order");

          if (!modulesError) {
            levelsWithModules.push({
              level,
              modules: (modules ?? []) as Module[],
            });
          }
        }

        setData(levelsWithModules);
        setLoadingData(false);
      } catch (error) {
        console.error("Error:", error);
        setMsg("Error cargando datos");
        setLoadingData(false);
      }
    }

    load();
  }, [session, isTeacherish]);

  if (loading)
    return (
      <div className="min-h-screen bg-slate-950 flex items-center justify-center">
        <div className="text-slate-300">Cargando...</div>
      </div>
    );

  if (!session) return <Navigate to="/login" replace />;
  if (!isTeacherish) return <Navigate to="/student" replace />;

  return (
    <div className="min-h-screen bg-slate-950">
      <header className="bg-gradient-to-r from-slate-900 via-slate-900 to-slate-800 border-b border-slate-800/50 shadow-xl">
        <div className="max-w-7xl mx-auto px-6 py-6">
          <button
            className="flex items-center gap-2 text-slate-300 hover:text-white mb-4 transition-colors group"
            onClick={() => nav("/teacher")}
          >
            <svg
              className="w-5 h-5 transition-transform group-hover:-translate-x-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M15 19l-7-7 7-7"
              />
            </svg>
            <span className="font-medium">Volver al Panel</span>
          </button>

          <div className="text-slate-400 text-sm font-medium mb-1">
            CEA Madre Mar√≠a Oliva
          </div>
          <h1 className="text-3xl font-bold text-white">M√≥dulos por Nivel</h1>
          <p className="text-slate-400 mt-2">
            Selecciona un m√≥dulo para gestionar las calificaciones
          </p>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-8 space-y-6">
        {msg && (
          <div
            className={`px-6 py-4 rounded-xl font-medium animate-in fade-in slide-in-from-top-2 duration-300 ${
              msg.includes("‚úÖ")
                ? "bg-emerald-500/10 border border-emerald-500/20 text-emerald-400"
                : "bg-red-500/10 border border-red-500/20 text-red-400"
            }`}
          >
            {msg}
          </div>
        )}

        {loadingData ? (
          <div className="bg-slate-900 rounded-2xl border border-slate-700/50 p-12 text-center">
            <div className="text-slate-300 text-lg">Cargando m√≥dulos...</div>
          </div>
        ) : data.length === 0 ? (
          <div className="bg-slate-900 rounded-2xl border border-slate-700/50 p-12 text-center">
            <div className="text-6xl mb-4 opacity-20">üìö</div>
            <div className="text-xl font-semibold text-white mb-2">
              No hay m√≥dulos disponibles
            </div>
            <div className="text-slate-400">
              Contacta al administrador para configurar los m√≥dulos
            </div>
          </div>
        ) : (
          <div className="space-y-8">
            {data.map(({ level, modules }) => (
              <section
                key={level.id}
                className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl border border-slate-700/50 p-8 shadow-2xl"
              >
                <div className="flex items-center gap-4 mb-6">
                  <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-900/50">
                    {level.sort_order}
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold text-white">
                      {level.name}
                    </h2>
                    <p className="text-slate-400 text-sm">
                      {modules.length} m√≥dulos
                    </p>
                  </div>
                </div>

                {modules.length === 0 ? (
                  <div className="p-6 bg-slate-800/30 rounded-xl border border-slate-700/30 text-center">
                    <p className="text-slate-400">
                      No hay m√≥dulos en este nivel
                    </p>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {modules
                      .filter((m) => m.is_active !== false)
                      .sort((a, b) => a.sort_order - b.sort_order)
                      .map((module) => (
                        <button
                          key={module.id}
                          className="group p-6 bg-slate-800/30 hover:bg-slate-800/50 border border-slate-700/30 hover:border-slate-600 rounded-xl text-left transition-all duration-200"
                          onClick={() =>
                            nav(`/teacher/module/${module.id}/grades`)
                          }
                        >
                          <div className="flex items-start justify-between mb-3">
                            <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-600/20 to-emerald-700/20 border border-emerald-500/20 flex items-center justify-center text-emerald-400 font-bold group-hover:scale-110 transition-transform">
                              {module.sort_order}
                            </div>
                            <svg
                              className="w-5 h-5 text-slate-500 group-hover:text-white group-hover:translate-x-1 transition-all"
                              fill="none"
                              viewBox="0 0 24 24"
                              stroke="currentColor"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M9 5l7 7-7 7"
                              />
                            </svg>
                          </div>

                          <h3 className="text-lg font-semibold text-white mb-2 group-hover:text-blue-400 transition-colors">
                            {module.title}
                          </h3>

                          {module.description && (
                            <p className="text-sm text-slate-400 line-clamp-2">
                              {module.description}
                            </p>
                          )}

                          <div className="mt-4 flex items-center gap-2 text-xs text-slate-500">
                            <span>Click para ver calificaciones</span>
                            <svg
                              className="w-4 h-4"
                              fill="none"
                              viewBox="0 0 24 24"
                              stroke="currentColor"
                            >
                              <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M9 5l7 7-7 7"
                              />
                            </svg>
                          </div>
                        </button>
                      ))}
                  </div>
                )}
              </section>
            ))}
          </div>
        )}
      </main>
    </div>
  );
}


----------------------------------------------------------------------------------------- 
// src\pages\TeacherStudentGrades.tsx
----------------------------------------------------------------------------------------- 
// cea-plataforma/web/src/pages/StudentGradesHistory.tsx
// üé® Historial + Bolet√≠n PDF por Nivel con mejoras est√©ticas

import { useEffect, useState } from "react";
import { Navigate, useNavigate, useParams } from "react-router-dom";
import { supabase } from "../lib/supabase";
import { useRole } from "../lib/useRole";
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";

type GradeHistoryRow = {
  module_id: number;
  module_name: string;
  module_order: number;
  level_id: number;
  level_name: string;
  level_order: number;
  ser: number;
  saber: number;
  hacer_proceso: number;
  hacer_producto: number;
  decidir: number;
  auto_ser: number;
  auto_decidir: number;
  total: number;
  observation: string;
};

type StudentProfile = {
  code: string | null;
  full_name: string | null;
  first_names: string | null;
  last_name_pat: string | null;
  last_name_mat: string | null;
  career_id: number | null;
  shift: string | null;
};

type Level = {
  id: number;
  name: string;
  sort_order: number;
};

export default function StudentGradesHistory() {
  const nav = useNavigate();
  const { loading, session, role } = useRole();
  const { studentId } = useParams();

  const [studentProfile, setStudentProfile] = useState<StudentProfile | null>(
    null
  );
  const [careerName, setCareerName] = useState<string>("");
  const [levels, setLevels] = useState<Level[]>([]);
  const [historyData, setHistoryData] = useState<GradeHistoryRow[]>([]);
  const [loadingData, setLoadingData] = useState(false);
  const [generatingPDF, setGeneratingPDF] = useState(false);
  const [selectedLevelId, setSelectedLevelId] = useState<number | null>(null);
  const [msg, setMsg] = useState<string | null>(null);

  const isTeacherish = role === "teacher" || role === "admin";

  useEffect(() => {
    if (!session || !isTeacherish || !studentId) return;

    async function load() {
      setLoadingData(true);
      setMsg(null);

      try {
        // Cargar perfil del estudiante
        const { data: profile, error: profileError } = await supabase
          .from("profiles")
          .select(
            "code,full_name,first_names,last_name_pat,last_name_mat,career_id,shift"
          )
          .eq("id", studentId)
          .single();

        if (profileError) {
          setMsg("Error cargando estudiante: " + profileError.message);
          setLoadingData(false);
          return;
        }

        setStudentProfile(profile as StudentProfile);

        // Cargar carrera y niveles
        if (profile.career_id) {
          const { data: career } = await supabase
            .from("careers")
            .select("name")
            .eq("id", profile.career_id)
            .single();

          if (career) {
            setCareerName(career.name);
          }

          // Cargar niveles de la carrera
          const { data: levelsData } = await supabase
            .from("levels")
            .select("id,name,sort_order")
            .eq("career_id", profile.career_id)
            .order("sort_order");

          if (levelsData) {
            setLevels(levelsData as Level[]);
          }
        }

        // Cargar historial de calificaciones
        const { data: history, error: historyError } = await supabase
          .from("v_student_grade_history")
          .select(
            "module_id,module_name,module_order,level_id,level_name,level_order,ser,saber,hacer_proceso,hacer_producto,decidir,auto_ser,auto_decidir,total,observation"
          )
          .eq("student_id", studentId)
          .order("level_order", { ascending: true })
          .order("module_order", { ascending: true });

        if (historyError) {
          setMsg("Error cargando historial: " + historyError.message);
          setLoadingData(false);
          return;
        }

        setHistoryData((history ?? []) as GradeHistoryRow[]);
        setLoadingData(false);
      } catch (error) {
        console.error("Error:", error);
        setMsg("Error cargando datos");
        setLoadingData(false);
      }
    }

    load();
  }, [session, isTeacherish, studentId]);

  async function generatePDF() {
    if (!studentProfile) {
      setMsg("No hay datos del participante");
      return;
    }

    if (!selectedLevelId) {
      setMsg("Por favor selecciona un nivel");
      return;
    }

    // Filtrar solo las notas del nivel seleccionado
    const levelGrades = historyData.filter(
      (row) => row.level_id === selectedLevelId
    );

    if (levelGrades.length === 0) {
      setMsg("‚ùå El participante no tiene notas cargadas en este nivel");
      return;
    }

    setGeneratingPDF(true);
    setMsg(null);

    try {
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();

      // Obtener nombre del nivel seleccionado
      const selectedLevel = levels.find((l) => l.id === selectedLevelId);
      const levelName = selectedLevel?.name || "N/A";

      // Logo en esquina superior izquierda
      const logoBase64 =
        "data:image/png;base64,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"; // ‚Üê Pegar tu Base64 aqu√≠
      try {
        doc.addImage(logoBase64, "PNG", 15, 10, 25, 25); // x, y, ancho, alto
      } catch (error) {
        console.error("Error cargando logo:", error);
      }

      // Nombre instituci√≥n m√°s peque√±o
      doc.setFontSize(11);
      doc.setFont("helvetica", "bold");
      doc.text(' CEA "MADRE MAR√çA OLIVA"', pageWidth / 2, 27, {
        align: "center",
      });

      doc.setFontSize(9);
      doc.setFont("helvetica", "normal");
      doc.text("Centro de Educaci√≥n Alternativa", pageWidth / 2, 33, {
        align: "center",
      });

      // L√≠nea decorativa
      doc.setLineWidth(0.5);
      doc.line(15, 37, pageWidth - 15, 37);

      // T√≠tulo
      doc.setFontSize(13);
      doc.setFont("helvetica", "bold");
      doc.text("BOLET√çN DE CALIFICACIONES", pageWidth / 2, 45, {
        align: "center",
      });

      // Datos del participante
      let yPos = 54;
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");

      doc.text(`C√≥digo: ${studentProfile.code || "N/A"}`, 15, yPos);
      doc.text(
        `Participante: ${studentProfile.full_name || "N/A"}`,
        15,
        yPos + 6
      );
      doc.text(`Carrera: ${careerName || "N/A"}`, 15, yPos + 12);
      doc.text(`Nivel: ${levelName}`, 15, yPos + 18);
      doc.text(`Turno: ${studentProfile.shift || "N/A"}`, 15, yPos + 24);
      doc.text(
        `Fecha: ${new Date().toLocaleDateString("es-BO")}`,
        pageWidth - 60,
        yPos
      );

      yPos += 32;

      // Tabla de calificaciones
      const tableData = levelGrades.map((row) => [
        row.module_name,
        row.ser.toString(),
        row.saber.toString(),
        row.hacer_proceso.toString(),
        row.hacer_producto.toString(),
        row.decidir.toString(),
        row.auto_ser.toString(),
        row.auto_decidir.toString(),
        row.total.toString(),
        row.observation,
      ]);

      autoTable(doc, {
        startY: yPos,
        head: [
          [
            "M√≥dulo",
            "SER\n(10)",
            "SABER\n(30)",
            "HACER-Proc\n(20)",
            "HACER-Prod\n(20)",
            "DEC\n(10)",
            "AUTOEVA-SER\n(5)",
            "AUTOEVA-DEC\n(5)",
            "Total\n(100)",
            "Observaci√≥n",
          ],
        ],
        body: tableData,
        theme: "grid",
        headStyles: {
          fillColor: [30, 41, 59],
          textColor: [255, 255, 255],
          fontSize: 8,
          halign: "center",
          valign: "middle",
        },
        bodyStyles: {
          fontSize: 8,
          cellPadding: 2,
        },
        columnStyles: {
          0: { cellWidth: 40 },
          1: { cellWidth: 14, halign: "center" },
          2: { cellWidth: 14, halign: "center" },
          3: { cellWidth: 14, halign: "center" },
          4: { cellWidth: 14, halign: "center" },
          5: { cellWidth: 14, halign: "center" },
          6: { cellWidth: 14, halign: "center" },
          7: { cellWidth: 14, halign: "center" },
          8: { cellWidth: 14, halign: "center", fontStyle: "bold" },
          9: { cellWidth: 28, fontSize: 7 },
        },
        didDrawCell: (data) => {
          // Colorear el total seg√∫n el puntaje
          if (data.column.index === 8 && data.section === "body") {
            const total = parseInt(data.cell.text[0]);
            if (total >= 76) {
              doc.setTextColor(16, 185, 129); // Verde
            } else if (total >= 51) {
              doc.setTextColor(59, 130, 246); // Azul
            } else {
              doc.setTextColor(245, 158, 11); // Amarillo
            }
          }
        },
      });

      // Leyenda en una l√≠nea
      const finalY = (doc as any).lastAutoTable.finalY + 10;

      doc.setFontSize(9);
      doc.setFont("helvetica", "bold");
      doc.text("Escala de Calificaci√≥n:", 15, finalY);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(8);
      const legendText =
        "‚Ä¢ Promovido Excelente: 76-100 pts     ‚Ä¢ Promovido: 51-75 pts     ‚Ä¢ Postergado: <51 pts \n\n\n\n\n\n\n\n";
      doc.text(legendText, 15, finalY + 5);

      // Firmas
      const signaturesY = finalY + 40;

      doc.setFontSize(9);
      doc.setFont("helvetica", "normal");

      // Firma Direcci√≥n
      doc.line(20, signaturesY, 80, signaturesY);
      doc.text("DIRECCI√ìN", 50, signaturesY + 5, { align: "center" });

      // Firma Docente
      doc.line(pageWidth - 80, signaturesY, pageWidth - 20, signaturesY);
      doc.text("DOCENTE", pageWidth - 50, signaturesY + 5, { align: "center" });

      // Guardar PDF
      const fileName = `Boletin_${levelName.replace(/\s+/g, "_")}_${
        studentProfile.code || "Participante"
      }_${new Date().getTime()}.pdf`;
      doc.save(fileName);

      setMsg("‚úÖ Bolet√≠n generado exitosamente");
      setGeneratingPDF(false);
    } catch (error) {
      console.error("Error generando PDF:", error);
      setMsg("Error generando bolet√≠n");
      setGeneratingPDF(false);
    }
  }

  if (loading)
    return (
      <div className="min-h-screen bg-slate-950 flex items-center justify-center">
        <div className="text-slate-300">Cargando...</div>
      </div>
    );

  if (!session) return <Navigate to="/login" replace />;
  if (!isTeacherish) return <Navigate to="/student" replace />;

  return (
    <div className="min-h-screen bg-slate-950">
      <header className="bg-gradient-to-r from-slate-900 via-slate-900 to-slate-800 border-b border-slate-800/50 shadow-xl">
        <div className="max-w-[1800px] mx-auto px-6 py-6">
          <button
            className="flex items-center gap-2 text-slate-300 hover:text-white mb-4 transition-colors group"
            onClick={() => nav("/teacher")}
          >
            <svg
              className="w-5 h-5 transition-transform group-hover:-translate-x-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M15 19l-7-7 7-7"
              />
            </svg>
            <span className="font-medium">Volver al Panel</span>
          </button>

          <div className="text-slate-400 text-sm font-medium mb-1">
            Historial de Calificaciones
          </div>
          <h1 className="text-3xl font-bold text-white">
            {studentProfile?.full_name ?? "Cargando..."}
          </h1>
          <p className="text-slate-400 mt-1">
            {studentProfile?.code ?? ""} ¬∑ {careerName} ¬∑ Turno{" "}
            {studentProfile?.shift}
          </p>
        </div>
      </header>

      <main className="max-w-[1800px] mx-auto px-6 py-8 space-y-6">
        {msg && (
          <div
            className={`px-6 py-4 rounded-xl font-medium animate-in fade-in slide-in-from-top-2 duration-300 ${
              msg.includes("‚úÖ")
                ? "bg-emerald-500/10 border border-emerald-500/20 text-emerald-400"
                : "bg-red-500/10 border border-red-500/20 text-red-400"
            }`}
          >
            {msg}
          </div>
        )}

        {loadingData ? (
          <div className="bg-slate-900 rounded-2xl border border-slate-700/50 p-12 text-center">
            <div className="text-slate-300 text-lg">Cargando historial...</div>
          </div>
        ) : historyData.length === 0 ? (
          <div className="bg-slate-900 rounded-2xl border border-slate-700/50 p-12 text-center">
            <div className="text-6xl mb-4 opacity-20">üìä</div>
            <div className="text-xl font-semibold text-white mb-2">
              Sin calificaciones registradas
            </div>
            <div className="text-slate-400">
              Este participante a√∫n no tiene calificaciones en ning√∫n m√≥dulo
            </div>
          </div>
        ) : (
          <>
            <div className="bg-slate-900 rounded-2xl border border-slate-700/50 overflow-hidden shadow-2xl">
              <div className="overflow-x-auto">
                <table className="min-w-full">
                  <thead className="bg-slate-800/50">
                    <tr>
                      <th className="px-4 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        Nivel
                      </th>
                      <th className="px-4 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        M√≥dulo
                      </th>
                      <th className="px-4 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        SER
                        <br />
                        <span className="text-xs font-normal text-slate-400">
                          (10)
                        </span>
                      </th>
                      <th className="px-4 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        SABER
                        <br />
                        <span className="text-xs font-normal text-slate-400">
                          (30)
                        </span>
                      </th>
                      <th className="px-4 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        HACER
                        <br />
                        Proceso
                        <br />
                        <span className="text-xs font-normal text-slate-400">
                          (20)
                        </span>
                      </th>
                      <th className="px-4 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        HACER
                        <br />
                        Producto
                        <br />
                        <span className="text-xs font-normal text-slate-400">
                          (20)
                        </span>
                      </th>
                      <th className="px-4 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        DECIDIR
                        <br />
                        <span className="text-xs font-normal text-slate-400">
                          (10)
                        </span>
                      </th>
                      <th className="px-4 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        AUTO
                        <br />
                        SER
                        <br />
                        <span className="text-xs font-normal text-slate-400">
                          (5)
                        </span>
                      </th>
                      <th className="px-4 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        AUTO
                        <br />
                        DECIDIR
                        <br />
                        <span className="text-xs font-normal text-slate-400">
                          (5)
                        </span>
                      </th>
                      <th className="px-4 py-4 text-center text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        TOTAL
                        <br />
                        <span className="text-xs font-normal text-slate-400">
                          (100)
                        </span>
                      </th>
                      <th className="px-4 py-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider whitespace-nowrap">
                        Observaci√≥n
                      </th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-800/50">
                    {historyData.map((row) => (
                      <tr
                        key={row.module_id}
                        className="hover:bg-slate-800/30 transition-colors"
                      >
                        <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-300">
                          {row.level_name}
                        </td>
                        <td className="px-4 py-4 whitespace-nowrap text-sm font-semibold text-white">
                          {row.module_name}
                        </td>
                        <td className="px-4 py-4 text-center text-sm text-slate-200">
                          {row.ser}
                        </td>
                        <td className="px-4 py-4 text-center text-sm text-slate-200">
                          {row.saber}
                        </td>
                        <td className="px-4 py-4 text-center text-sm text-slate-200">
                          {row.hacer_proceso}
                        </td>
                        <td className="px-4 py-4 text-center text-sm text-slate-200">
                          {row.hacer_producto}
                        </td>
                        <td className="px-4 py-4 text-center text-sm text-slate-200">
                          {row.decidir}
                        </td>
                        <td className="px-4 py-4 text-center text-sm text-slate-200">
                          {row.auto_ser}
                        </td>
                        <td className="px-4 py-4 text-center text-sm text-slate-200">
                          {row.auto_decidir}
                        </td>
                        <td className="px-4 py-4 text-center">
                          <span
                            className={`text-lg font-bold ${
                              row.total >= 76
                                ? "text-emerald-400"
                                : row.total >= 51
                                ? "text-blue-400"
                                : "text-amber-400"
                            }`}
                          >
                            {row.total}
                          </span>
                        </td>
                        <td className="px-4 py-4 whitespace-nowrap">
                          <span
                            className={`px-3 py-1 rounded-lg text-xs font-medium ${
                              row.observation.includes("Excelente")
                                ? "bg-emerald-500/10 text-emerald-400 border border-emerald-500/20"
                                : row.observation.includes("Promovido")
                                ? "bg-blue-500/10 text-blue-400 border border-blue-500/20"
                                : "bg-amber-500/10 text-amber-400 border border-amber-500/20"
                            }`}
                          >
                            {row.observation}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Selector de Nivel y Bot√≥n Generar PDF */}
            <div className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl border border-slate-700/50 p-8 shadow-2xl">
              <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                <svg
                  className="w-6 h-6 text-blue-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
                Generar Bolet√≠n en PDF
              </h3>

              <div className="flex flex-col md:flex-row gap-6 items-end">
                <div className="flex-1">
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    Selecciona el Nivel
                  </label>
                  <select
                    className="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent transition-all"
                    value={selectedLevelId ?? ""}
                    onChange={(e) =>
                      setSelectedLevelId(
                        e.target.value ? parseInt(e.target.value) : null
                      )
                    }
                  >
                    <option value="">-- Selecciona un nivel --</option>
                    {levels.map((level) => (
                      <option key={level.id} value={level.id}>
                        {level.name}
                      </option>
                    ))}
                  </select>
                </div>

                <button
                  onClick={generatePDF}
                  disabled={generatingPDF || !selectedLevelId}
                  className="px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white text-lg font-semibold rounded-xl shadow-2xl shadow-blue-900/50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-3"
                >
                  {generatingPDF ? (
                    <>
                      <svg
                        className="animate-spin h-5 w-5"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <circle
                          className="opacity-25"
                          cx="12"
                          cy="12"
                          r="10"
                          stroke="currentColor"
                          strokeWidth="4"
                        ></circle>
                        <path
                          className="opacity-75"
                          fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        ></path>
                      </svg>
                      <span>Generando...</span>
                    </>
                  ) : (
                    <>
                      <svg
                        className="w-5 h-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        />
                      </svg>
                      <span>Generar Bolet√≠n</span>
                    </>
                  )}
                </button>
              </div>

              <div className="mt-4 p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl">
                <p className="text-sm text-blue-300">
                  üí° <strong>Tip:</strong> Selecciona el nivel del cual deseas
                  generar el bolet√≠n. El PDF incluir√° solo las calificaciones de
                  ese nivel.
                </p>
              </div>
            </div>

            {/* Leyenda */}
            <div className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl border border-slate-700/50 p-6 shadow-xl">
              <h3 className="text-lg font-bold text-white mb-4">
                üìä Escala de Calificaci√≥n
              </h3>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div className="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-xl">
                  <div className="text-emerald-400 font-semibold mb-1">
                    Promovido Excelente
                  </div>
                  <div className="text-slate-300 text-sm">76 - 100 puntos</div>
                </div>
                <div className="p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl">
                  <div className="text-blue-400 font-semibold mb-1">
                    Promovido
                  </div>
                  <div className="text-slate-300 text-sm">51 - 75 puntos</div>
                </div>
                <div className="p-4 bg-amber-500/10 border border-amber-500/20 rounded-xl">
                  <div className="text-amber-400 font-semibold mb-1">
                    Postergado
                  </div>
                  <div className="text-slate-300 text-sm">{"<"} 51 puntos</div>
                </div>
              </div>
            </div>
          </>
        )}
      </main>
    </div>
  );
}


----------------------------------------------------------------------------------------- 
// supabase\config.toml
----------------------------------------------------------------------------------------- 
# For detailed configuration reference documentation, visit:
# https://supabase.com/docs/guides/local-development/cli/config
# A string used to distinguish different Supabase projects on the same host. Defaults to the
# working directory name when running `supabase init`.
project_id = "web"

[api]
enabled = true
# Port to use for the API URL.
port = 54321
# Schemas to expose in your API. Tables, views and stored procedures in this schema will get API
# endpoints. `public` and `graphql_public` schemas are included by default.
schemas = ["public", "graphql_public"]
# Extra schemas to add to the search_path of every request.
extra_search_path = ["public", "extensions"]
# The maximum number of rows returns from a view, table, or stored procedure. Limits payload size
# for accidental or malicious requests.
max_rows = 1000

[api.tls]
# Enable HTTPS endpoints locally using a self-signed certificate.
enabled = false
# Paths to self-signed certificate pair.
# cert_path = "../certs/my-cert.pem"
# key_path = "../certs/my-key.pem"

[db]
# Port to use for the local database URL.
port = 54322
# Port used by db diff command to initialize the shadow database.
shadow_port = 54320
# The database major version to use. This has to be the same as your remote database's. Run `SHOW
# server_version;` on the remote database to check.
major_version = 17

[db.pooler]
enabled = false
# Port to use for the local connection pooler.
port = 54329
# Specifies when a server connection can be reused by other clients.
# Configure one of the supported pooler modes: `transaction`, `session`.
pool_mode = "transaction"
# How many server connections to allow per user/database pair.
default_pool_size = 20
# Maximum number of client connections allowed.
max_client_conn = 100

# [db.vault]
# secret_key = "env(SECRET_VALUE)"

[db.migrations]
# If disabled, migrations will be skipped during a db push or reset.
enabled = true
# Specifies an ordered list of schema files that describe your database.
# Supports glob patterns relative to supabase directory: "./schemas/*.sql"
schema_paths = []

[db.seed]
# If enabled, seeds the database after migrations during a db reset.
enabled = true
# Specifies an ordered list of seed files to load during db reset.
# Supports glob patterns relative to supabase directory: "./seeds/*.sql"
sql_paths = ["./seed.sql"]

[db.network_restrictions]
# Enable management of network restrictions.
enabled = false
# List of IPv4 CIDR blocks allowed to connect to the database.
# Defaults to allow all IPv4 connections. Set empty array to block all IPs.
allowed_cidrs = ["0.0.0.0/0"]
# List of IPv6 CIDR blocks allowed to connect to the database.
# Defaults to allow all IPv6 connections. Set empty array to block all IPs.
allowed_cidrs_v6 = ["::/0"]

[realtime]
enabled = true
# Bind realtime via either IPv4 or IPv6. (default: IPv4)
# ip_version = "IPv6"
# The maximum length in bytes of HTTP request headers. (default: 4096)
# max_header_length = 4096

[studio]
enabled = true
# Port to use for Supabase Studio.
port = 54323
# External URL of the API server that frontend connects to.
api_url = "http://127.0.0.1"
# OpenAI API Key to use for Supabase AI in the Supabase Studio.
openai_api_key = "env(OPENAI_API_KEY)"

# Email testing server. Emails sent with the local dev setup are not actually sent - rather, they
# are monitored, and you can view the emails that would have been sent from the web interface.
[inbucket]
enabled = true
# Port to use for the email testing server web interface.
port = 54324
# Uncomment to expose additional ports for testing user applications that send emails.
# smtp_port = 54325
# pop3_port = 54326
# admin_email = "admin@email.com"
# sender_name = "Admin"

[storage]
enabled = true
# The maximum file size allowed (e.g. "5MB", "500KB").
file_size_limit = "50MiB"

# Uncomment to configure local storage buckets
# [storage.buckets.images]
# public = false
# file_size_limit = "50MiB"
# allowed_mime_types = ["image/png", "image/jpeg"]
# objects_path = "./images"

# Allow connections via S3 compatible clients
[storage.s3_protocol]
enabled = true

# Image transformation API is available to Supabase Pro plan.
# [storage.image_transformation]
# enabled = true

# Store analytical data in S3 for running ETL jobs over Iceberg Catalog
# This feature is only available on the hosted platform.
[storage.analytics]
enabled = false
max_namespaces = 5
max_tables = 10
max_catalogs = 2

# Analytics Buckets is available to Supabase Pro plan.
# [storage.analytics.buckets.my-warehouse]

# Store vector embeddings in S3 for large and durable datasets
# This feature is only available on the hosted platform.
[storage.vector]
enabled = false
max_buckets = 10
max_indexes = 5

# Vector Buckets is available to Supabase Pro plan.
# [storage.vector.buckets.documents-openai]

[auth]
enabled = true
# The base URL of your website. Used as an allow-list for redirects and for constructing URLs used
# in emails.
site_url = "http://127.0.0.1:3000"
# A list of *exact* URLs that auth providers are permitted to redirect to post authentication.
additional_redirect_urls = ["https://127.0.0.1:3000"]
# How long tokens are valid for, in seconds. Defaults to 3600 (1 hour), maximum 604,800 (1 week).
jwt_expiry = 3600
# JWT issuer URL. If not set, defaults to the local API URL (http://127.0.0.1:<port>/auth/v1).
# jwt_issuer = ""
# Path to JWT signing key. DO NOT commit your signing keys file to git.
# signing_keys_path = "./signing_keys.json"
# If disabled, the refresh token will never expire.
enable_refresh_token_rotation = true
# Allows refresh tokens to be reused after expiry, up to the specified interval in seconds.
# Requires enable_refresh_token_rotation = true.
refresh_token_reuse_interval = 10
# Allow/disallow new user signups to your project.
enable_signup = true
# Allow/disallow anonymous sign-ins to your project.
enable_anonymous_sign_ins = false
# Allow/disallow testing manual linking of accounts
enable_manual_linking = false
# Passwords shorter than this value will be rejected as weak. Minimum 6, recommended 8 or more.
minimum_password_length = 6
# Passwords that do not meet the following requirements will be rejected as weak. Supported values
# are: `letters_digits`, `lower_upper_letters_digits`, `lower_upper_letters_digits_symbols`
password_requirements = ""

[auth.rate_limit]
# Number of emails that can be sent per hour. Requires auth.email.smtp to be enabled.
email_sent = 2
# Number of SMS messages that can be sent per hour. Requires auth.sms to be enabled.
sms_sent = 30
# Number of anonymous sign-ins that can be made per hour per IP address. Requires enable_anonymous_sign_ins = true.
anonymous_users = 30
# Number of sessions that can be refreshed in a 5 minute interval per IP address.
token_refresh = 150
# Number of sign up and sign-in requests that can be made in a 5 minute interval per IP address (excludes anonymous users).
sign_in_sign_ups = 30
# Number of OTP / Magic link verifications that can be made in a 5 minute interval per IP address.
token_verifications = 30
# Number of Web3 logins that can be made in a 5 minute interval per IP address.
web3 = 30

# Configure one of the supported captcha providers: `hcaptcha`, `turnstile`.
# [auth.captcha]
# enabled = true
# provider = "hcaptcha"
# secret = ""

[auth.email]
# Allow/disallow new user signups via email to your project.
enable_signup = true
# If enabled, a user will be required to confirm any email change on both the old, and new email
# addresses. If disabled, only the new email is required to confirm.
double_confirm_changes = true
# If enabled, users need to confirm their email address before signing in.
enable_confirmations = false
# If enabled, users will need to reauthenticate or have logged in recently to change their password.
secure_password_change = false
# Controls the minimum amount of time that must pass before sending another signup confirmation or password reset email.
max_frequency = "1s"
# Number of characters used in the email OTP.
otp_length = 6
# Number of seconds before the email OTP expires (defaults to 1 hour).
otp_expiry = 3600

# Use a production-ready SMTP server
# [auth.email.smtp]
# enabled = true
# host = "smtp.sendgrid.net"
# port = 587
# user = "apikey"
# pass = "env(SENDGRID_API_KEY)"
# admin_email = "admin@email.com"
# sender_name = "Admin"

# Uncomment to customize email template
# [auth.email.template.invite]
# subject = "You have been invited"
# content_path = "./supabase/templates/invite.html"

# Uncomment to customize notification email template
# [auth.email.notification.password_changed]
# enabled = true
# subject = "Your password has been changed"
# content_path = "./templates/password_changed_notification.html"

[auth.sms]
# Allow/disallow new user signups via SMS to your project.
enable_signup = false
# If enabled, users need to confirm their phone number before signing in.
enable_confirmations = false
# Template for sending OTP to users
template = "Your code is {{ .Code }}"
# Controls the minimum amount of time that must pass before sending another sms otp.
max_frequency = "5s"

# Use pre-defined map of phone number to OTP for testing.
# [auth.sms.test_otp]
# 4152127777 = "123456"

# Configure logged in session timeouts.
# [auth.sessions]
# Force log out after the specified duration.
# timebox = "24h"
# Force log out if the user has been inactive longer than the specified duration.
# inactivity_timeout = "8h"

# This hook runs before a new user is created and allows developers to reject the request based on the incoming user object.
# [auth.hook.before_user_created]
# enabled = true
# uri = "pg-functions://postgres/auth/before-user-created-hook"

# This hook runs before a token is issued and allows you to add additional claims based on the authentication method used.
# [auth.hook.custom_access_token]
# enabled = true
# uri = "pg-functions://<database>/<schema>/<hook_name>"

# Configure one of the supported SMS providers: `twilio`, `twilio_verify`, `messagebird`, `textlocal`, `vonage`.
[auth.sms.twilio]
enabled = false
account_sid = ""
message_service_sid = ""
# DO NOT commit your Twilio auth token to git. Use environment variable substitution instead:
auth_token = "env(SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN)"

# Multi-factor-authentication is available to Supabase Pro plan.
[auth.mfa]
# Control how many MFA factors can be enrolled at once per user.
max_enrolled_factors = 10

# Control MFA via App Authenticator (TOTP)
[auth.mfa.totp]
enroll_enabled = false
verify_enabled = false

# Configure MFA via Phone Messaging
[auth.mfa.phone]
enroll_enabled = false
verify_enabled = false
otp_length = 6
template = "Your code is {{ .Code }}"
max_frequency = "5s"

# Configure MFA via WebAuthn
# [auth.mfa.web_authn]
# enroll_enabled = true
# verify_enabled = true

# Use an external OAuth provider. The full list of providers are: `apple`, `azure`, `bitbucket`,
# `discord`, `facebook`, `github`, `gitlab`, `google`, `keycloak`, `linkedin_oidc`, `notion`, `twitch`,
# `twitter`, `x`, `slack`, `spotify`, `workos`, `zoom`.
[auth.external.apple]
enabled = false
client_id = ""
# DO NOT commit your OAuth provider secret to git. Use environment variable substitution instead:
secret = "env(SUPABASE_AUTH_EXTERNAL_APPLE_SECRET)"
# Overrides the default auth redirectUrl.
redirect_uri = ""
# Overrides the default auth provider URL. Used to support self-hosted gitlab, single-tenant Azure,
# or any other third-party OIDC providers.
url = ""
# If enabled, the nonce check will be skipped. Required for local sign in with Google auth.
skip_nonce_check = false
# If enabled, it will allow the user to successfully authenticate when the provider does not return an email address.
email_optional = false

# Allow Solana wallet holders to sign in to your project via the Sign in with Solana (SIWS, EIP-4361) standard.
# You can configure "web3" rate limit in the [auth.rate_limit] section and set up [auth.captcha] if self-hosting.
[auth.web3.solana]
enabled = false

# Use Firebase Auth as a third-party provider alongside Supabase Auth.
[auth.third_party.firebase]
enabled = false
# project_id = "my-firebase-project"

# Use Auth0 as a third-party provider alongside Supabase Auth.
[auth.third_party.auth0]
enabled = false
# tenant = "my-auth0-tenant"
# tenant_region = "us"

# Use AWS Cognito (Amplify) as a third-party provider alongside Supabase Auth.
[auth.third_party.aws_cognito]
enabled = false
# user_pool_id = "my-user-pool-id"
# user_pool_region = "us-east-1"

# Use Clerk as a third-party provider alongside Supabase Auth.
[auth.third_party.clerk]
enabled = false
# Obtain from https://clerk.com/setup/supabase
# domain = "example.clerk.accounts.dev"

# OAuth server configuration
[auth.oauth_server]
# Enable OAuth server functionality
enabled = false
# Path for OAuth consent flow UI
authorization_url_path = "/oauth/consent"
# Allow dynamic client registration
allow_dynamic_registration = false

[edge_runtime]
enabled = true
# Supported request policies: `oneshot`, `per_worker`.
# `per_worker` (default) ‚Äî enables hot reload during local development.
# `oneshot` ‚Äî fallback mode if hot reload causes issues (e.g. in large repos or with symlinks).
policy = "per_worker"
# Port to attach the Chrome inspector for debugging edge functions.
inspector_port = 8083
# The Deno major version to use.
deno_version = 2

# [edge_runtime.secrets]
# secret_key = "env(SECRET_VALUE)"

[analytics]
enabled = true
port = 54327
# Configure one of the supported backends: `postgres`, `bigquery`.
backend = "postgres"

# Experimental features may be deprecated any time
[experimental]
# Configures Postgres storage engine to use OrioleDB (S3)
orioledb_version = ""
# Configures S3 bucket URL, eg. <bucket_name>.s3-<region>.amazonaws.com
s3_host = "env(S3_HOST)"
# Configures S3 bucket region, eg. us-east-1
s3_region = "env(S3_REGION)"
# Configures AWS_ACCESS_KEY_ID for S3 bucket
s3_access_key = "env(S3_ACCESS_KEY)"
# Configures AWS_SECRET_ACCESS_KEY for S3 bucket
s3_secret_key = "env(S3_SECRET_KEY)"

[functions.create-user]
enabled = true
verify_jwt = true
import_map = "./functions/create-user/deno.json"
# Uncomment to specify a custom file path to the entrypoint.
# Supported file extensions are: .ts, .js, .mjs, .jsx, .tsx
entrypoint = "./functions/create-user/index.ts"
# Specifies static files to be bundled with the function. Supports glob patterns.
# For example, if you want to serve static HTML pages in your function:
# static_files = [ "./functions/create-user/*.html" ]

[functions.reset-password]
enabled = true
verify_jwt = true
import_map = "./functions/reset-password/deno.json"
# Uncomment to specify a custom file path to the entrypoint.
# Supported file extensions are: .ts, .js, .mjs, .jsx, .tsx
entrypoint = "./functions/reset-password/index.ts"
# Specifies static files to be bundled with the function. Supports glob patterns.
# For example, if you want to serve static HTML pages in your function:
# static_files = [ "./functions/reset-password/*.html" ]

[functions.delete-user]
enabled = true
verify_jwt = true
import_map = "./functions/delete-user/deno.json"
entrypoint = "./functions/delete-user/index.ts"

[functions.update-user]
enabled = true
verify_jwt = true
import_map = "./functions/update-user/deno.json"
entrypoint = "./functions/update-user/index.ts"

[functions.delete-user]
verify_jwt = true

[functions.update-user]
verify_jwt = true

[functions.reset-password]
verify_jwt = true

----------------------------------------------------------------------------------------- 
// supabase\functions\create-user\deno.json
----------------------------------------------------------------------------------------- 
{
  "imports": {}
}


----------------------------------------------------------------------------------------- 
// supabase\functions\create-user\index.ts
----------------------------------------------------------------------------------------- 
// supabase/functions/create-user/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

type CreateUserPayload = {
  role: "student" | "teacher";
  temp_password: string;
  first_names: string;
  last_name_pat?: string;
  last_name_mat?: string;
  phone: string;
  contact_email?: string;
  career_id: number;
  shift: "tarde" | "noche";
  level_id?: number; // solo para student
  likes?: string;
  avatar_key?: string;
};

function json(status: number, data: unknown) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { "Content-Type": "application/json", ...corsHeaders },
  });
}

serve(async (req) => {
  if (req.method === "OPTIONS")
    return new Response("ok", { headers: corsHeaders });

  try {
    if (req.method !== "POST") return json(405, { error: "Use POST" });

    const authHeader = req.headers.get("Authorization") ?? "";
    if (!authHeader.startsWith("Bearer ")) {
      return json(401, { error: "No Authorization Bearer token" });
    }

    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const anonKey = Deno.env.get("SUPABASE_ANON_KEY")!;
    const serviceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;

    // Validar caller con cliente anon
    const sb = createClient(supabaseUrl, anonKey, {
      global: { headers: { Authorization: authHeader } },
    });

    const { data: userData, error: userErr } = await sb.auth.getUser();
    if (userErr || !userData.user)
      return json(401, { error: "Token inv√°lido" });

    const callerId = userData.user.id;

    const { data: callerProfile, error: profErr } = await sb
      .from("profiles")
      .select("role")
      .eq("id", callerId)
      .single();

    if (profErr)
      return json(403, { error: "No se pudo leer perfil del caller" });
    if (!["admin", "teacher"].includes(callerProfile?.role))
      return json(403, { error: "Solo admin o teacher pueden crear usuarios" });

    const payload = (await req.json()) as CreateUserPayload;

    // Validaciones
    if (!payload.role || !["student", "teacher"].includes(payload.role)) {
      return json(400, { error: "role debe ser student o teacher" });
    }

    if (!payload.first_names?.trim()) {
      return json(400, { error: "first_names es requerido" });
    }

    if (!payload.last_name_pat?.trim() && !payload.last_name_mat?.trim()) {
      return json(400, { error: "Al menos un apellido es requerido" });
    }

    if (!payload.phone?.trim()) {
      return json(400, { error: "phone es requerido" });
    }

    if (!payload.career_id) {
      return json(400, { error: "career_id es requerido" });
    }

    if (!payload.shift || !["tarde", "noche"].includes(payload.shift)) {
      return json(400, { error: "shift debe ser tarde o noche" });
    }

    if (payload.role === "student" && !payload.level_id) {
      return json(400, { error: "level_id es requerido para estudiantes" });
    }

    // Obtener prefijo de carrera
    const { data: careerData, error: careerErr } = await sb
      .from("careers")
      .select("student_prefix")
      .eq("id", payload.career_id)
      .single();

    if (careerErr || !careerData)
      return json(400, { error: "career_id inv√°lido" });

    const prefix = careerData.student_prefix;

    // Generar c√≥digo √∫nico
    const { data: codeData, error: codeErr } = await sb.rpc("next_code", {
      p_prefix: prefix,
    });

    if (codeErr) return json(500, { error: "No se pudo generar c√≥digo" });

    const code = codeData as string;
    const email = `${code.toLowerCase()}@cea.local`;

    // Crear full_name
    const parts = [
      payload.first_names?.trim(),
      payload.last_name_pat?.trim(),
      payload.last_name_mat?.trim(),
    ].filter(Boolean);
    const full_name = parts.join(" ");

    // Cliente admin para crear usuario
    const admin = createClient(supabaseUrl, serviceKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    });

    const { data: authData, error: authErr } =
      await admin.auth.admin.createUser({
        email,
        password: payload.temp_password,
        email_confirm: true,
        user_metadata: {
          full_name,
        },
      });

    if (authErr) return json(400, { error: authErr.message });
    if (!authData.user) return json(500, { error: "No se cre√≥ el usuario" });

    const userId = authData.user.id;

    // ‚úÖ CR√çTICO: Actualizar profile con TODOS los campos
    const { error: updateErr } = await admin
      .from("profiles")
      .update({
        role: payload.role,
        code,
        full_name,
        first_names: payload.first_names.trim(),
        last_name_pat: payload.last_name_pat?.trim() || null,
        last_name_mat: payload.last_name_mat?.trim() || null,
        phone: payload.phone.trim(),
        contact_email: payload.contact_email?.trim() || null,
        career_id: payload.career_id, // ‚úÖ IMPORTANTE
        shift: payload.shift, // ‚úÖ IMPORTANTE
        likes: payload.likes?.trim() || null,
        avatar_key: payload.avatar_key || "av1",
      })
      .eq("id", userId);

    if (updateErr) {
      // Rollback: eliminar usuario de auth
      await admin.auth.admin.deleteUser(userId);
      return json(500, { error: "No se pudo actualizar profile" });
    }

    // Si es estudiante, crear enrollment
    if (payload.role === "student" && payload.level_id) {
      const { error: enrollErr } = await admin.from("enrollments").insert({
        student_id: userId,
        level_id: payload.level_id,
      });

      if (enrollErr) {
        console.error("Error enrollment:", enrollErr);
        // No hacemos rollback total, solo advertimos
      }
    }

    return json(200, {
      ok: true,
      user_id: userId,
      email,
      code,
      temp_password: payload.temp_password,
    });
  } catch (e) {
    console.error("Error:", e);
    return json(500, { error: String(e) });
  }
});


----------------------------------------------------------------------------------------- 
// supabase\functions\delete-user\deno.json
----------------------------------------------------------------------------------------- 
{
  "imports": {}
}


----------------------------------------------------------------------------------------- 
// supabase\functions\delete-user\index.ts
----------------------------------------------------------------------------------------- 
// supabase/functions/delete-user/index.ts

import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";
import { corsHeaders } from "../_shared/cors.ts";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;

Deno.serve(async (req) => {
  // Handle CORS preflight
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    // Verificar autenticaci√≥n
    const authHeader = req.headers.get("Authorization");
    if (!authHeader) {
      return new Response(
        JSON.stringify({ error: "No authorization header" }),
        {
          status: 401,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    // Cliente con token del usuario
    const anonClient = createClient(
      SUPABASE_URL,
      Deno.env.get("SUPABASE_ANON_KEY")!,
      {
        global: { headers: { Authorization: authHeader } },
      }
    );

    // Verificar sesi√≥n
    const {
      data: { user },
      error: userError,
    } = await anonClient.auth.getUser();
    if (userError || !user) {
      return new Response(JSON.stringify({ error: "Invalid session" }), {
        status: 401,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Verificar que sea admin
    const { data: profile } = await anonClient
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .single();

    if (profile?.role !== "admin") {
      return new Response(
        JSON.stringify({ error: "Only admin can delete users" }),
        {
          status: 403,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    // Leer body
    const { user_id } = await req.json();

    if (!user_id) {
      return new Response(JSON.stringify({ error: "user_id is required" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // No permitir auto-eliminaci√≥n
    if (user_id === user.id) {
      return new Response(JSON.stringify({ error: "Cannot delete yourself" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Cliente admin
    const adminClient = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    });

    // Verificar que el usuario a eliminar no es admin
    const { data: targetProfile } = await adminClient
      .from("profiles")
      .select("role, code")
      .eq("id", user_id)
      .single();

    if (targetProfile?.role === "admin") {
      return new Response(
        JSON.stringify({ error: "Cannot delete admin users" }),
        {
          status: 403,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    // Eliminar en cascada usando service role
    // 1. Eliminar enrollments
    await adminClient.from("enrollments").delete().eq("student_id", user_id);

    // 2. Eliminar module_grades
    await adminClient.from("module_grades").delete().eq("student_id", user_id);

    // 3. Eliminar student_section_progress
    await adminClient
      .from("student_section_progress")
      .delete()
      .eq("student_id", user_id);

    // 4. Eliminar lesson_progress
    await adminClient
      .from("lesson_progress")
      .delete()
      .eq("student_id", user_id);

    // 5. Eliminar profile
    await adminClient.from("profiles").delete().eq("id", user_id);

    // 6. Eliminar de auth.users
    const { error: deleteAuthError } = await adminClient.auth.admin.deleteUser(
      user_id
    );
    if (deleteAuthError) {
      console.error("Error deleting auth user:", deleteAuthError);
      // No fallar si solo falla auth, ya eliminamos el profile
    }

    return new Response(
      JSON.stringify({
        ok: true,
        code: targetProfile?.code,
        message: "User deleted successfully",
      }),
      {
        status: 200,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );
  } catch (error) {
    console.error("Error in delete-user:", error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});


----------------------------------------------------------------------------------------- 
// supabase\functions\reset-password\deno.json
----------------------------------------------------------------------------------------- 
{
  "imports": {}
}


----------------------------------------------------------------------------------------- 
// supabase\functions\reset-password\index.ts
----------------------------------------------------------------------------------------- 
// supabase/functions/reset-password/index.ts

import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";
import { corsHeaders } from "../_shared/cors.ts";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;

Deno.serve(async (req) => {
  // Handle CORS preflight
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    // Verificar autenticaci√≥n
    const authHeader = req.headers.get("Authorization");
    if (!authHeader) {
      return new Response(
        JSON.stringify({ error: "No authorization header" }),
        {
          status: 401,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    // Cliente con token del usuario
    const anonClient = createClient(
      SUPABASE_URL,
      Deno.env.get("SUPABASE_ANON_KEY")!,
      {
        global: { headers: { Authorization: authHeader } },
      }
    );

    // Verificar sesi√≥n
    const {
      data: { user },
      error: userError,
    } = await anonClient.auth.getUser();
    if (userError || !user) {
      return new Response(JSON.stringify({ error: "Invalid session" }), {
        status: 401,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Verificar que sea admin
    const { data: profile } = await anonClient
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .single();

    if (profile?.role !== "admin") {
      return new Response(
        JSON.stringify({ error: "Only admin can reset passwords" }),
        {
          status: 403,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    // Leer body
    const { user_id, new_password } = await req.json();

    if (!user_id || !new_password) {
      return new Response(
        JSON.stringify({ error: "user_id and new_password are required" }),
        {
          status: 400,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    // Cliente admin para actualizar contrase√±a
    const adminClient = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    });

    // Actualizar contrase√±a
    const { error: updateError } = await adminClient.auth.admin.updateUserById(
      user_id,
      { password: new_password }
    );

    if (updateError) {
      throw updateError;
    }

    return new Response(
      JSON.stringify({
        ok: true,
        message: "Password updated successfully",
      }),
      {
        status: 200,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );
  } catch (error) {
    console.error("Error in reset-password:", error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});


----------------------------------------------------------------------------------------- 
// supabase\functions\update-user\deno.json
----------------------------------------------------------------------------------------- 
{
  "imports": {}
}


----------------------------------------------------------------------------------------- 
// supabase\functions\update-user\index.ts
----------------------------------------------------------------------------------------- 
// supabase/functions/delete-user/index.ts

import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";
import { corsHeaders } from "../_shared/cors.ts";

const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;

Deno.serve(async (req) => {
  // Handle CORS preflight
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    // Verificar autenticaci√≥n
    const authHeader = req.headers.get("Authorization");
    if (!authHeader) {
      return new Response(
        JSON.stringify({ error: "No authorization header" }),
        {
          status: 401,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    // Cliente con token del usuario
    const anonClient = createClient(
      SUPABASE_URL,
      Deno.env.get("SUPABASE_ANON_KEY")!,
      {
        global: { headers: { Authorization: authHeader } },
      }
    );

    // Verificar sesi√≥n
    const {
      data: { user },
      error: userError,
    } = await anonClient.auth.getUser();
    if (userError || !user) {
      return new Response(JSON.stringify({ error: "Invalid session" }), {
        status: 401,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Verificar que sea admin
    const { data: profile } = await anonClient
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .single();

    if (profile?.role !== "admin") {
      return new Response(
        JSON.stringify({ error: "Only admin can delete users" }),
        {
          status: 403,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    // Leer body
    const { user_id } = await req.json();

    if (!user_id) {
      return new Response(JSON.stringify({ error: "user_id is required" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // No permitir auto-eliminaci√≥n
    if (user_id === user.id) {
      return new Response(JSON.stringify({ error: "Cannot delete yourself" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Cliente admin
    const adminClient = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    });

    // Verificar que el usuario a eliminar no es admin
    const { data: targetProfile } = await adminClient
      .from("profiles")
      .select("role, code")
      .eq("id", user_id)
      .single();

    if (targetProfile?.role === "admin") {
      return new Response(
        JSON.stringify({ error: "Cannot delete admin users" }),
        {
          status: 403,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    // Eliminar en cascada usando service role
    // 1. Eliminar enrollments
    await adminClient.from("enrollments").delete().eq("student_id", user_id);

    // 2. Eliminar module_grades
    await adminClient.from("module_grades").delete().eq("student_id", user_id);

    // 3. Eliminar student_section_progress
    await adminClient
      .from("student_section_progress")
      .delete()
      .eq("student_id", user_id);

    // 4. Eliminar lesson_progress
    await adminClient
      .from("lesson_progress")
      .delete()
      .eq("student_id", user_id);

    // 5. Eliminar profile
    await adminClient.from("profiles").delete().eq("id", user_id);

    // 6. Eliminar de auth.users
    const { error: deleteAuthError } = await adminClient.auth.admin.deleteUser(
      user_id
    );
    if (deleteAuthError) {
      console.error("Error deleting auth user:", deleteAuthError);
      // No fallar si solo falla auth, ya eliminamos el profile
    }

    return new Response(
      JSON.stringify({
        ok: true,
        code: targetProfile?.code,
        message: "User deleted successfully",
      }),
      {
        status: 200,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );
  } catch (error) {
    console.error("Error in delete-user:", error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});


----------------------------------------------------------------------------------------- 
// supabase\functions\_shared\cors.ts
----------------------------------------------------------------------------------------- 
// supabase/functions/_shared/cors.ts

export const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS, PUT, DELETE",
};


============================================================
FIN.
============================================================
